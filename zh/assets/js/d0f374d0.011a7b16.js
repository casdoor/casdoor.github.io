"use strict";(self.webpackChunkcasdoor_website=self.webpackChunkcasdoor_website||[]).push([[5011],{3214:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>d,frontMatter:()=>r,metadata:()=>i,toc:()=>p});var a=n(7462),o=(n(7294),n(3905));n(1839);const r={title:"OAuth 2.0",description:"\u4f7f\u7528AccessToken\u9a8c\u8bc1\u5ba2\u6237\u7aef",keywords:["OAuth2.0","accessToken","\u66f4\u65b0\u8bbf\u95ee\u4ee4\u724c"]},s=void 0,i={unversionedId:"how-to-connect/oauth",id:"how-to-connect/oauth",title:"OAuth 2.0",description:"\u4f7f\u7528AccessToken\u9a8c\u8bc1\u5ba2\u6237\u7aef",source:"@site/i18n/zh/docusaurus-plugin-content-docs/current/how-to-connect/oauth.md",sourceDirName:"how-to-connect",slug:"/how-to-connect/oauth",permalink:"/zh/docs/how-to-connect/oauth",draft:!1,editUrl:"https://crowdin.com/project/casdoor-website/zh-CN",tags:[],version:"current",frontMatter:{title:"OAuth 2.0",description:"\u4f7f\u7528AccessToken\u9a8c\u8bc1\u5ba2\u6237\u7aef",keywords:["OAuth2.0","accessToken","\u66f4\u65b0\u8bbf\u95ee\u4ee4\u724c"]},sidebar:"tutorialSidebar",previous:{title:"Casdoor\u63d2\u4ef6",permalink:"/zh/docs/how-to-connect/plugin"},next:{title:"CAS",permalink:"/zh/docs/how-to-connect/cas"}},l={},p=[{value:"\u4ecb\u7ecd",id:"\u4ecb\u7ecd",level:2},{value:"\u5982\u4f55\u83b7\u53d6AcessToken",id:"\u5982\u4f55\u83b7\u53d6acesstoken",level:2},{value:'Authorization Code Grant <span id="1"></span>',id:"authorization-code-grant-",level:3},{value:"Available scopes",id:"available-scopes",level:4},{value:"Implicit Grant",id:"implicit-grant",level:3},{value:"Resource Owner Password Credentials Grant",id:"resource-owner-password-credentials-grant",level:3},{value:"Client Credentials Grant",id:"client-credentials-grant",level:3},{value:"\u66f4\u65b0\u8bbf\u95ee\u4ee4\u724c",id:"\u66f4\u65b0\u8bbf\u95ee\u4ee4\u724c",level:3},{value:"\u5982\u4f55\u9a8c\u8bc1\u8bbf\u95ee\u4ee4\u724c",id:"\u5982\u4f55\u9a8c\u8bc1\u8bbf\u95ee\u4ee4\u724c",level:2},{value:"\u5982\u4f55\u4f7f\u7528\u8bbf\u95ee\u4ee4\u724c",id:"\u5982\u4f55\u4f7f\u7528\u8bbf\u95ee\u4ee4\u724c",level:2},{value:"<code>userinfo</code> \u548c <code>get-account</code> API \u4e4b\u95f4\u7684\u5dee\u5f02",id:"userinfo-\u548c-get-account-api-\u4e4b\u95f4\u7684\u5dee\u5f02",level:2}],c={toc:p};function d(e){let{components:t,...r}=e;return(0,o.kt)("wrapper",(0,a.Z)({},c,r,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h2",{id:"\u4ecb\u7ecd"},"\u4ecb\u7ecd"),(0,o.kt)("p",null,"Casdoor \u652f\u6301AccessToken\u9a8c\u8bc1\u5ba2\u6237\u7aef\u3002 \u5728\u672c\u8282\u4e2d\uff0c\u6211\u4eec\u5c06\u5411\u60a8\u5c55\u793a\u5982\u4f55\u83b7\u53d6AccessToken\uff0c\u5982\u4f55\u9a8c\u8bc1AccessToken\uff0c\u4ee5\u53ca\u5982\u4f55\u4f7f\u7528AccessToken\u3002"),(0,o.kt)("h2",{id:"\u5982\u4f55\u83b7\u53d6acesstoken"},"\u5982\u4f55\u83b7\u53d6AcessToken"),(0,o.kt)("p",null,"\u60a8\u6709\u4e24\u79cd\u65b9\u6cd5\u83b7\u5f97AccessToken\uff1a\u60a8\u53ef\u4ee5\u4f7f\u7528 ",(0,o.kt)("a",{parentName:"p",href:"/docs/how-to-connect/sdk"},"Cassdoor SDK"),"\uff0c \u6b32\u4e86\u89e3\u8be6\u60c5\uff0c\u8bf7\u53c2\u9605SDK\u6587\u6863\uff0c\u5728\u6b64\u6211\u4eec\u5c06\u4e3b\u8981\u5411\u60a8\u5c55\u793a\u5982\u4f55\u4f7f\u7528 API \u83b7\u53d6AccessToken\u3002"),(0,o.kt)("p",null,"Casdoor\u652f\u6301\u56db\u79cdOAuth \u6388\u4e88\u7c7b\u578b: ",(0,o.kt)("a",{parentName:"p",href:"https://datatracker.ietf.org/doc/html/rfc6749#section-4.1"},"Authorization Code Grant"),", ",(0,o.kt)("a",{parentName:"p",href:"https://datatracker.ietf.org/doc/html/rfc6749#section-4.2"},"Implicit Grant"),", ",(0,o.kt)("a",{parentName:"p",href:"https://datatracker.ietf.org/doc/html/rfc6749#section-4.3"},"Resource Owner Password Credentials Grant"),", \u548c ",(0,o.kt)("a",{parentName:"p",href:"https://datatracker.ietf.org/doc/html/rfc6749#section-4.4"},"Client Credentials Grant"),"."),(0,o.kt)("p",null,"\u51fa\u4e8e\u5b89\u5168\u8003\u8651\uff0cCasdoor\u5e94\u7528\u9ed8\u8ba4\u5df2\u5f00\u542f\u6388\u6743\u7801\u6a21\u5f0f\uff0c \u5982\u679c\u60a8\u9700\u8981\u4f7f\u7528\u5176\u4ed6\u6a21\u5f0f\uff0c\u8bf7\u8f6c\u5230\u9002\u5f53\u7684\u5e94\u7528\u7a0b\u5e8f\u6765\u8bbe\u7f6e\u5b83\u3002"),(0,o.kt)("p",null,(0,o.kt)("img",{alt:"OAuth\u6388\u6743\u7c7b\u578b",src:n(4552).Z,width:"1493",height:"529"})),(0,o.kt)("h3",{id:"authorization-code-grant-"},"Authorization Code Grant ",(0,o.kt)("span",{id:"1"})),(0,o.kt)("p",null,"First redirect your users to:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"https://<CASDOOR_HOST>/login/oauth/authorize?\nclient_id=CLIENT_ID&\nredirect_uri=REDIRECT_URI&\nresponse_type=code&\nscope=openid&\nstate=STATE\n")),(0,o.kt)("h4",{id:"available-scopes"},"Available scopes"),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:null},"Name"),(0,o.kt)("th",{parentName:"tr",align:null},"Description"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"openid (no scope)"),(0,o.kt)("td",{parentName:"tr",align:null},"sub (user's id), iss (issuer) and aud (audience)")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"profile"),(0,o.kt)("td",{parentName:"tr",align:null},"user profile info, include name, displayName, avatar")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"email"),(0,o.kt)("td",{parentName:"tr",align:null},"user's email address")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"address"),(0,o.kt)("td",{parentName:"tr",align:null},"user's address")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:null},"phone"),(0,o.kt)("td",{parentName:"tr",align:null},"user's phone number")))),(0,o.kt)("admonition",{type:"info"},(0,o.kt)("p",{parentName:"admonition"},"Your OAuth Application can request the scopes in the initial redirection. You can specify multiple scopes by separating them with a space using %20:"),(0,o.kt)("pre",{parentName:"admonition"},(0,o.kt)("code",{parentName:"pre",className:"language-text"},"https://<CASDOOR_HOST>/login/oauth/authorize?\nclient_id=...&\nscope=openid%20email\n")),(0,o.kt)("p",{parentName:"admonition"},"For more details, please see ",(0,o.kt)("a",{parentName:"p",href:"https://openid.net/specs/openid-connect-core-1_0.html#UserInfoResponse"},"OIDC standard"))),(0,o.kt)("p",null,"After your user has authenticated with casdoor, casdoor will redirect him to:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"https://REDIRECT_URI?code=CODE&state=STATE\n")),(0,o.kt)("p",null,"Now that you have obtained the authorization code, make a POST request to:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"https://<CASDOOR_HOST>/api/login/oauth/access_token\n")),(0,o.kt)("p",null,"in your backend application:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "grant_type": "authorization_code",\n    "client_id": ClientId,\n    "client_secret": ClientSecret,\n    "code": Code,\n}\n')),(0,o.kt)("p",null,"You will get the following response:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "access_token": "eyJhb...",\n    "id_token": "eyJhb...",\n    "refresh_token": "eyJhb...",\n    "token_type": "Bearer",\n    "expires_in": 10080,\n    "scope": "openid"\n}\n')),(0,o.kt)("admonition",{type:"note"},(0,o.kt)("p",{parentName:"admonition"},"Casdoor also supports ",(0,o.kt)("a",{parentName:"p",href:"https://datatracker.ietf.org/doc/html/rfc7636"},"PKCE")," feature, when getting the authorization code, you can add two parameters to enable PKCE:"),(0,o.kt)("pre",{parentName:"admonition"},(0,o.kt)("code",{parentName:"pre"},"&code_challenge_method=S256&code_challenge=YOUR_CHANLLENGE\n")),(0,o.kt)("p",{parentName:"admonition"},"When getting the token you need to pass ",(0,o.kt)("inlineCode",{parentName:"p"},"code_verifier")," parameter to verify PKCE. It is worth mentioning that with PKCE enabled, Client_Secret is not required, but if you pass it, it must be the correct value.")),(0,o.kt)("h3",{id:"implicit-grant"},"Implicit Grant"),(0,o.kt)("p",null,"Maybe your application doesn't have a backend, and you need to use Implicit Grant. First you need to make sure you have Implicit Grant enabled, then redirect your users to:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"https://<CASDOOR_HOST>/login/oauth/authorize?client_id=CLIENT_ID&redirect_uri=REDIRECT_URI&response_type=token&scope=openid&state=STATE\n")),(0,o.kt)("p",null,"After your user has authenticated with casdoor, casdoor will redirect him to:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"https://REDIRECT_URI/#token=ACCESS_TOKEN\n")),(0,o.kt)("p",null,"Casdoor also supports ",(0,o.kt)("a",{parentName:"p",href:"https://openid.net/specs/oauth-v2-multiple-response-types-1_0.html#id_token"},"id_token")," as ",(0,o.kt)("inlineCode",{parentName:"p"},"response_type"),", which is a feature of OpenID."),(0,o.kt)("h3",{id:"resource-owner-password-credentials-grant"},"Resource Owner Password Credentials Grant"),(0,o.kt)("p",null,"If your application doesn't have a frontend that redirects users to Casdoor, then you may need this."),(0,o.kt)("p",null,"First you need to make sure you have Password Credentials Grant enabled, and send a POST request to:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"https://<CASDOOR_HOST>/api/login/oauth/access_token\n")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "grant_type": "password",\n    "client_id": ClientId,\n    "client_secret": ClientSecret,\n    "username": Username,\n    "password": Password,\n}\n')),(0,o.kt)("p",null,"You will get the following response:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "access_token": "eyJhb...",\n    "id_token": "eyJhb...",\n    "refresh_token": "eyJhb...",\n    "token_type": "Bearer",\n    "expires_in": 10080,\n    "scope": "openid"\n}\n')),(0,o.kt)("h3",{id:"client-credentials-grant"},"Client Credentials Grant"),(0,o.kt)("p",null,"You can also use Client Credentials Grant when your application does not have a frontend."),(0,o.kt)("p",null,"First you need to make sure you have Client Credentials Grant enabled, and send a POST request to ",(0,o.kt)("inlineCode",{parentName:"p"},"https://<CASDOOR_HOST>/api/login/oauth/access_token"),":"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "grant_type": "client_credentials",\n    "client_id": ClientId,\n    "client_secret": ClientSecret,\n}\n')),(0,o.kt)("p",null,"You will get the following response:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "access_token": "eyJhb...",\n    "id_token": "eyJhb...",\n    "refresh_token": "eyJhb...",\n    "token_type": "Bearer",\n    "expires_in": 10080,\n    "scope": "openid"\n}\n')),(0,o.kt)("p",null,"It is important to note that the AccessToken obtained in this way differs from the first three in that it corresponds to the application rather than to the user."),(0,o.kt)("h3",{id:"\u66f4\u65b0\u8bbf\u95ee\u4ee4\u724c"},"\u66f4\u65b0\u8bbf\u95ee\u4ee4\u724c"),(0,o.kt)("p",null,"Maybe you want to update your accessToken, then you can use the ",(0,o.kt)("inlineCode",{parentName:"p"},"refreshToken")," you got above."),(0,o.kt)("p",null,"First you need to set the expiration time of refreshToken in the application (default is 0 hours), and send a POST request to ",(0,o.kt)("inlineCode",{parentName:"p"},"https://<CASDOOR_HOST>/api/login/oauth/refresh_token")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "grant_type": "refresh_token",\n    "refresh_token": REFRESH_TOKEN,\n    "scope": SCOPE,\n    "client_id": ClientId,\n    "client_secret": ClientSecret,\n}\n')),(0,o.kt)("p",null,"You will get the response like:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "access_token": "eyJhb...",\n    "id_token": "eyJhb...",\n    "refresh_token": "eyJhb...",\n    "token_type": "Bearer",\n    "expires_in": 10080,\n    "scope": "openid"\n}\n')),(0,o.kt)("h2",{id:"\u5982\u4f55\u9a8c\u8bc1\u8bbf\u95ee\u4ee4\u724c"},"\u5982\u4f55\u9a8c\u8bc1\u8bbf\u95ee\u4ee4\u724c"),(0,o.kt)("p",null,"Casdoor currently has support for ",(0,o.kt)("a",{parentName:"p",href:"https://datatracker.ietf.org/doc/html/rfc7662"},"token introspection")," endpoint. Currently the endpoind is protected by Basic Authoritarian(ClientId:ClientSecret):"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre"},"POST /api/login/oauth/introspect HTTP/1.1\nHost: CASDOOR_HOST\nAccept: application/json\nContent-Type: application/x-www-form-urlencoded\nAuthorization: Basic Y2xpZW50X2lkOmNsaWVudF9zZWNyZXQ=\n\ntoken=ACCESS_TOKEN&token_type_hint=access_token\n")),(0,o.kt)("p",null,"You will get the following response like:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "active": true,\n    "client_id": "c58c...",\n    "username": "admin",\n    "token_type": "Bearer",\n    "exp": 1647138242,\n    "iat": 1646533442,\n    "nbf": 1646533442,\n    "sub": "7a6b4a8a-b731-48da-bc44-36ae27338817",\n    "aud": [\n        "c58c..."\n    ],\n    "iss": "http://localhost:8000"\n}\n')),(0,o.kt)("h2",{id:"\u5982\u4f55\u4f7f\u7528\u8bbf\u95ee\u4ee4\u724c"},"\u5982\u4f55\u4f7f\u7528\u8bbf\u95ee\u4ee4\u724c"),(0,o.kt)("p",null,"You can use AccessToken to access Casdoor APIs that require authentication."),(0,o.kt)("p",null,"For example, two different ways to request ",(0,o.kt)("inlineCode",{parentName:"p"},"/api/userinfo"),"."),(0,o.kt)("p",null,"Type 1. Query parameter"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"https://<CASDOOR_HOST>/api/userinfo?accessToken=<your_access_token>")),(0,o.kt)("p",null,"Type 2. HTTP Bearer token"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"https://<CASDOOR_HOST>/api/userinfo"),' with the header: "Authorization: Bearer <your_access_token>"'),(0,o.kt)("p",null,"Casdoor will parse the access_token, returning corresponding user information according to the ",(0,o.kt)("inlineCode",{parentName:"p"},"scope"),". You will get the same response like:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "sub": "7a6b4a8a-b731-48da-bc44-36ae27338817",\n    "iss": "http://localhost:8000",\n    "aud": "c58c..."\n}\n')),(0,o.kt)("p",null,"If you expect more user's information,  adding ",(0,o.kt)("inlineCode",{parentName:"p"},"scope")," when getting AccessToken in step ",(0,o.kt)("a",{parentName:"p",href:"#1"},"Authorization Code Grant"),"."),(0,o.kt)("h2",{id:"userinfo-\u548c-get-account-api-\u4e4b\u95f4\u7684\u5dee\u5f02"},(0,o.kt)("inlineCode",{parentName:"h2"},"userinfo")," \u548c ",(0,o.kt)("inlineCode",{parentName:"h2"},"get-account")," API \u4e4b\u95f4\u7684\u5dee\u5f02"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"p"},"/api/userinfo"),": returns user information as part of OIDC protocol. Less information is returned, including only the basic information in OIDC standards. Please see ",(0,o.kt)("a",{parentName:"p",href:"#available-scopes"},"available scopes")," that Casdoor supports.")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},(0,o.kt)("inlineCode",{parentName:"p"},"/api/get-account"),": gets the user object for the currently logged-in account. It is a Casdoor-only API to obtain all information of the ",(0,o.kt)("a",{parentName:"p",href:"/docs/basic/core-concepts#user"},"user")," in Casdoor."))))}d.isMDXComponent=!0},4552:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/accesstoken_grant_types-a3a06e2f0f56b34ddf752837c834771e.png"}}]);