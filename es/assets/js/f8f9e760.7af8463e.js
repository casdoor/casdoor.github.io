"use strict";(self.webpackChunkcasdoor_website=self.webpackChunkcasdoor_website||[]).push([[7157],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>m});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var c=a.createContext({}),l=function(e){var t=a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=l(e.components);return a.createElement(c.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,c=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=l(n),m=r,k=u["".concat(c,".").concat(m)]||u[m]||d[m]||o;return n?a.createElement(k,i(i({ref:t},p),{},{components:n})):a.createElement(k,i({ref:t},p))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=u;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var l=2;l<o;l++)i[l]=n[l];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},57179:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>s,toc:()=>l});var a=n(87462),r=(n(67294),n(3905));const o={title:"OAuth 2.0",description:"Usando Access Token para autenticar clientes",keywords:["OAuth 2.0","access token","refresh token"],authors:["nomeguy"]},i=void 0,s={unversionedId:"how-to-connect/oauth",id:"how-to-connect/oauth",title:"OAuth 2.0",description:"Usando Access Token para autenticar clientes",source:"@site/i18n/es/docusaurus-plugin-content-docs/current/how-to-connect/oauth.md",sourceDirName:"how-to-connect",slug:"/how-to-connect/oauth",permalink:"/es/docs/how-to-connect/oauth",draft:!1,editUrl:"https://github.com/casdoor/casdoor-website/edit/master/docs/how-to-connect/oauth.md",tags:[],version:"current",frontMatter:{title:"OAuth 2.0",description:"Usando Access Token para autenticar clientes",keywords:["OAuth 2.0","access token","refresh token"],authors:["nomeguy"]},sidebar:"tutorialSidebar",previous:{title:"Nuxt",permalink:"/es/docs/how-to-connect/nuxt"},next:{title:"Usando Casdoor como un Servidor CAS",permalink:"/es/docs/how-to-connect/cas"}},c={},l=[{value:"Introducci\xf3n",id:"introducci\xf3n",level:2},{value:"C\xf3mo obtener un Access Token",id:"c\xf3mo-obtener-un-access-token",level:2},{value:'Authorization Code Grant<span id="1"></span>',id:"authorization-code-grant",level:3},{value:"\xc1mbitos disponibles",id:"\xe1mbitos-disponibles",level:4},{value:"Implicit Grant",id:"implicit-grant",level:3},{value:"Device Grant",id:"device-grant",level:3},{value:"Resource Owner Password Credentials Grant",id:"resource-owner-password-credentials-grant",level:3},{value:"Client Credentials Grant",id:"client-credentials-grant",level:3},{value:"Refresh Token",id:"refresh-token",level:3},{value:"C\xf3mo verificar Access Token",id:"c\xf3mo-verificar-access-token",level:2},{value:"C\xf3mo usar <code>AccessToken</code>",id:"c\xf3mo-usar-accesstoken",level:2},{value:"Diferencias entre las APIs <code>userinfo</code> y <code>get-account</code>",id:"diferencias-entre-las-apis-userinfo-y-get-account",level:2}],p={toc:l};function d(e){let{components:t,...o}=e;return(0,r.kt)("wrapper",(0,a.Z)({},p,o,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"introducci\xf3n"},"Introducci\xf3n"),(0,r.kt)("p",null,"Casdoor soporta el uso de Access Token para autenticar clientes. En esta secci\xf3n, te mostraremos c\xf3mo obtener un Access Token, c\xf3mo verificar un Access Token y c\xf3mo usar un Access Token."),(0,r.kt)("h2",{id:"c\xf3mo-obtener-un-access-token"},"C\xf3mo obtener un Access Token"),(0,r.kt)("p",null,"Hay dos maneras de obtener un Access Token: puedes usar los ",(0,r.kt)("a",{parentName:"p",href:"/docs/how-to-connect/sdk"},"SDKs de Casdoor"),". Para informaci\xf3n detallada, por favor consulta la documentaci\xf3n del SDK. Aqu\xed, principalmente te mostraremos c\xf3mo usar la API para obtener el Access Token."),(0,r.kt)("p",null,"Casdoor soporta cuatro tipos de concesi\xf3n OAuth: ",(0,r.kt)("a",{parentName:"p",href:"https://datatracker.ietf.org/doc/html/rfc6749#section-4.1"},"Authorization Code Grant"),", ",(0,r.kt)("a",{parentName:"p",href:"https://datatracker.ietf.org/doc/html/rfc6749#section-4.2"},"Implicit Grant"),", ",(0,r.kt)("a",{parentName:"p",href:"https://datatracker.ietf.org/doc/html/rfc6749#section-4.3"},"Resource Owner Password Credentials Grant"),", y ",(0,r.kt)("a",{parentName:"p",href:"https://datatracker.ietf.org/doc/html/rfc6749#section-4.4"},"Client Credentials Grant"),"."),(0,r.kt)("p",null,"Por razones de seguridad, la aplicaci\xf3n Casdoor tiene el modo de c\xf3digo de autorizaci\xf3n activado por defecto. Si necesitas usar otros modos, por favor ve a la aplicaci\xf3n apropiada para configurarlo."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Tipos de Concesi\xf3n",src:n(67093).Z,width:"1493",height:"529"})),(0,r.kt)("h3",{id:"authorization-code-grant"},"Authorization Code Grant",(0,r.kt)("span",{id:"1"})),(0,r.kt)("p",null,"Primero, redirige a tus usuarios a:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-url"},"https://<CASDOOR_HOST>/login/oauth/authorize?\nclient_id=CLIENT_ID&\nredirect_uri=REDIRECT_URI&\nresponse_type=code&\nscope=openid&\nstate=STATE\n")),(0,r.kt)("h4",{id:"\xe1mbitos-disponibles"},"\xc1mbitos disponibles"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Nombre"),(0,r.kt)("th",{parentName:"tr",align:null},"Descripci\xf3n"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"openid (no scope)"),(0,r.kt)("td",{parentName:"tr",align:null},"sub (id del usuario), iss (emisor), y aud (audiencia)")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"profile"),(0,r.kt)("td",{parentName:"tr",align:null},"informaci\xf3n del perfil del usuario, incluyendo nombre, displayName y avatar")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"email"),(0,r.kt)("td",{parentName:"tr",align:null},"direcci\xf3n de correo electr\xf3nico del usuario")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"address"),(0,r.kt)("td",{parentName:"tr",align:null},"direcci\xf3n del usuario")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"phone"),(0,r.kt)("td",{parentName:"tr",align:null},"n\xfamero de tel\xe9fono del usuario")))),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("p",{parentName:"admonition"},"Tu Aplicaci\xf3n OAuth puede solicitar los \xe1mbitos en la redirecci\xf3n inicial. Puedes especificar m\xfaltiples \xe1mbitos separ\xe1ndolos con un espacio usando %20:"),(0,r.kt)("pre",{parentName:"admonition"},(0,r.kt)("code",{parentName:"pre",className:"language-text"},"https://<CASDOOR_HOST>/login/oauth/authorize?\nclient_id=...&\nscope=openid%20email\n")),(0,r.kt)("p",{parentName:"admonition"},"Para m\xe1s detalles, por favor consulta el ",(0,r.kt)("a",{parentName:"p",href:"https://openid.net/specs/openid-connect-core-1_0.html#UserInfoResponse"},"est\xe1ndar OIDC"))),(0,r.kt)("p",null,"Despu\xe9s de que tu usuario se haya autenticado con Casdoor, Casdoor los redirigir\xe1 a:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-url"},"https://REDIRECT_URI?code=CODE&state=STATE\n")),(0,r.kt)("p",null,"Ahora que has obtenido el c\xf3digo de autorizaci\xf3n, haz una solicitud POST a:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-url"},"https://<CASDOOR_HOST>/api/login/oauth/access_token\n")),(0,r.kt)("p",null,"en tu aplicaci\xf3n de backend:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "grant_type": "authorization_code",\n    "client_id": ClientId,\n    "client_secret": ClientSecret,\n    "code": Code,\n}\n')),(0,r.kt)("p",null,"Recibir\xe1s la siguiente respuesta:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "access_token": "eyJhb...",\n    "id_token": "eyJhb...",\n    "refresh_token": "eyJhb...",\n    "token_type": "Bearer",\n    "expires_in": 10080,\n    "scope": "openid"\n}\n')),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"Casdoor tambi\xe9n soporta la caracter\xedstica ",(0,r.kt)("a",{parentName:"p",href:"https://datatracker.ietf.org/doc/html/rfc7636"},"PKCE"),". Al obtener el c\xf3digo de autorizaci\xf3n, puedes agregar dos par\xe1metros para habilitar PKCE:"),(0,r.kt)("pre",{parentName:"admonition"},(0,r.kt)("code",{parentName:"pre",className:"language-url"},"&code_challenge_method=S256&code_challenge=TU_DESAF\xcdO\n")),(0,r.kt)("p",{parentName:"admonition"},"Al obtener el token, necesitas pasar el par\xe1metro ",(0,r.kt)("inlineCode",{parentName:"p"},"code_verifier")," para verificar PKCE. Cabe mencionar que con PKCE habilitado, ",(0,r.kt)("inlineCode",{parentName:"p"},"Client_Secret")," no es requerido, pero si lo pasas, debe ser el valor correcto.")),(0,r.kt)("h3",{id:"implicit-grant"},"Implicit Grant"),(0,r.kt)("p",null,"Tal vez tu aplicaci\xf3n no tenga un backend, y necesites usar Implicit Grant. Primero, necesitas asegurarte de tener habilitado Implicit Grant, luego redirige a tus usuarios a:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-url"},"https://<CASDOOR_HOST>/login/oauth/authorize?client_id=CLIENT_ID&redirect_uri=REDIRECT_URI&response_type=token&scope=openid&state=STATE\n")),(0,r.kt)("p",null,"Despu\xe9s de que tu usuario se haya autenticado con Casdoor, Casdoor los redirigir\xe1 a:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-url"},"https://REDIRECT_URI/#access_token=ACCESS_TOKEN\n")),(0,r.kt)("p",null,"Casdoor tambi\xe9n soporta el ",(0,r.kt)("a",{parentName:"p",href:"https://openid.net/specs/oauth-v2-multiple-response-types-1_0.html#id_token"},"id_token")," como ",(0,r.kt)("inlineCode",{parentName:"p"},"response_type"),", que es una caracter\xedstica de OpenID."),(0,r.kt)("h3",{id:"device-grant"},"Device Grant"),(0,r.kt)("p",null,"Maybe your devices have limited input capabilities or lack a suitable browser, and you need to use Device Grant. First, you need to make sure you have Device Grant enabled, the request ",(0,r.kt)("inlineCode",{parentName:"p"},"device_authorization_endpoint")," in OIDC discover, then use QR code or text to show ",(0,r.kt)("inlineCode",{parentName:"p"},"verification_uri")," and lead user to enter login page."),(0,r.kt)("p",null,"Second, you should request ",(0,r.kt)("inlineCode",{parentName:"p"},"token endpoint")," to get Access Token with parameter define in ",(0,r.kt)("a",{parentName:"p",href:"https://datatracker.ietf.org/doc/html/rfc8628#section-3.4"},"rfc8628"),"."),(0,r.kt)("h3",{id:"resource-owner-password-credentials-grant"},"Resource Owner Password Credentials Grant"),(0,r.kt)("p",null,"Si tu aplicaci\xf3n no tiene un frontend que redirija a los usuarios a Casdoor, entonces esto te puede ser necesario."),(0,r.kt)("p",null,"Primero, necesitas asegurarte de tener habilitado Password Credentials Grant y enviar una solicitud POST a:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-url"},"https://<CASDOOR_HOST>/api/login/oauth/access_token\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "grant_type": "password",\n    "client_id": ClientId,\n    "client_secret": ClientSecret,\n    "username": Username,\n    "password": Password,\n}\n')),(0,r.kt)("p",null,"Recibir\xe1s la siguiente respuesta:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "access_token": "eyJhb...",\n    "id_token": "eyJhb...",\n    "refresh_token": "eyJhb...",\n    "token_type": "Bearer",\n    "expires_in": 10080,\n    "scope": "openid"\n}\n')),(0,r.kt)("h3",{id:"client-credentials-grant"},"Client Credentials Grant"),(0,r.kt)("p",null,"Tambi\xe9n puedes usar Client Credentials Grant cuando tu aplicaci\xf3n no tenga un frontend."),(0,r.kt)("p",null,"Primero, necesitas asegurarte de tener habilitado Client Credentials Grant y enviar una solicitud POST a ",(0,r.kt)("inlineCode",{parentName:"p"},"https://<CASDOOR_HOST>/api/login/oauth/access_token"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "grant_type": "client_credentials",\n    "client_id": ClientId,\n    "client_secret": ClientSecret,\n}\n')),(0,r.kt)("p",null,"Recibir\xe1s la siguiente respuesta:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "access_token": "eyJhb...",\n    "id_token": "eyJhb...",\n    "refresh_token": "eyJhb...",\n    "token_type": "Bearer",\n    "expires_in": 10080,\n    "scope": "openid"\n}\n')),(0,r.kt)("p",null,"Es importante notar que el AccessToken obtenido de esta manera difiere de los primeros tres en que corresponde a la aplicaci\xf3n y no al usuario."),(0,r.kt)("h3",{id:"refresh-token"},"Refresh Token"),(0,r.kt)("p",null,"Tal vez quieras actualizar tu Access Token, entonces puedes usar el ",(0,r.kt)("inlineCode",{parentName:"p"},"refreshToken")," que obtuviste arriba."),(0,r.kt)("p",null,"Primero, necesitas configurar el tiempo de expiraci\xf3n del Refresh Token en la aplicaci\xf3n (por defecto es 0 horas), y enviar una solicitud POST a ",(0,r.kt)("inlineCode",{parentName:"p"},"https://<CASDOOR_HOST>/api/login/oauth/refresh_token")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "grant_type": "refresh_token",\n    "refresh_token": REFRESH_TOKEN,\n    "scope": SCOPE,\n    "client_id": ClientId,\n    "client_secret": ClientSecret,\n}\n')),(0,r.kt)("p",null,"Recibir\xe1s una respuesta como esta:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "access_token": "eyJhb...",\n    "id_token": "eyJhb...",\n    "refresh_token": "eyJhb...",\n    "token_type": "Bearer",\n    "expires_in": 10080,\n    "scope": "openid"\n}\n')),(0,r.kt)("h2",{id:"c\xf3mo-verificar-access-token"},"C\xf3mo verificar Access Token"),(0,r.kt)("p",null,"Casdoor actualmente soporta el endpoint de ",(0,r.kt)("a",{parentName:"p",href:"https://datatracker.ietf.org/doc/html/rfc7662"},"introspecci\xf3n de token"),". Este endpoint est\xe1 protegido por Autenticaci\xf3n B\xe1sica (ClientId:ClientSecret)."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-http"},"POST /api/login/oauth/introspect HTTP/1.1\nHost: CASDOOR_HOST\nAccept: application/json\nContent-Type: application/x-www-form-urlencoded\nAuthorization: Basic Y2xpZW50X2lkOmNsaWVudF9zZWNyZXQ=\n\ntoken=ACCESS_TOKEN&token_type_hint=access_token\n")),(0,r.kt)("p",null,"Recibir\xe1s la siguiente respuesta:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "active": true,\n    "client_id": "c58c...",\n    "username": "admin",\n    "token_type": "Bearer",\n    "exp": 1647138242,\n    "iat": 1646533442,\n    "nbf": 1646533442,\n    "sub": "7a6b4a8a-b731-48da-bc44-36ae27338817",\n    "aud": [\n        "c58c..."\n    ],\n    "iss": "http://localhost:8000"\n}\n')),(0,r.kt)("h2",{id:"c\xf3mo-usar-accesstoken"},"C\xf3mo usar ",(0,r.kt)("inlineCode",{parentName:"h2"},"AccessToken")),(0,r.kt)("p",null,"Puedes usar AccessToken para acceder a las APIs de Casdoor que requieren autenticaci\xf3n."),(0,r.kt)("p",null,"Por ejemplo, hay dos maneras diferentes de solicitar ",(0,r.kt)("inlineCode",{parentName:"p"},"/api/userinfo"),"."),(0,r.kt)("p",null,"Tipo 1: Par\xe1metro de consulta"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"https://<CASDOOR_HOST>/api/userinfo?accessToken=<your_access_token>")),(0,r.kt)("p",null,"Tipo 2: Token Bearer HTTP"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"https://<CASDOOR_HOST>/api/userinfo"),' with the header: "Authorization: Bearer <your_access_token>"'),(0,r.kt)("p",null,"Casdoor analizar\xe1 el access_token y devolver\xe1 la informaci\xf3n del usuario correspondiente seg\xfan el ",(0,r.kt)("inlineCode",{parentName:"p"},"scope"),". Recibir\xe1s la misma respuesta, que se ve as\xed:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "sub": "7a6b4a8a-b731-48da-bc44-36ae27338817",\n    "iss": "http://localhost:8000",\n    "aud": "c58c..."\n}\n')),(0,r.kt)("p",null,"Si esperas m\xe1s informaci\xf3n del usuario, a\xf1ade ",(0,r.kt)("inlineCode",{parentName:"p"},"scope")," al obtener el AccessToken en el paso ",(0,r.kt)("a",{parentName:"p",href:"#1"},"Authorization Code Grant"),"."),(0,r.kt)("h2",{id:"diferencias-entre-las-apis-userinfo-y-get-account"},"Diferencias entre las APIs ",(0,r.kt)("inlineCode",{parentName:"h2"},"userinfo")," y ",(0,r.kt)("inlineCode",{parentName:"h2"},"get-account")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"/api/userinfo"),": Esta API devuelve informaci\xf3n del usuario como parte del protocolo OIDC. Proporciona informaci\xf3n limitada, incluyendo solo la informaci\xf3n b\xe1sica definida en los est\xe1ndares OIDC. Para una lista de \xe1mbitos disponibles soportados por Casdoor, por favor consulta la secci\xf3n de ",(0,r.kt)("a",{parentName:"p",href:"#available-scopes"},"\xe1mbitos disponibles"),".")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"/api/get-account"),": Esta API recupera el objeto del usuario para la cuenta actualmente conectada. Es una API espec\xedfica de Casdoor que te permite obtener toda la informaci\xf3n del ",(0,r.kt)("a",{parentName:"p",href:"/docs/basic/core-concepts#user"},"usuario")," en Casdoor."))))}d.isMDXComponent=!0},67093:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/accesstoken_grant_types-a3a06e2f0f56b34ddf752837c834771e.png"}}]);