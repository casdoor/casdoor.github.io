"use strict";(self.webpackChunkcasdoor_website=self.webpackChunkcasdoor_website||[]).push([[2311],{3905:(e,n,t)=>{t.d(n,{Zo:()=>u,kt:()=>g});var i=t(67294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,i)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function d(e,n){if(null==e)return{};var t,i,r=function(e,n){if(null==e)return{};var t,i,r={},a=Object.keys(e);for(i=0;i<a.length;i++)t=a[i],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(i=0;i<a.length;i++)t=a[i],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var o=i.createContext({}),s=function(e){var n=i.useContext(o),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},u=function(e){var n=s(e.components);return i.createElement(o.Provider,{value:n},e.children)},c={inlineCode:"code",wrapper:function(e){var n=e.children;return i.createElement(i.Fragment,{},n)}},p=i.forwardRef((function(e,n){var t=e.components,r=e.mdxType,a=e.originalType,o=e.parentName,u=d(e,["components","mdxType","originalType","parentName"]),p=s(t),g=r,h=p["".concat(o,".").concat(g)]||p[g]||c[g]||a;return t?i.createElement(h,l(l({ref:n},u),{},{components:t})):i.createElement(h,l({ref:n},u))}));function g(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var a=t.length,l=new Array(a);l[0]=p;var d={};for(var o in n)hasOwnProperty.call(n,o)&&(d[o]=n[o]);d.originalType=e,d.mdxType="string"==typeof e?e:r,l[1]=d;for(var s=2;s<a;s++)l[s]=t[s];return i.createElement.apply(null,l)}return i.createElement.apply(null,t)}p.displayName="MDXCreateElement"},8861:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>c,frontMatter:()=>a,metadata:()=>d,toc:()=>s});var i=t(87462),r=(t(67294),t(3905));const a={title:"APISIX",description:"Casdoor in APISIX verwenden",keywords:["APISIX"],authors:["Steve0x2a"]},l=void 0,d={unversionedId:"integration/lua/apisix",id:"integration/lua/apisix",title:"APISIX",description:"Casdoor in APISIX verwenden",source:"@site/i18n/de/docusaurus-plugin-content-docs/current/integration/lua/apisix.md",sourceDirName:"integration/lua",slug:"/integration/lua/apisix",permalink:"/de/docs/integration/lua/apisix",draft:!1,editUrl:"https://github.com/casdoor/casdoor-website/edit/master/docs/integration/lua/apisix.md",tags:[],version:"current",frontMatter:{title:"APISIX",description:"Casdoor in APISIX verwenden",keywords:["APISIX"],authors:["Steve0x2a"]},sidebar:"tutorialSidebar",previous:{title:"Lua",permalink:"/de/docs/category/lua"},next:{title:"PHP",permalink:"/de/docs/category/php"}},o={},s=[{value:"Verbinden Sie Casdoor \xfcber das Casdoor-Plugin von APISIX",id:"verbinden-sie-casdoor-\xfcber-das-casdoor-plugin-von-apisix",level:2},{value:"Wie man es aktiviert",id:"wie-man-es-aktiviert",level:3},{value:"Attribute",id:"attribute",level:3},{value:"Wie funktioniert es?",id:"wie-funktioniert-es",level:3},{value:"Verbinden Sie Casdoor \xfcber das OIDC-Plugin von APISIX",id:"verbinden-sie-casdoor-\xfcber-das-oidc-plugin-von-apisix",level:2},{value:"Schritt 1: Casdoor und APISIX bereitstellen",id:"schritt-1-casdoor-und-apisix-bereitstellen",level:3},{value:"Schritt 2: Casdoor-Anwendung konfigurieren",id:"schritt-2-casdoor-anwendung-konfigurieren",level:3},{value:"Schritt 3: APISIX konfigurieren",id:"schritt-3-apisix-konfigurieren",level:3}],u={toc:s};function c(e){let{components:n,...a}=e;return(0,r.kt)("wrapper",(0,i.Z)({},u,a,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"Derzeit gibt es 2 Methoden, um Casdoor zu verwenden, um sich \xfcber APISIX-Plugins mit APISIX zu verbinden und die APIs hinter APISIX zu sch\xfctzen: Verwendung des Casdoor-Plugins von APISIX oder Verwendung des OIDC-Plugins von APISIX."),(0,r.kt)("h2",{id:"verbinden-sie-casdoor-\xfcber-das-casdoor-plugin-von-apisix"},"Verbinden Sie Casdoor \xfcber das Casdoor-Plugin von APISIX"),(0,r.kt)("p",null,"Dieses Plugin, ",(0,r.kt)("inlineCode",{parentName:"p"},"authz-casdoor"),", kann APIs hinter APISIX sch\xfctzen, indem es jede einzelne Anfrage authentifiziert, ohne den Code der API zu \xe4ndern."),(0,r.kt)("h3",{id:"wie-man-es-aktiviert"},"Wie man es aktiviert"),(0,r.kt)("p",null,"Sie m\xfcssen dieses Plugin angeben, wenn Sie die Route erstellen und alle erforderlichen Felder bereitstellen. Hier ist ein Beispiel."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes/1" -H "X-API-KEY: edd1c9f034335f136f87ad84b625c8f1" -X PUT -d \'\n{\n  "methods": ["GET"],\n  "uri": "/anything/*",\n  "plugins": {\n    "authz-casdoor": {\n        "endpoint_addr":"http://localhost:8000",\n        "callback_url":"http://localhost:9080/anything/callback",\n        "client_id":"7ceb9b7fda4a9061ec1c",\n        "client_secret":"3416238e1edf915eac08b8fe345b2b95cdba7e04"\n    }\n  },\n  "upstream": {\n    "type": "roundrobin",\n    "nodes": {\n      "httpbin.org:80": 1\n    }\n  }\n}\'\n')),(0,r.kt)("p",null,'In diesem Beispiel haben wir eine Route "/anything/*" erstellt, die auf "httpbin.org:80" zeigt, indem wir die Admin-API von APISIX verwenden, mit dem aktivierten "authz-casdoor"-Plugin. Diese Route steht nun unter dem Authentifizierungsschutz von Casdoor.'),(0,r.kt)("h3",{id:"attribute"},"Attribute"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Name"),(0,r.kt)("th",{parentName:"tr",align:null},"Typ"),(0,r.kt)("th",{parentName:"tr",align:null},"Anforderung"),(0,r.kt)("th",{parentName:"tr",align:null},"Standard"),(0,r.kt)("th",{parentName:"tr",align:null},"G\xfcltig"),(0,r.kt)("th",{parentName:"tr",align:null},"Beschreibung"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"endpoint_addr"),(0,r.kt)("td",{parentName:"tr",align:null},"Zeichenkette"),(0,r.kt)("td",{parentName:"tr",align:null},"erforderlich"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Die URL von Casdoor.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"client_id"),(0,r.kt)("td",{parentName:"tr",align:null},"Zeichenkette"),(0,r.kt)("td",{parentName:"tr",align:null},"erforderlich"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Die Client-ID in Casdoor.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"client_secret"),(0,r.kt)("td",{parentName:"tr",align:null},"Zeichenkette"),(0,r.kt)("td",{parentName:"tr",align:null},"erforderlich"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Das Client-Geheimnis in Casdoor.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"callback_url"),(0,r.kt)("td",{parentName:"tr",align:null},"Zeichenkette"),(0,r.kt)("td",{parentName:"tr",align:null},"erforderlich"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Die Callback-URL, die verwendet wird, um Zustand und Code zu empfangen.")))),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"endpoint_addr und callback_url sollten nicht mit '/' enden")),(0,r.kt)("p",null,'In der Konfiguration des "authz-casdoor"-Plugins k\xf6nnen wir vier Parameter sehen.'),(0,r.kt)("p",null,'Das erste ist "callback_url". Dies ist die Callback-URL in OAuth2. Es sollte betont werden, dass diese Callback-URL ',(0,r.kt)("strong",{parentName:"p"},'zur "uri" geh\xf6ren muss, die Sie f\xfcr die Route angegeben haben'),". Zum Beispiel geh\xf6rt in diesem Beispiel ",(0,r.kt)("a",{parentName:"p",href:"http://localhost:9080/anything/callback"},"http://localhost:9080/anything/callback"),' offensichtlich zu "/anything/*". Nur auf diese Weise kann der Besuch der callback_url vom Plugin abgefangen und genutzt werden (damit das Plugin den Code und den Zustand in OAuth2 erhalten kann). Die Logik der callback_url wird vollst\xe4ndig vom Plugin implementiert, daher ist es nicht notwendig, den Server zu \xe4ndern, um diese Callback-Funktion zu implementieren.'),(0,r.kt)("p",null,'Der zweite Parameter "endpoint_addr" ist offensichtlich die URL von Casdoor. Der dritte und vierte Parameter sind "client_id" und "client_secret", die Sie von Casdoor erhalten k\xf6nnen, wenn Sie eine App registrieren.'),(0,r.kt)("h3",{id:"wie-funktioniert-es"},"Wie funktioniert es?"),(0,r.kt)("p",null,"Nehmen wir an, ein neuer Benutzer, der diese Route zuvor noch nie besucht hat, wird sie besuchen (",(0,r.kt)("a",{parentName:"p",href:"http://localhost:9080/anything/d?param1=foo&param2=bar"},"http://localhost:9080/anything/d?param1=foo","\xb6","m2=bar"),'). Da das "authz-casdoor" aktiviert ist, wird dieser Besuch zuerst vom "authz-casdoor"-Plugin verarbeitet. Nachdem die Sitzung \xfcberpr\xfcft und best\xe4tigt wurde, dass dieser Benutzer noch nicht authentifiziert wurde, wird der Besuch abgefangen. Mit der urspr\xfcnglichen URL, die der Benutzer besuchen m\xf6chte, wird er zur Anmeldeseite von Casdoor weitergeleitet.'),(0,r.kt)("p",null,'Nachdem er sich erfolgreich mit einem Benutzernamen und Passwort (oder welcher Methode auch immer) angemeldet hat, wird Casdoor diesen Benutzer mit den GET-Parametern "code" und "state" zur "callback_url" weiterleiten. Da die "callback_url" dem Plugin bekannt ist, wird beim diesmaligen Abfangen des Besuchs der "callback_url" die Logik des "Authorization code Grant Flow" in OAuth2 ausgel\xf6st. Das bedeutet, dass das Plugin das Zugriffstoken anfordern wird, um zu best\xe4tigen, ob dieser Benutzer wirklich eingeloggt ist. Nach dieser Best\xe4tigung wird das Plugin diesen Benutzer zur urspr\xfcnglichen URL weiterleiten, die er besuchen wollte und die wir zuvor gespeichert haben. Der eingeloggte Status wird auch in der Sitzung gespeichert.'),(0,r.kt)("p",null,"Wenn dieser Benutzer das n\xe4chste Mal die URL hinter dieser Route besuchen m\xf6chte (zum Beispiel ",(0,r.kt)("a",{parentName:"p",href:"http://localhost:9080/anything/d"},"http://localhost:9080/anything/d"),"), wird dieses Plugin ihn nicht mehr weiterleiten, nachdem festgestellt wurde, dass dieser Benutzer zuvor bereits authentifiziert wurde. Auf diese Weise kann der Benutzer alles unter dieser Route besuchen, ohne gest\xf6rt zu werden."),(0,r.kt)("h2",{id:"verbinden-sie-casdoor-\xfcber-das-oidc-plugin-von-apisix"},"Verbinden Sie Casdoor \xfcber das OIDC-Plugin von APISIX"),(0,r.kt)("p",null,"Casdoor kann das OIDC-Protokoll verwenden, um sich mit APISIX zu verbinden, und dieses Dokument zeigt Ihnen, wie es geht."),(0,r.kt)("p",null,"Die folgenden sind einige der Namen, die in der Konfiguration verwendet werden:"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"CASDOOR_HOSTNAME"),": Domainname oder IP, wo der Casdoor-Server bereitgestellt ist."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"APISIX_HOSTNAME"),": Domainname oder IP, wo APISIX bereitgestellt ist."),(0,r.kt)("h3",{id:"schritt-1-casdoor-und-apisix-bereitstellen"},"Schritt 1: Casdoor und APISIX bereitstellen"),(0,r.kt)("p",null,"Zuerst ",(0,r.kt)("a",{parentName:"p",href:"/docs/basic/server-installation"},"Casdoor")," und ",(0,r.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/apisix/installation-guide/"},"APISIX")," bereitstellen."),(0,r.kt)("p",null,"Nach einer erfolgreichen Bereitstellung m\xfcssen Sie sicherstellen:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Casdoor kann eingeloggt und normal verwendet werden."),(0,r.kt)("li",{parentName:"ol"},"Setzen Sie den ",(0,r.kt)("inlineCode",{parentName:"li"},"origin"),"-Wert von Casdoor (conf/app.conf) auf ",(0,r.kt)("inlineCode",{parentName:"li"},"CASDOOR_HOSTNAME"),". ",(0,r.kt)("img",{alt:"Casdoor-Konfiguration",src:t(66496).Z,width:"1013",height:"448"}))),(0,r.kt)("h3",{id:"schritt-2-casdoor-anwendung-konfigurieren"},"Schritt 2: Casdoor-Anwendung konfigurieren"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Erstellen Sie eine neue Casdoor-Anwendung oder verwenden Sie eine vorhandene."),(0,r.kt)("li",{parentName:"ol"},"F\xfcgen Sie eine Weiterleitungs-URL hinzu: ",(0,r.kt)("inlineCode",{parentName:"li"},"http://APISIX_HOSTNAME/REDIRECTWHATYOUWANT")," und ersetzen Sie ",(0,r.kt)("inlineCode",{parentName:"li"},"REDIRECTWHATYOUWANT")," mit der gew\xfcnschten Weiterleitungs-URL."),(0,r.kt)("li",{parentName:"ol"},'W\xe4hlen Sie f\xfcr die Tokenformatoption "JWT-Empty".'),(0,r.kt)("li",{parentName:"ol"},"F\xfcgen Sie den gew\xfcnschten Anbieter hinzu und konfigurieren Sie andere Einstellungen.")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Anwendungseinstellung",src:t(19654).Z,width:"2103",height:"538"})," Auf der Seite der Anwendungseinstellungen finden Sie die Werte ",(0,r.kt)("inlineCode",{parentName:"p"},"Client ID")," und ",(0,r.kt)("inlineCode",{parentName:"p"},"Client Secret"),", wie im Bild oben gezeigt. Wir werden sie im n\xe4chsten Schritt verwenden."),(0,r.kt)("p",null,"\xd6ffnen Sie Ihren bevorzugten Browser und besuchen Sie: ",(0,r.kt)("strong",{parentName:"p"},"http://",(0,r.kt)("inlineCode",{parentName:"strong"},"CASDOOR_HOSTNAME"),"/.well-known/openid-configuration"),", wo Sie die OIDC-Konfiguration von Casdoor finden werden."),(0,r.kt)("h3",{id:"schritt-3-apisix-konfigurieren"},"Schritt 3: APISIX konfigurieren"),(0,r.kt)("p",null,"APISIX hat offizielle ",(0,r.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/apisix/plugins/openid-connect/"},"OIDC"),"-Unterst\xfctzung, die mit ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/zmartzone/lua-resty-openidc"},"lua-resty-openidc")," implementiert wird."),(0,r.kt)("p",null,"Sie k\xf6nnen die Einstellungen gem\xe4\xdf der APISIX OIDC-Dokumentation anpassen. Die folgenden Routing-Einstellungen werden verwendet:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'# Use your own X-Api-Key\n$ curl -X POST APISIX_HOSTNAME/apisix/admin/routes -H "X-Api-Key: edd1c9f034335f136f87ad84b625c8f1" -d \'{\n  "uri": "/get",\n  "name": "apisix_casdoor_test",\n  "plugins": {\n    "openid-connect": {\n      "client_id": "Client ID",\n      "client_secret": "Client Secret",\n      "discovery": "http://CASDOOR_HOSTNAME/.well-known/openid-configuration",\n      "introspection_endpoint_auth_method": "client_secret_basic",\n      "logout_path": "/logout",\n      "realm": "master",\n      "redirect_uri": "http://APISIX_HOSTNAME/REDIRECTWHATYOUWANT",\n      "bearer_only": false,\n      "set_id_token_header": false,\n      "access_token_in_authorization_header": true,\n      "set_access_token_header": true,\n      "set_userinfo_header": false,\n      "realm": "master"\n    }\n  },\n  "upstream": {\n    "type": "roundrobin",\n    "nodes": {\n      "httpbin.org:80": 1\n    }\n  }\n}\'\n')),(0,r.kt)("p",null,"Besuchen Sie jetzt ",(0,r.kt)("inlineCode",{parentName:"p"},"http://APISIX_HOSTNAME/get"),", und der Browser wird Sie zur Casdoor-Anmeldeseite weiterleiten. Nachdem Sie sich erfolgreich angemeldet haben, werden Sie sehen, dass eine Anfrage an httpbin.org gesendet wurde, wie im Screenshot unten gezeigt. ",(0,r.kt)("img",{alt:"APISIX_Ergebnis",src:t(37695).Z,width:"2209",height:"1648"})))}c.isMDXComponent=!0},66496:(e,n,t)=>{t.d(n,{Z:()=>i});const i=t.p+"assets/images/casdoor_origin-8f5d9e44f6b58828ce69e6e6d896e122.png"},37695:(e,n,t)=>{t.d(n,{Z:()=>i});const i=t.p+"assets/images/apisix_result-3475043d31a06fd90894e80e8b4ca9f3.png"},19654:(e,n,t)=>{t.d(n,{Z:()=>i});const i=t.p+"assets/images/casdoor_jwtempty-68f57615f6dc135f498b45e6b2d7bf57.png"}}]);