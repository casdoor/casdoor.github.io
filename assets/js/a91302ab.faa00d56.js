"use strict";(self.webpackChunkcasdoor_website=self.webpackChunkcasdoor_website||[]).push([[9728],{3905:(e,t,o)=>{o.d(t,{Zo:()=>c,kt:()=>m});var a=o(67294);function n(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function r(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,a)}return o}function i(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?r(Object(o),!0).forEach((function(t){n(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):r(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function s(e,t){if(null==e)return{};var o,a,n=function(e,t){if(null==e)return{};var o,a,n={},r=Object.keys(e);for(a=0;a<r.length;a++)o=r[a],t.indexOf(o)>=0||(n[o]=e[o]);return n}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)o=r[a],t.indexOf(o)>=0||Object.prototype.propertyIsEnumerable.call(e,o)&&(n[o]=e[o])}return n}var l=a.createContext({}),p=function(e){var t=a.useContext(l),o=t;return e&&(o="function"==typeof e?e(t):i(i({},t),e)),o},c=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var o=e.components,n=e.mdxType,r=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),u=p(o),m=n,h=u["".concat(l,".").concat(m)]||u[m]||d[m]||r;return o?a.createElement(h,i(i({ref:t},c),{},{components:o})):a.createElement(h,i({ref:t},c))}));function m(e,t){var o=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var r=o.length,i=new Array(r);i[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:n,i[1]=s;for(var p=2;p<r;p++)i[p]=o[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,o)}u.displayName="MDXCreateElement"},13020:(e,t,o)=>{o.r(t),o.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>d,frontMatter:()=>r,metadata:()=>s,toc:()=>p});var a=o(87462),n=(o(67294),o(3905));const r={title:"WeChat MiniProgram",description:"Using Casdoor in WeChat MiniProgram",keywords:["WeChat","MiniProgram"]},i=void 0,s={unversionedId:"integration/javascript/wechat_miniprogram",id:"integration/javascript/wechat_miniprogram",title:"WeChat MiniProgram",description:"Using Casdoor in WeChat MiniProgram",source:"@site/docs/integration/javascript/wechat_miniprogram.md",sourceDirName:"integration/javascript",slug:"/integration/javascript/wechat_miniprogram",permalink:"/docs/integration/javascript/wechat_miniprogram",draft:!1,editUrl:"https://github.com/casdoor/casdoor-website/edit/master/docs/integration/javascript/wechat_miniprogram.md",tags:[],version:"current",lastUpdatedBy:"jakiuncle",lastUpdatedAt:1667657613,formattedLastUpdatedAt:"Nov 5, 2022",frontMatter:{title:"WeChat MiniProgram",description:"Using Casdoor in WeChat MiniProgram",keywords:["WeChat","MiniProgram"]},sidebar:"tutorialSidebar",previous:{title:"JavaScript",permalink:"/docs/category/javascript"},next:{title:"Lua",permalink:"/docs/category/lua"}},l={},p=[{value:"Introduction",id:"introduction",level:2},{value:"Step1. Deploy Casdoor",id:"step1-deploy-casdoor",level:2},{value:"Step2. Configure Casdoor application",id:"step2-configure-casdoor-application",level:2},{value:"Step3. Write WeChat MiniProgram code",id:"step3-write-wechat-miniprogram-code",level:2}],c={toc:p};function d(e){let{components:t,...r}=e;return(0,n.kt)("wrapper",(0,a.Z)({},c,r,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("admonition",{type:"info"},(0,n.kt)("p",{parentName:"admonition"},"Casdoor supports WeChat Mini Program after version 1.41.0")),(0,n.kt)("h2",{id:"introduction"},"Introduction"),(0,n.kt)("p",null,"Since WeChat Mini Program does not support standardized OAuth, it cannot jump to the self-host Casdoor webpage for login.\nTherefore, the process of using Casdoor for WeChat Mini Program is different from that of ordinary programs. "),(0,n.kt)("p",null,"This document will talk about how to access Casdoor to WeChat Mini Program. You can find the example on GitHub here: ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/casdoor/casdoor-wechat-miniprogram-example"},"casdoor-wechat-miniprogram-example"),".\nMore detailed information can be found in the WeChat Mini Program ",(0,n.kt)("a",{parentName:"p",href:"https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html"},"login document"),"."),(0,n.kt)("blockquote",null,(0,n.kt)("p",{parentName:"blockquote"},"The following are some of the names in the configuration:"),(0,n.kt)("p",{parentName:"blockquote"},(0,n.kt)("inlineCode",{parentName:"p"},"CASDOOR_HOSTNAME"),": Domain name or IP where Casdoor server is deployed. e.g., ",(0,n.kt)("inlineCode",{parentName:"p"},"https://door.casbin.com"),".")),(0,n.kt)("h2",{id:"step1-deploy-casdoor"},"Step1. Deploy Casdoor"),(0,n.kt)("p",null,"Firstly, the ",(0,n.kt)("a",{parentName:"p",href:"/docs/basic/server-installation"},"Casdoor")," should be deployed. "),(0,n.kt)("p",null,"After a successful deployment, you need to ensure:"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"Casdoor can be logged in and used normally."),(0,n.kt)("li",{parentName:"ol"},"Set Casdoor's ",(0,n.kt)("inlineCode",{parentName:"li"},"origin")," value (conf/app.conf) to ",(0,n.kt)("inlineCode",{parentName:"li"},"CASDOOR_HOSTNAME"),".\n",(0,n.kt)("img",{alt:"Casdoor conf",src:o(66496).Z,width:"1013",height:"448"}))),(0,n.kt)("h2",{id:"step2-configure-casdoor-application"},"Step2. Configure Casdoor application"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"Create a wechat idp in casdoor and fill your ",(0,n.kt)("inlineCode",{parentName:"li"},"APPID")," and ",(0,n.kt)("inlineCode",{parentName:"li"},"APPSECRET")," given to you by WeChat Mini Program develop platform:\n",(0,n.kt)("img",{alt:"WeChat_MiniProgram.png",src:o(72503).Z,width:"937",height:"773"})),(0,n.kt)("li",{parentName:"ol"},"Create or use an existing Casdoor application."),(0,n.kt)("li",{parentName:"ol"},"Add the idp added above to the application you want to use.")),(0,n.kt)("admonition",{title:"Tips",type:"info"},(0,n.kt)("p",{parentName:"admonition"},"For convenience, casdoor will read the first WeChat type idp in the application as the WeChat Mini Program idp by default."),(0,n.kt)("p",{parentName:"admonition"},"So if you want to use the WeChat Mini Program in this app, don't add multiple WeChat type idp in one app.")),(0,n.kt)("h2",{id:"step3-write-wechat-miniprogram-code"},"Step3. Write WeChat MiniProgram code"),(0,n.kt)("p",null,"WeChat Mini Program provides an API to login internally and gets the Code. All you need to do is to send this Code to Casdoor.\nCasdoor will use this Code to get some information from WeChat server (such as OpenID, SessionKey, etc.)."),(0,n.kt)("p",null,"The following code shows how to accomplish the above process:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-js"},'// login in mini program\nwx.login({\n  success: res => {\n    // this is your login code you need to send to casdoor\n    console.log(res.code)\n    \n    wx.request({\n      url: `${CASDOOR_HOSTNAME}/api/login/oauth/access_token`,\n      method: "POST",\n      data: {\n        "tag": "wechat_miniprogram", // required\n        "client_id": "6825f4f0af45554c8952",\n        "code": res.code,\n        "username": this.data.userInfo.nickName, // update user profile, when you login.\n        "avatar": this.data.userInfo.avatarUrl,\n      },\n      header:{\n        "content-type": "application/x-www-form-urlencoded",\n      },\n      success: res => {\n        console.log(res)\n        this.globalData.accessToken = res.data.access_token // get casdoor\'s accessToken\n      }\n    })\n  }\n})\n')),(0,n.kt)("p",null,"It is worth mentioning that the ",(0,n.kt)("inlineCode",{parentName:"p"},"tag")," parameter is mandatory and you need to make casdoor understand that this is a request from the WeChat Mini Program."),(0,n.kt)("p",null,"The above code passes in the username and avatar uri of the WeChat Mini Program user while logging in. You can also pass these two parameters without passing them first, and then pass them to casdoor after the login is successful and accessToken is obtained:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-js"},'wx.getUserProfile({\n  desc: \'share your info to casdoor\', \n  success: (res) => {\n    this.setData({\n      userInfo: res.userInfo,\n      hasUserInfo: true\n    })\n    console.log(app.globalData.accessToken)\n    wx.request({\n      url: `${CASDOOR_HOSTNAME}/api/update-user`, // casdoor uri\n      method: "POST",\n      data: {\n        "owner": "test",\n        "name": "wechat-oGk3T5tIiMFo3SazCO75f0HEiE7Q",\n        "displayName": this.data.userInfo.nickName,\n        "avatar": this.data.userInfo.avatarUrl\n      },\n      header: {\n        "Authorization": "Bearer " + app.globalData.accessToken, // Bearer token\n        "content-type": "application/json"\n      },\n      success: (res) => {\n        console.log(res)\n      }\n    })\n  }\n})\n')),(0,n.kt)("p",null,"Also, you can use accessToken as a bearer token for any Casdoor operation you want."),(0,n.kt)("admonition",{title:"Tips",type:"info"},(0,n.kt)("p",{parentName:"admonition"},"Currently Casdoor is unable to bind existing accounts to the WeChat Mini Program users. After Casdoor gets the openID from WeChat if this id does not exist, a new user will be created, and if it exists, the old one will be used.")))}d.isMDXComponent=!0},66496:(e,t,o)=>{o.d(t,{Z:()=>a});const a=o.p+"assets/images/casdoor_origin-8f5d9e44f6b58828ce69e6e6d896e122.png"},72503:(e,t,o)=>{o.d(t,{Z:()=>a});const a=o.p+"assets/images/WeChat_MiniProgram-701cc38162bc50d472b5226e5f167e3c.png"}}]);