"use strict";(self.webpackChunkcasdoor_website=self.webpackChunkcasdoor_website||[]).push([[7834],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>m});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),u=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},p=function(e){var t=u(e.components);return a.createElement(s.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),d=u(n),m=r,g=d["".concat(s,".").concat(m)]||d[m]||c[m]||i;return n?a.createElement(g,l(l({ref:t},p),{},{components:n})):a.createElement(g,l({ref:t},p))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,l=new Array(i);l[0]=d;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o.mdxType="string"==typeof e?e:r,l[1]=o;for(var u=2;u<i;u++)l[u]=n[u];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},94556:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>c,frontMatter:()=>i,metadata:()=>o,toc:()=>u});var a=n(87462),r=(n(67294),n(3905));const i={title:"APISIX",description:"Utiliser Casdoor dans APISIX",keywords:["APISIX"],authors:["Steve0x2a"]},l=void 0,o={unversionedId:"integration/lua/apisix",id:"integration/lua/apisix",title:"APISIX",description:"Utiliser Casdoor dans APISIX",source:"@site/i18n/fr/docusaurus-plugin-content-docs/current/integration/lua/apisix.md",sourceDirName:"integration/lua",slug:"/integration/lua/apisix",permalink:"/fr/docs/integration/lua/apisix",draft:!1,editUrl:"https://github.com/casdoor/casdoor-website/edit/master/docs/integration/lua/apisix.md",tags:[],version:"current",frontMatter:{title:"APISIX",description:"Utiliser Casdoor dans APISIX",keywords:["APISIX"],authors:["Steve0x2a"]},sidebar:"tutorialSidebar",previous:{title:"Lua",permalink:"/fr/docs/category/lua"},next:{title:"PHP",permalink:"/fr/docs/category/php"}},s={},u=[{value:"Connectez Casdoor via le plugin Casdoor d&#39;APISIX",id:"connectez-casdoor-via-le-plugin-casdoor-dapisix",level:2},{value:"Comment l&#39;activer",id:"comment-lactiver",level:3},{value:"Attributs",id:"attributs",level:3},{value:"Comment \xe7a fonctionne ?",id:"comment-\xe7a-fonctionne-",level:3},{value:"Connectez Casdoor via le plugin OIDC d&#39;APISIX",id:"connectez-casdoor-via-le-plugin-oidc-dapisix",level:2},{value:"\xc9tape 1 : D\xe9ployer Casdoor et APISIX",id:"\xe9tape-1--d\xe9ployer-casdoor-et-apisix",level:3},{value:"\xc9tape 2 : Configurer l&#39;application Casdoor",id:"\xe9tape-2--configurer-lapplication-casdoor",level:3},{value:"\xc9tape 3 : Configurer APISIX",id:"\xe9tape-3--configurer-apisix",level:3}],p={toc:u};function c(e){let{components:t,...i}=e;return(0,r.kt)("wrapper",(0,a.Z)({},p,i,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"Actuellement, il existe 2 m\xe9thodes pour utiliser Casdoor pour se connecter \xe0 APISIX via les plugins APISIX et prot\xe9ger les API derri\xe8re APISIX : en utilisant le plugin Casdoor d'APISIX ou le plugin OIDC d'APISIX."),(0,r.kt)("h2",{id:"connectez-casdoor-via-le-plugin-casdoor-dapisix"},"Connectez Casdoor via le plugin Casdoor d'APISIX"),(0,r.kt)("p",null,"Ce plugin, ",(0,r.kt)("inlineCode",{parentName:"p"},"authz-casdoor"),", peut prot\xe9ger les API derri\xe8re APISIX, en for\xe7ant chaque requ\xeate \xe0 \xeatre authentifi\xe9e sans modifier le code de l'API."),(0,r.kt)("h3",{id:"comment-lactiver"},"Comment l'activer"),(0,r.kt)("p",null,"Vous devez sp\xe9cifier ce plugin lors de la cr\xe9ation de la route et fournir tous les champs requis. Voici un exemple."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes/1" -H "X-API-KEY: edd1c9f034335f136f87ad84b625c8f1" -X PUT -d \'\n{\n  "methods": ["GET"],\n  "uri": "/anything/*",\n  "plugins": {\n    "authz-casdoor": {\n        "endpoint_addr":"http://localhost:8000",\n        "callback_url":"http://localhost:9080/anything/callback",\n        "client_id":"7ceb9b7fda4a9061ec1c",\n        "client_secret":"3416238e1edf915eac08b8fe345b2b95cdba7e04"\n    }\n  },\n  "upstream": {\n    "type": "roundrobin",\n    "nodes": {\n      "httpbin.org:80": 1\n    }\n  }\n}\'\n')),(0,r.kt)("p",null,'Dans cet exemple, nous avons cr\xe9\xe9 une route "/anything/*" pointant vers "httpbin.org:80" en utilisant l\'API d\'administration d\'APISIX, avec le plugin "authz-casdoor" activ\xe9. Cette route est maintenant sous la protection d\'authentification de Casdoor.'),(0,r.kt)("h3",{id:"attributs"},"Attributs"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Nom"),(0,r.kt)("th",{parentName:"tr",align:null},"Type"),(0,r.kt)("th",{parentName:"tr",align:null},"Exigence"),(0,r.kt)("th",{parentName:"tr",align:null},"D\xe9faut"),(0,r.kt)("th",{parentName:"tr",align:null},"Valide"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"endpoint_addr"),(0,r.kt)("td",{parentName:"tr",align:null},"cha\xeene"),(0,r.kt)("td",{parentName:"tr",align:null},"requis"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"L'URL de Casdoor.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"client_id"),(0,r.kt)("td",{parentName:"tr",align:null},"cha\xeene"),(0,r.kt)("td",{parentName:"tr",align:null},"requis"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"L'ID client dans Casdoor.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"client_secret"),(0,r.kt)("td",{parentName:"tr",align:null},"cha\xeene"),(0,r.kt)("td",{parentName:"tr",align:null},"requis"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"Le secret client dans Casdoor.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"callback_url"),(0,r.kt)("td",{parentName:"tr",align:null},"cha\xeene"),(0,r.kt)("td",{parentName:"tr",align:null},"requis"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"L'URL de rappel qui est utilis\xe9e pour recevoir l'\xe9tat et le code.")))),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"endpoint_addr et callback_url ne doivent pas se terminer par '/'")),(0,r.kt)("p",null,'Dans la configuration du plugin "authz-casdoor", nous pouvons voir quatre param\xe8tres.'),(0,r.kt)("p",null,'Le premier est "callback_url". Ceci est l\'URL de rappel dans OAuth2. Il convient de souligner que cette URL de rappel ',(0,r.kt)("strong",{parentName:"p"},'doit appartenir \xe0 l\'"uri" que vous avez sp\xe9cifi\xe9 pour la route'),". Par exemple, dans cet exemple, ",(0,r.kt)("a",{parentName:"p",href:"http://localhost:9080/anything/callback"},"http://localhost:9080/anything/callback")," appartient \xe9videmment \xe0 \"/anything/*\". Seulement de cette mani\xe8re, la visite vers le callback_url peut \xeatre intercept\xe9e et utilis\xe9e par le plugin (afin que le plugin puisse obtenir le code et l'\xe9tat dans OAuth2). La logique du callback_url est impl\xe9ment\xe9e compl\xe8tement par le plugin, donc il n'est pas n\xe9cessaire de modifier le serveur pour impl\xe9menter ce rappel."),(0,r.kt)("p",null,'Le deuxi\xe8me param\xe8tre "endpoint_addr" est \xe9videmment l\'URL de Casdoor. Le troisi\xe8me et le quatri\xe8me param\xe8tres sont "client_id" et "client_secret", que vous pouvez obtenir de Casdoor lorsque vous enregistrez une application.'),(0,r.kt)("h3",{id:"comment-\xe7a-fonctionne-"},"Comment \xe7a fonctionne ?"),(0,r.kt)("p",null,"Supposons qu'un nouvel utilisateur qui n'a jamais visit\xe9 cette route auparavant va la visiter (",(0,r.kt)("a",{parentName:"p",href:"http://localhost:9080/anything/d?param1=foo&param2=bar"},"http://localhost:9080/anything/d?param1=foo","\xb6","m2=bar"),"). Consid\xe9rant que \"authz-casdoor\" est activ\xe9, cette visite sera d'abord trait\xe9e par le plugin \"authz-casdoor\". Apr\xe8s avoir v\xe9rifi\xe9 la session et confirm\xe9 que cet utilisateur n'a pas \xe9t\xe9 authentifi\xe9, la visite sera intercept\xe9e. Avec l'URL originale que l'utilisateur souhaite visiter conserv\xe9e, il sera redirig\xe9 vers la page de connexion de Casdoor."),(0,r.kt)("p",null,'Apr\xe8s s\'\xeatre connect\xe9 avec succ\xe8s avec un nom d\'utilisateur et un mot de passe (ou quelle que soit la m\xe9thode utilis\xe9e), Casdoor redirigera cet utilisateur vers le "callback_url" avec les param\xe8tres GET "code" et "\xe9tat" sp\xe9cifi\xe9s. Comme le "callback_url" est connu par le plugin, lorsque la visite vers le "callback_url" est intercept\xe9e cette fois, la logique du "Authorization code Grant Flow" dans OAuth2 sera d\xe9clench\xe9e. Cela signifie que le plugin demandera le jeton d\'acc\xe8s pour confirmer si cet utilisateur est vraiment connect\xe9. Apr\xe8s cette confirmation, le plugin redirigera cet utilisateur vers l\'URL originale qu\'il souhaite visiter, qui a \xe9t\xe9 conserv\xe9e par nous pr\xe9c\xe9demment. Le statut connect\xe9 sera \xe9galement conserv\xe9 dans la session.'),(0,r.kt)("p",null,"La prochaine fois que cet utilisateur voudra visiter l'URL derri\xe8re cette route (par exemple, ",(0,r.kt)("a",{parentName:"p",href:"http://localhost:9080/anything/d"},"http://localhost:9080/anything/d"),"), apr\xe8s avoir d\xe9couvert que cet utilisateur a \xe9t\xe9 authentifi\xe9 pr\xe9c\xe9demment, ce plugin ne redirigera plus cet utilisateur. De cette fa\xe7on, l'utilisateur peut visiter ce qu'il veut sous cette route sans \xeatre perturb\xe9."),(0,r.kt)("h2",{id:"connectez-casdoor-via-le-plugin-oidc-dapisix"},"Connectez Casdoor via le plugin OIDC d'APISIX"),(0,r.kt)("p",null,"Casdoor peut utiliser le protocole OIDC pour se connecter \xe0 APISIX, et ce document vous montrera comment faire."),(0,r.kt)("p",null,"Voici quelques-uns des noms utilis\xe9s dans la configuration :"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"CASDOOR_HOSTNAME")," : Nom de domaine ou IP o\xf9 le serveur Casdoor est d\xe9ploy\xe9."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"APISIX_HOSTNAME")," : Nom de domaine ou IP o\xf9 APISIX est d\xe9ploy\xe9."),(0,r.kt)("h3",{id:"\xe9tape-1--d\xe9ployer-casdoor-et-apisix"},"\xc9tape 1 : D\xe9ployer Casdoor et APISIX"),(0,r.kt)("p",null,"Tout d'abord, d\xe9ployez ",(0,r.kt)("a",{parentName:"p",href:"/docs/basic/server-installation"},"Casdoor")," et ",(0,r.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/apisix/installation-guide/"},"APISIX"),"."),(0,r.kt)("p",null,"Apr\xe8s un d\xe9ploiement r\xe9ussi, vous devez vous assurer :"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Casdoor peut \xeatre connect\xe9 et utilis\xe9 normalement."),(0,r.kt)("li",{parentName:"ol"},"D\xe9finissez la valeur ",(0,r.kt)("inlineCode",{parentName:"li"},"origin")," de Casdoor (conf/app.conf) sur ",(0,r.kt)("inlineCode",{parentName:"li"},"CASDOOR_HOSTNAME"),". ",(0,r.kt)("img",{alt:"Casdoor conf",src:n(66496).Z,width:"1013",height:"448"}))),(0,r.kt)("h3",{id:"\xe9tape-2--configurer-lapplication-casdoor"},"\xc9tape 2 : Configurer l'application Casdoor"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Cr\xe9ez une nouvelle application Casdoor ou utilisez-en une existante."),(0,r.kt)("li",{parentName:"ol"},"Ajoutez une URL de redirection : ",(0,r.kt)("inlineCode",{parentName:"li"},"http://APISIX_HOSTNAME/REDIRECTWHATYOUWANT"),", et remplacez ",(0,r.kt)("inlineCode",{parentName:"li"},"REDIRECTWHATYOUWANT")," par l'URL de redirection souhait\xe9e."),(0,r.kt)("li",{parentName:"ol"},'S\xe9lectionnez "JWT-Empty" pour l\'option de format de jeton.'),(0,r.kt)("li",{parentName:"ol"},"Ajoutez le fournisseur souhait\xe9 et configurez les autres param\xe8tres.")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Param\xe9trage de l&#39;application",src:n(19654).Z,width:"2103",height:"538"})," Sur la page des param\xe8tres de l'application, vous trouverez les valeurs ",(0,r.kt)("inlineCode",{parentName:"p"},"Client ID")," et ",(0,r.kt)("inlineCode",{parentName:"p"},"Client Secret")," comme indiqu\xe9 dans l'image ci-dessus. Nous les utiliserons \xe0 l'\xe9tape suivante."),(0,r.kt)("p",null,"Ouvrez votre navigateur pr\xe9f\xe9r\xe9 et visitez : ",(0,r.kt)("strong",{parentName:"p"},"http://",(0,r.kt)("inlineCode",{parentName:"strong"},"CASDOOR_HOSTNAME"),"/.well-known/openid-configuration"),", o\xf9 vous trouverez la configuration OIDC de Casdoor."),(0,r.kt)("h3",{id:"\xe9tape-3--configurer-apisix"},"\xc9tape 3 : Configurer APISIX"),(0,r.kt)("p",null,"APISIX a un support officiel d'",(0,r.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/apisix/plugins/openid-connect/"},"OIDC"),", qui est impl\xe9ment\xe9 en utilisant ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/zmartzone/lua-resty-openidc"},"lua-resty-openidc"),"."),(0,r.kt)("p",null,"Vous pouvez personnaliser les param\xe8tres selon la documentation OIDC d'APISIX. Les param\xe8tres de routage suivants seront utilis\xe9s :"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'# Use your own X-Api-Key\n$ curl -X POST APISIX_HOSTNAME/apisix/admin/routes -H "X-Api-Key: edd1c9f034335f136f87ad84b625c8f1" -d \'{\n  "uri": "/get",\n  "name": "apisix_casdoor_test",\n  "plugins": {\n    "openid-connect": {\n      "client_id": "Client ID",\n      "client_secret": "Client Secret",\n      "discovery": "http://CASDOOR_HOSTNAME/.well-known/openid-configuration",\n      "introspection_endpoint_auth_method": "client_secret_basic",\n      "logout_path": "/logout",\n      "realm": "master",\n      "redirect_uri": "http://APISIX_HOSTNAME/REDIRECTWHATYOUWANT",\n      "bearer_only": false,\n      "set_id_token_header": false,\n      "access_token_in_authorization_header": true,\n      "set_access_token_header": true,\n      "set_userinfo_header": false,\n      "realm": "master"\n    }\n  },\n  "upstream": {\n    "type": "roundrobin",\n    "nodes": {\n      "httpbin.org:80": 1\n    }\n  }\n}\'\n')),(0,r.kt)("p",null,"Maintenant, visitez ",(0,r.kt)("inlineCode",{parentName:"p"},"http://APISIX_HOSTNAME/get"),", et le navigateur vous redirigera vers la page de connexion de Casdoor. Apr\xe8s vous \xeatre connect\xe9 avec succ\xe8s, vous verrez qu'une requ\xeate a \xe9t\xe9 envoy\xe9e \xe0 httpbin.org comme le montre la capture d'\xe9cran ci-dessous. ",(0,r.kt)("img",{alt:"APISIX_Result",src:n(37695).Z,width:"2209",height:"1648"})))}c.isMDXComponent=!0},66496:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/casdoor_origin-8f5d9e44f6b58828ce69e6e6d896e122.png"},37695:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/apisix_result-3475043d31a06fd90894e80e8b4ca9f3.png"},19654:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/casdoor_jwtempty-68f57615f6dc135f498b45e6b2d7bf57.png"}}]);