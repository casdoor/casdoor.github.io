"use strict";(self.webpackChunkcasdoor_website=self.webpackChunkcasdoor_website||[]).push([[7741],{3905:(e,a,t)=>{t.d(a,{Zo:()=>c,kt:()=>m});var n=t(67294);function r(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}function o(e,a){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a&&(n=n.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),t.push.apply(t,n)}return t}function i(e){for(var a=1;a<arguments.length;a++){var t=null!=arguments[a]?arguments[a]:{};a%2?o(Object(t),!0).forEach((function(a){r(e,a,t[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))}))}return e}function l(e,a){if(null==e)return{};var t,n,r=function(e,a){if(null==e)return{};var t,n,r={},o=Object.keys(e);for(n=0;n<o.length;n++)t=o[n],a.indexOf(t)>=0||(r[t]=e[t]);return r}(e,a);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)t=o[n],a.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var s=n.createContext({}),d=function(e){var a=n.useContext(s),t=a;return e&&(t="function"==typeof e?e(a):i(i({},a),e)),t},c=function(e){var a=d(e.components);return n.createElement(s.Provider,{value:a},e.children)},p={inlineCode:"code",wrapper:function(e){var a=e.children;return n.createElement(n.Fragment,{},a)}},u=n.forwardRef((function(e,a){var t=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),u=d(t),m=r,g=u["".concat(s,".").concat(m)]||u[m]||p[m]||o;return t?n.createElement(g,i(i({ref:a},c),{},{components:t})):n.createElement(g,i({ref:a},c))}));function m(e,a){var t=arguments,r=a&&a.mdxType;if("string"==typeof e||r){var o=t.length,i=new Array(o);i[0]=u;var l={};for(var s in a)hasOwnProperty.call(a,s)&&(l[s]=a[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var d=2;d<o;d++)i[d]=t[d];return n.createElement.apply(null,i)}return n.createElement.apply(null,t)}u.displayName="MDXCreateElement"},55185:(e,a,t)=>{t.r(a),t.d(a,{assets:()=>s,contentTitle:()=>i,default:()=>p,frontMatter:()=>o,metadata:()=>l,toc:()=>d});var n=t(87462),r=(t(67294),t(3905));const o={title:"APISIX",description:"Usando Casdoor en APISIX",keywords:["APISIX"],authors:["Steve0x2a"]},i=void 0,l={unversionedId:"integration/lua/apisix",id:"integration/lua/apisix",title:"APISIX",description:"Usando Casdoor en APISIX",source:"@site/i18n/es/docusaurus-plugin-content-docs/current/integration/lua/apisix.md",sourceDirName:"integration/lua",slug:"/integration/lua/apisix",permalink:"/es/docs/integration/lua/apisix",draft:!1,editUrl:"https://github.com/casdoor/casdoor-website/edit/master/docs/integration/lua/apisix.md",tags:[],version:"current",frontMatter:{title:"APISIX",description:"Usando Casdoor en APISIX",keywords:["APISIX"],authors:["Steve0x2a"]},sidebar:"tutorialSidebar",previous:{title:"Lua",permalink:"/es/docs/category/lua"},next:{title:"PHP",permalink:"/es/docs/category/php"}},s={},d=[{value:"Conectar Casdoor a trav\xe9s del plugin de Casdoor de APISIX",id:"conectar-casdoor-a-trav\xe9s-del-plugin-de-casdoor-de-apisix",level:2},{value:"C\xf3mo habilitarlo",id:"c\xf3mo-habilitarlo",level:3},{value:"Atributos",id:"atributos",level:3},{value:"\xbfC\xf3mo funciona?",id:"c\xf3mo-funciona",level:3},{value:"Conectar Casdoor a trav\xe9s del plugin OIDC de APISIX",id:"conectar-casdoor-a-trav\xe9s-del-plugin-oidc-de-apisix",level:2},{value:"Paso 1: Desplegar Casdoor y APISIX",id:"paso-1-desplegar-casdoor-y-apisix",level:3},{value:"Paso 2: Configurar la aplicaci\xf3n Casdoor",id:"paso-2-configurar-la-aplicaci\xf3n-casdoor",level:3},{value:"Paso 3: Configurar APISIX",id:"paso-3-configurar-apisix",level:3}],c={toc:d};function p(e){let{components:a,...o}=e;return(0,r.kt)("wrapper",(0,n.Z)({},c,o,{components:a,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"Actualmente, hay 2 m\xe9todos para usar Casdoor para conectarse a APISIX a trav\xe9s de los plugins de APISIX y proteger las APIs detr\xe1s de APISIX: usando el plugin de Casdoor de APISIX o usando el plugin OIDC de APISIX."),(0,r.kt)("h2",{id:"conectar-casdoor-a-trav\xe9s-del-plugin-de-casdoor-de-apisix"},"Conectar Casdoor a trav\xe9s del plugin de Casdoor de APISIX"),(0,r.kt)("p",null,"Este plugin, ",(0,r.kt)("inlineCode",{parentName:"p"},"authz-casdoor"),", puede proteger las APIs detr\xe1s de APISIX, forzando que cada solicitud se autentique sin modificar el c\xf3digo de la API."),(0,r.kt)("h3",{id:"c\xf3mo-habilitarlo"},"C\xf3mo habilitarlo"),(0,r.kt)("p",null,"Necesitas especificar este plugin al crear la ruta y proporcionar todos los campos requeridos. Aqu\xed hay un ejemplo."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes/1" -H "X-API-KEY: edd1c9f034335f136f87ad84b625c8f1" -X PUT -d \'\n{\n  "methods": ["GET"],\n  "uri": "/anything/*",\n  "plugins": {\n    "authz-casdoor": {\n        "endpoint_addr":"http://localhost:8000",\n        "callback_url":"http://localhost:9080/anything/callback",\n        "client_id":"7ceb9b7fda4a9061ec1c",\n        "client_secret":"3416238e1edf915eac08b8fe345b2b95cdba7e04"\n    }\n  },\n  "upstream": {\n    "type": "roundrobin",\n    "nodes": {\n      "httpbin.org:80": 1\n    }\n  }\n}\'\n')),(0,r.kt)("p",null,'En este ejemplo, creamos una ruta "/anything/*" apuntando a "httpbin.org:80" usando la API de administraci\xf3n de APISIX, con el plugin "authz-casdoor" habilitado. Esta ruta ahora est\xe1 bajo la protecci\xf3n de autenticaci\xf3n de Casdoor.'),(0,r.kt)("h3",{id:"atributos"},"Atributos"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Nombre"),(0,r.kt)("th",{parentName:"tr",align:null},"Tipo"),(0,r.kt)("th",{parentName:"tr",align:null},"Requisito"),(0,r.kt)("th",{parentName:"tr",align:null},"Predeterminado"),(0,r.kt)("th",{parentName:"tr",align:null},"V\xe1lido"),(0,r.kt)("th",{parentName:"tr",align:null},"Descripci\xf3n"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"endpoint_addr"),(0,r.kt)("td",{parentName:"tr",align:null},"cadena"),(0,r.kt)("td",{parentName:"tr",align:null},"requerido"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"La URL de Casdoor.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"client_id"),(0,r.kt)("td",{parentName:"tr",align:null},"cadena"),(0,r.kt)("td",{parentName:"tr",align:null},"requerido"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"El ID de cliente en Casdoor.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"client_secret"),(0,r.kt)("td",{parentName:"tr",align:null},"cadena"),(0,r.kt)("td",{parentName:"tr",align:null},"requerido"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"El secreto de cliente en Casdoor.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"callback_url"),(0,r.kt)("td",{parentName:"tr",align:null},"cadena"),(0,r.kt)("td",{parentName:"tr",align:null},"requerido"),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null}),(0,r.kt)("td",{parentName:"tr",align:null},"La URL de callback que se utiliza para recibir el estado y el c\xf3digo.")))),(0,r.kt)("p",null,(0,r.kt)("em",{parentName:"p"},"endpoint_addr y callback_url no deben terminar con '/'")),(0,r.kt)("p",null,'En la configuraci\xf3n del plugin "authz-casdoor", podemos ver cuatro par\xe1metros.'),(0,r.kt)("p",null,'El primero es "callback_url". Esta es la URL de callback en OAuth2. Se debe enfatizar que esta URL de callback ',(0,r.kt)("strong",{parentName:"p"},'debe pertenecer al "uri" que especificaste para la ruta'),". Por ejemplo, en este ejemplo, ",(0,r.kt)("a",{parentName:"p",href:"http://localhost:9080/anything/callback"},"http://localhost:9080/anything/callback"),' obviamente pertenece a "/anything/*". Solo de esta manera, la visita hacia el callback_url puede ser interceptada y utilizada por el plugin (para que el plugin pueda obtener el c\xf3digo y el estado en OAuth2). La l\xf3gica del callback_url est\xe1 implementada completamente por el plugin, por lo que no hay necesidad de modificar el servidor para implementar este callback.'),(0,r.kt)("p",null,'El segundo par\xe1metro "endpoint_addr" es obviamente la URL de Casdoor. El tercer y cuarto par\xe1metros son "client_id" y "client_secret", los cuales puedes obtener de Casdoor cuando registras una aplicaci\xf3n.'),(0,r.kt)("h3",{id:"c\xf3mo-funciona"},"\xbfC\xf3mo funciona?"),(0,r.kt)("p",null,"Supongamos que un nuevo usuario que nunca ha visitado esta ruta antes va a visitarla (",(0,r.kt)("a",{parentName:"p",href:"http://localhost:9080/anything/d?param1=foo&param2=bar"},"http://localhost:9080/anything/d?param1=foo","\xb6","m2=bar"),'). Considerando que "authz-casdoor" est\xe1 habilitado, esta visita ser\xeda procesada por el plugin "authz-casdoor" primero. Despu\xe9s de verificar la sesi\xf3n y confirmar que este usuario no ha sido autenticado, la visita ser\xe1 interceptada. Con la URL original que el usuario quiere visitar conservada, ser\xe1n redirigidos a la p\xe1gina de inicio de sesi\xf3n de Casdoor.'),(0,r.kt)("p",null,'Despu\xe9s de iniciar sesi\xf3n exitosamente con un nombre de usuario y contrase\xf1a (o cualquier m\xe9todo que utilicen), Casdoor redirigir\xe1 a este usuario al "callback_url" con los par\xe1metros GET "code" y "state" especificados. Debido a que el "callback_url" es conocido por el plugin, cuando la visita hacia el "callback_url" sea interceptada esta vez, se activar\xe1 la l\xf3gica del "Authorization code Grant Flow" en OAuth2. Esto significa que el plugin solicitar\xe1 el token de acceso para confirmar si este usuario realmente ha iniciado sesi\xf3n. Despu\xe9s de esta confirmaci\xf3n, el plugin redirigir\xe1 a este usuario a la URL original que quer\xedan visitar, la cual fue conservada por nosotros previamente. El estado de inicio de sesi\xf3n tambi\xe9n se mantendr\xe1 en la sesi\xf3n.'),(0,r.kt)("p",null,"La pr\xf3xima vez que este usuario quiera visitar la URL detr\xe1s de esta ruta (por ejemplo, ",(0,r.kt)("a",{parentName:"p",href:"http://localhost:9080/anything/d"},"http://localhost:9080/anything/d"),"), despu\xe9s de descubrir que este usuario ha sido autenticado previamente, este plugin no redirigir\xe1 a este usuario m\xe1s. De esta manera, el usuario puede visitar lo que quiera bajo esta ruta sin ser interferido."),(0,r.kt)("h2",{id:"conectar-casdoor-a-trav\xe9s-del-plugin-oidc-de-apisix"},"Conectar Casdoor a trav\xe9s del plugin OIDC de APISIX"),(0,r.kt)("p",null,"Casdoor puede usar el protocolo OIDC para conectarse a APISIX, y este documento te mostrar\xe1 c\xf3mo hacerlo."),(0,r.kt)("p",null,"Los siguientes son algunos de los nombres utilizados en la configuraci\xf3n:"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"CASDOOR_HOSTNAME"),": Nombre de dominio o IP donde se despliega el servidor de Casdoor."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"APISIX_HOSTNAME"),": Nombre de dominio o IP donde se despliega APISIX."),(0,r.kt)("h3",{id:"paso-1-desplegar-casdoor-y-apisix"},"Paso 1: Desplegar Casdoor y APISIX"),(0,r.kt)("p",null,"Primero, despliega ",(0,r.kt)("a",{parentName:"p",href:"/docs/basic/server-installation"},"Casdoor")," y ",(0,r.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/apisix/installation-guide/"},"APISIX"),"."),(0,r.kt)("p",null,"Despu\xe9s de un despliegue exitoso, necesitas asegurarte:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Casdoor se puede iniciar sesi\xf3n y usar normalmente."),(0,r.kt)("li",{parentName:"ol"},"Establece el valor de ",(0,r.kt)("inlineCode",{parentName:"li"},"origin")," de Casdoor (conf/app.conf) a ",(0,r.kt)("inlineCode",{parentName:"li"},"CASDOOR_HOSTNAME"),". ",(0,r.kt)("img",{alt:"Casdoor conf",src:t(66496).Z,width:"1013",height:"448"}))),(0,r.kt)("h3",{id:"paso-2-configurar-la-aplicaci\xf3n-casdoor"},"Paso 2: Configurar la aplicaci\xf3n Casdoor"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Crea una nueva aplicaci\xf3n Casdoor o usa una existente."),(0,r.kt)("li",{parentName:"ol"},"A\xf1ade una URL de redirecci\xf3n: ",(0,r.kt)("inlineCode",{parentName:"li"},"http://APISIX_HOSTNAME/REDIRECTWHATYOUWANT"),", y reemplaza ",(0,r.kt)("inlineCode",{parentName:"li"},"REDIRECTWHATYOUWANT")," con la URL de redirecci\xf3n deseada."),(0,r.kt)("li",{parentName:"ol"},'Selecciona "JWT-Empty" para la opci\xf3n de formato de Token.'),(0,r.kt)("li",{parentName:"ol"},"A\xf1ade el proveedor deseado y configura otros ajustes.")),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Configuraci\xf3n de la Aplicaci\xf3n",src:t(19654).Z,width:"2103",height:"538"})," En la p\xe1gina de configuraci\xf3n de la aplicaci\xf3n, encontrar\xe1s los valores de ",(0,r.kt)("inlineCode",{parentName:"p"},"Client ID")," y ",(0,r.kt)("inlineCode",{parentName:"p"},"Client Secret")," como se muestra en la imagen de arriba. Los usaremos en el siguiente paso."),(0,r.kt)("p",null,"Abre tu navegador favorito y visita: ",(0,r.kt)("strong",{parentName:"p"},"http://",(0,r.kt)("inlineCode",{parentName:"strong"},"CASDOOR_HOSTNAME"),"/.well-known/openid-configuration"),", donde encontrar\xe1s la configuraci\xf3n OIDC de Casdoor."),(0,r.kt)("h3",{id:"paso-3-configurar-apisix"},"Paso 3: Configurar APISIX"),(0,r.kt)("p",null,"APISIX tiene soporte oficial de ",(0,r.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/apisix/plugins/openid-connect/"},"OIDC"),", que se implementa usando ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/zmartzone/lua-resty-openidc"},"lua-resty-openidc"),"."),(0,r.kt)("p",null,"Puedes personalizar los ajustes de acuerdo con la documentaci\xf3n OIDC de APISIX. Se utilizar\xe1n los siguientes ajustes de enrutamiento:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'# Use your own X-Api-Key\n$ curl -X POST APISIX_HOSTNAME/apisix/admin/routes -H "X-Api-Key: edd1c9f034335f136f87ad84b625c8f1" -d \'{\n  "uri": "/get",\n  "name": "apisix_casdoor_test",\n  "plugins": {\n    "openid-connect": {\n      "client_id": "Client ID",\n      "client_secret": "Client Secret",\n      "discovery": "http://CASDOOR_HOSTNAME/.well-known/openid-configuration",\n      "introspection_endpoint_auth_method": "client_secret_basic",\n      "logout_path": "/logout",\n      "realm": "master",\n      "redirect_uri": "http://APISIX_HOSTNAME/REDIRECTWHATYOUWANT",\n      "bearer_only": false,\n      "set_id_token_header": false,\n      "access_token_in_authorization_header": true,\n      "set_access_token_header": true,\n      "set_userinfo_header": false,\n      "realm": "master"\n    }\n  },\n  "upstream": {\n    "type": "roundrobin",\n    "nodes": {\n      "httpbin.org:80": 1\n    }\n  }\n}\'\n')),(0,r.kt)("p",null,"Ahora, visita ",(0,r.kt)("inlineCode",{parentName:"p"},"http://APISIX_HOSTNAME/get"),", y el navegador te redirigir\xe1 a la p\xe1gina de inicio de sesi\xf3n de Casdoor. Despu\xe9s de iniciar sesi\xf3n exitosamente, ver\xe1s que se ha enviado una solicitud a httpbin.org como se muestra en la captura de pantalla a continuaci\xf3n. ",(0,r.kt)("img",{alt:"APISIX_Result",src:t(37695).Z,width:"2209",height:"1648"})))}p.isMDXComponent=!0},66496:(e,a,t)=>{t.d(a,{Z:()=>n});const n=t.p+"assets/images/casdoor_origin-8f5d9e44f6b58828ce69e6e6d896e122.png"},37695:(e,a,t)=>{t.d(a,{Z:()=>n});const n=t.p+"assets/images/apisix_result-3475043d31a06fd90894e80e8b4ca9f3.png"},19654:(e,a,t)=>{t.d(a,{Z:()=>n});const n=t.p+"assets/images/casdoor_jwtempty-68f57615f6dc135f498b45e6b2d7bf57.png"}}]);