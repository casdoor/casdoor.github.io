"use strict";(self.webpackChunkcasdoor_website=self.webpackChunkcasdoor_website||[]).push([[2720],{19060:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>d,frontMatter:()=>o,metadata:()=>s,toc:()=>p});var i=n(87462),r=(n(67294),n(3905));n(61839);const o={title:"Spring Security Filter",description:"Based on Spring Security Filter, how to use OIDC to connect your application.",keywords:["OIDC","Spirng Security","Spring Security Filter","Filter"]},a=void 0,s={unversionedId:"integration/spring-security/spring-security-filter",id:"integration/spring-security/spring-security-filter",title:"Spring Security Filter",description:"Based on Spring Security Filter, how to use OIDC to connect your application.",source:"@site/docs/integration/spring-security/spring-security-filter.md",sourceDirName:"integration/spring-security",slug:"/integration/spring-security/spring-security-filter",permalink:"/docs/integration/spring-security/spring-security-filter",draft:!1,editUrl:"https://github.com/casdoor/casdoor-website/edit/master/docs/integration/spring-security/spring-security-filter.md",tags:[],version:"current",lastUpdatedBy:"YunShu",lastUpdatedAt:1663164311,formattedLastUpdatedAt:"Sep 14, 2022",frontMatter:{title:"Spring Security Filter",description:"Based on Spring Security Filter, how to use OIDC to connect your application.",keywords:["OIDC","Spirng Security","Spring Security Filter","Filter"]},sidebar:"tutorialSidebar",previous:{title:"Spring Security OAuth",permalink:"/docs/integration/spring-security/spring-security-oauth"},next:{title:"RuoYi",permalink:"/docs/integration/RuoYi"}},l={},p=[{value:"Step1. Deploy Casdoor",id:"step1-deploy-casdoor",level:2},{value:"Step2. Configure Casdoor application",id:"step2-configure-casdoor-application",level:2},{value:"Step3. Configure Spring Security",id:"step3-configure-spring-security",level:2},{value:"Step4. Configure Frontend",id:"step4-configure-frontend",level:2},{value:"Step5. Get Started with A Demo",id:"step5-get-started-with-a-demo",level:2},{value:"Step6. Try the demo!",id:"step6-try-the-demo",level:2}],c={toc:p};function d(e){let{components:t,...o}=e;return(0,r.kt)("wrapper",(0,i.Z)({},c,o,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"Casdoor can use OIDC protocol as IDP to connect various applications. Here, we will use the filter in spring security to integrate casdoor and show you how to connect to the application using oidc."),(0,r.kt)("h2",{id:"step1-deploy-casdoor"},"Step1. Deploy Casdoor"),(0,r.kt)("p",null,"Firstly, the Casdoor should be deployed."),(0,r.kt)("p",null,"You can refer to the Casdoor official documentation for the ",(0,r.kt)("a",{parentName:"p",href:"/docs/basic/server-installation"},"Server Installation"),"."),(0,r.kt)("p",null,"After a successful deployment, you need to ensure:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The Casdoor server is successfully running on ",(0,r.kt)("strong",{parentName:"li"},"http://localhost:8000"),"."),(0,r.kt)("li",{parentName:"ul"},"Open your favorite browser and visit ",(0,r.kt)("strong",{parentName:"li"},"http://localhost:7001"),", you will see the login page of Casdoor."),(0,r.kt)("li",{parentName:"ul"},"Input ",(0,r.kt)("inlineCode",{parentName:"li"},"admin")," and ",(0,r.kt)("inlineCode",{parentName:"li"},"123")," to test login functionality is working fine.")),(0,r.kt)("p",null,"Then you can quickly implement a casdoor based login page in your own app with the following steps."),(0,r.kt)("h2",{id:"step2-configure-casdoor-application"},"Step2. Configure Casdoor application"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Create or use an existing Casdoor application."),(0,r.kt)("li",{parentName:"ol"},"Add Your redirect url (You can see more detials about how to get redirect url in the next section).\n",(0,r.kt)("img",{alt:"Casdoor Application Setting",src:n(61763).Z,width:"974",height:"935"})),(0,r.kt)("li",{parentName:"ol"},"On the certificate editing page, you can see your ",(0,r.kt)("inlineCode",{parentName:"li"},"Certificate"),".\n",(0,r.kt)("img",{alt:"Casdoor Certification Setting",src:n(54839).Z,width:"1726",height:"800"})),(0,r.kt)("li",{parentName:"ol"},"Add provider you want and supplement other settings.")),(0,r.kt)("p",null,"Not surprisingly, you can get these values on the application settings page: ",(0,r.kt)("inlineCode",{parentName:"p"},"Application Name"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"Organization Name"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"Redirect URL"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"Client ID "),", ",(0,r.kt)("inlineCode",{parentName:"p"},"Client Secret "),", ",(0,r.kt)("inlineCode",{parentName:"p"},"Certification"),". As shown above, we will use them in the next step."),(0,r.kt)("p",null,"Open your favorite browser and visit: ",(0,r.kt)("strong",{parentName:"p"},"http://",(0,r.kt)("inlineCode",{parentName:"strong"},"CASDOOR_HOSTNAME"),"/.well-known/openid-configuration"),", you will see the OIDC configure of Casdoor."),(0,r.kt)("h2",{id:"step3-configure-spring-security"},"Step3. Configure Spring Security"),(0,r.kt)("p",null,"You can customize the settings of spring security filter to process tokens:"),(0,r.kt)("admonition",{type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"You should replace the configuration with your own Casdoor instance especially the ",(0,r.kt)("inlineCode",{parentName:"p"},"<Client ID>")," and others.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yml"},"server:\n  port: 8080\ncasdoor:\n  endpoint: http://CASDOOR_HOSTNAME:8000\n  client-id: <Client ID>\n  client-secret: <Client Secret>\n  certificate: <Certificate>\n  organization-name: <Organization Name>\n  application-name: <Application Name>\n  redirect-url: http://FRONTEND_HOSTNAME/callback\n")),(0,r.kt)("admonition",{type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"For frontend applications, the default value of ",(0,r.kt)("inlineCode",{parentName:"p"},"<FRONTEND_HOSTNAME>")," is ",(0,r.kt)("inlineCode",{parentName:"p"},"localhost:3000"),"."),(0,r.kt)("p",{parentName:"admonition"},"For example, to the following demo, the redirect URL should be ",(0,r.kt)("inlineCode",{parentName:"p"},"http://localhost:3000/callback"),"."),(0,r.kt)("p",{parentName:"admonition"},"You should also configure this in ",(0,r.kt)("inlineCode",{parentName:"p"},"casdoor")," application.")),(0,r.kt)("h2",{id:"step4-configure-frontend"},"Step4. Configure Frontend"),(0,r.kt)("p",null,"You need to install ",(0,r.kt)("inlineCode",{parentName:"p"},"casdoor-js-sdk")," and configure ",(0,r.kt)("inlineCode",{parentName:"p"},"SDK"),"."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Install ",(0,r.kt)("inlineCode",{parentName:"p"},"casdoor-js-sdk"),"."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"npm i casdoor-js-sdk \n# or\nyarn add casdoor-js-sdk\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Set up ",(0,r.kt)("inlineCode",{parentName:"p"},"SDK"),"."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'import Sdk from "casdoor-js-sdk";\n\n// Serverurl is the URL where spring security is deployed\nexport const ServerUrl = "http://BACKEND_HOSTNAME:8080";\n\nconst sdkConfig = {\n  serverUrl: "http://CASDOOR_HOSTNAME:8000",\n  clientId: "<your client id>",\n  appName: "<your application name>",\n  organizationName: "<your organization name>",\n  redirectPath: "/callback",\n};\n\nexport const CasdoorSDK = new Sdk(sdkConfig);\n')))),(0,r.kt)("h2",{id:"step5-get-started-with-a-demo"},"Step5. Get Started with A Demo"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"We can create a Spring Boot application.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"We can add some configurations to handle JWT."))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'@EnableWebSecurity\npublic class SecurityConfig {\n\n    private final JwtTokenFilter jwtTokenFilter;\n\n    public SecurityConfig(JwtTokenFilter jwtTokenFilter) {\n        this.jwtTokenFilter = jwtTokenFilter;\n    }\n\n    @Bean\n    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {\n        // enable CORS and disable CSRF\n        http = http.cors(corsConfig -> corsConfig\n                .configurationSource(configurationSource())\n        ).csrf().disable();\n\n        // set session management to stateless\n        http = http\n                .sessionManagement()\n                .sessionCreationPolicy(SessionCreationPolicy.STATELESS)\n                .and();\n\n        // set permissions on endpoints\n        http.authorizeHttpRequests(authorize -> authorize\n                .mvcMatchers("/api/redirect-url", "/api/signin").permitAll()\n                .mvcMatchers("/api/**").authenticated()\n        );\n\n        // set unauthorized requests exception handler\n        http = http\n                .exceptionHandling()\n                .authenticationEntryPoint(\n                        (request, response, ex) -> ResponseUtils.fail(response, "unauthorized")\n                )\n                .and();\n\n        // add JWT token filter\n        http.addFilterBefore(\n                jwtTokenFilter,\n                UsernamePasswordAuthenticationFilter.class\n        );\n        return http.build();\n    }\n    \n    // ...\n\n}\n')),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},"We can add a simple JWT filter to intercept requests that need to verify tokens.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'@Component\npublic class JwtTokenFilter extends OncePerRequestFilter {\n\n    private final CasdoorAuthService casdoorAuthService;\n\n    public JwtTokenFilter(CasdoorAuthService casdoorAuthService) {\n        this.casdoorAuthService = casdoorAuthService;\n    }\n\n    @Override\n    protected void doFilterInternal(HttpServletRequest request,\n                                    HttpServletResponse response,\n                                    FilterChain chain)\n            throws ServletException, IOException {\n        // get authorization header and validate\n        final String header = request.getHeader(HttpHeaders.AUTHORIZATION);\n        if (!StringUtils.hasText(header) || !header.startsWith("Bearer ")) {\n            chain.doFilter(request, response);\n            return;\n        }\n\n        // get jwt token and validate\n        final String token = header.split(" ")[1].trim();\n\n        // get user identity and set it on the spring security context\n        UserDetails userDetails = null;\n        try {\n            CasdoorUser casdoorUser = casdoorAuthService.parseJwtToken(token);\n            userDetails = new CustomUserDetails(casdoorUser);\n        } catch (CasdoorAuthException exception) {\n            logger.error("casdoor auth exception", exception);\n            chain.doFilter(request, response);\n            return;\n        }\n\n        UsernamePasswordAuthenticationToken authentication = new UsernamePasswordAuthenticationToken(\n                userDetails,\n                null,\n                AuthorityUtils.createAuthorityList("ROLE_casdoor")\n        );\n\n        authentication.setDetails(\n                new WebAuthenticationDetailsSource().buildDetails(request)\n        );\n\n        SecurityContextHolder.getContext().setAuthentication(authentication);\n        chain.doFilter(request, response);\n    }\n\n}\n')),(0,r.kt)("p",null,"When the user accesses the interface requiring authentication, ",(0,r.kt)("inlineCode",{parentName:"p"},"JwtTokenFilter")," will obtain the token from the request header ",(0,r.kt)("inlineCode",{parentName:"p"},"Authorization")," and verify it."),(0,r.kt)("ol",{start:4},(0,r.kt)("li",{parentName:"ol"},"Next, we need to define a ",(0,r.kt)("inlineCode",{parentName:"li"},"Controller")," to handle that when the user login to the ",(0,r.kt)("inlineCode",{parentName:"li"},"casdoor"),", it will be redirected to the server and carry the ",(0,r.kt)("inlineCode",{parentName:"li"},"code")," and ",(0,r.kt)("inlineCode",{parentName:"li"},"state"),". The server needs to verify the user's identity from the ",(0,r.kt)("inlineCode",{parentName:"li"},"casdoor")," and obtain the ",(0,r.kt)("inlineCode",{parentName:"li"},"token")," through these two parameters.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-java"},'@RestController\npublic class UserController {\n\n    private static final Logger logger = LoggerFactory.getLogger(UserController.class);\n\n    private final CasdoorAuthService casdoorAuthService;\n    \n    // ...\n\n    @PostMapping("/api/signin")\n    public Result signin(@RequestParam("code") String code, @RequestParam("state") String state) {\n        try {\n            String token = casdoorAuthService.getOAuthToken(code, state);\n            return Result.success(token);\n        } catch (CasdoorAuthException exception) {\n            logger.error("casdoor auth exception", exception);\n            return Result.failure(exception.getMessage());\n        }\n    }\n    \n    // ...\n}\n')),(0,r.kt)("h2",{id:"step6-try-the-demo"},"Step6. Try the demo!"),(0,r.kt)("p",null,"First, you can try to access the frontend application through the browser. If you have not logged in, it will display a login button. Click the login button, and you will be redirected to the ",(0,r.kt)("inlineCode",{parentName:"p"},"casdoor")," login page."),(0,r.kt)("p",null,"If you visit your root page,\n",(0,r.kt)("img",{alt:"welcome",src:n(44078).Z,width:"1920",height:"942"})),(0,r.kt)("p",null,"Click the ",(0,r.kt)("inlineCode",{parentName:"p"},"Casdoor Login")," button and the page will redirect to casdoor's login page.\n",(0,r.kt)("img",{alt:"casdoor",src:n(91017).Z,width:"1920",height:"942"})),(0,r.kt)("p",null,"After you log in, the page will redirect to ",(0,r.kt)("inlineCode",{parentName:"p"},"/"),".\n",(0,r.kt)("img",{alt:"resource",src:n(13608).Z,width:"1920",height:"942"})))}d.isMDXComponent=!0},54839:(e,t,n)=>{n.d(t,{Z:()=>i});const i=n.p+"assets/images/casdoor_certification-fab3970e250b9e55213bb833f35f09d0.png"},61763:(e,t,n)=>{n.d(t,{Z:()=>i});const i=n.p+"assets/images/casdoor_setting-fca4ce21a48b644d6bbe251ca27271b7.png"},91017:(e,t,n)=>{n.d(t,{Z:()=>i});const i=n.p+"assets/images/spring_security_filter_casdoor-cd320a7fc7fb2a735740d4a57d56e7d8.png"},13608:(e,t,n)=>{n.d(t,{Z:()=>i});const i=n.p+"assets/images/spring_security_filter_resource-1095701ba0a994c50e87885b53e22a77.png"},44078:(e,t,n)=>{n.d(t,{Z:()=>i});const i=n.p+"assets/images/spring_security_filter_welcome-3258334efe51769aea33778f46287a78.png"}}]);