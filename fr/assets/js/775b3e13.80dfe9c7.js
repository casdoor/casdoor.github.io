"use strict";(self.webpackChunkcasdoor_website=self.webpackChunkcasdoor_website||[]).push([[3482],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>c});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),p=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},d=function(e){var t=p(e.components);return a.createElement(l.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),u=p(n),c=r,f=u["".concat(l,".").concat(c)]||u[c]||m[c]||i;return n?a.createElement(f,o(o({ref:t},d),{},{components:n})):a.createElement(f,o({ref:t},d))}));function c(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var p=2;p<i;p++)o[p]=n[p];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},52625:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>m,frontMatter:()=>i,metadata:()=>s,toc:()=>p});var a=n(87462),r=(n(67294),n(3905));const i={title:"Aper\xe7u",description:"Utilisation de Casdoor comme IdP SAML",keywords:["SAML","IdP"]},o=void 0,s={unversionedId:"how-to-connect/saml/overview",id:"how-to-connect/saml/overview",title:"Aper\xe7u",description:"Utilisation de Casdoor comme IdP SAML",source:"@site/i18n/fr/docusaurus-plugin-content-docs/current/how-to-connect/saml/overview.md",sourceDirName:"how-to-connect/saml",slug:"/how-to-connect/saml/overview",permalink:"/fr/docs/how-to-connect/saml/overview",draft:!1,editUrl:"https://github.com/casdoor/casdoor-website/edit/master/docs/how-to-connect/saml/overview.md",tags:[],version:"current",frontMatter:{title:"Aper\xe7u",description:"Utilisation de Casdoor comme IdP SAML",keywords:["SAML","IdP"]},sidebar:"tutorialSidebar",previous:{title:"SAML",permalink:"/fr/docs/category/saml"},next:{title:"AWS Client VPN",permalink:"/fr/docs/how-to-connect/saml/aws"}},l={},p=[{value:"Configuration dans le SP",id:"configuration-dans-le-sp",level:3},{value:"Configuration dans Casdoor IdP",id:"configuration-dans-casdoor-idp",level:3},{value:"SAML attributes",id:"saml-attributes",level:3},{value:"Profil utilisateur",id:"profil-utilisateur",level:3},{value:"Un exemple",id:"un-exemple",level:3}],d={toc:p};function m(e){let{components:t,...i}=e;return(0,r.kt)("wrapper",(0,a.Z)({},d,i,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"Casdoor peut maintenant \xeatre utilis\xe9 comme IdP SAML. Jusqu'\xe0 pr\xe9sent, Casdoor a pris en charge les principales fonctionnalit\xe9s de SAML 2.0."),(0,r.kt)("h3",{id:"configuration-dans-le-sp"},"Configuration dans le SP"),(0,r.kt)("p",null,"En g\xe9n\xe9ral, le SP n\xe9cessite trois champs obligatoires : ",(0,r.kt)("inlineCode",{parentName:"p"},"Single Sign-On"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"Issuer")," et ",(0,r.kt)("inlineCode",{parentName:"p"},"Public Certificate"),". La plupart des SP peuvent obtenir ces champs en t\xe9l\xe9chargeant le fichier de m\xe9tadonn\xe9es XML ou l'URL des m\xe9tadonn\xe9es XML pour l'auto-compl\xe9tion."),(0,r.kt)("p",null,"Les m\xe9tadonn\xe9es du point de terminaison SAML dans Casdoor sont ",(0,r.kt)("inlineCode",{parentName:"p"},"<Endpoint of casdoor>/api/saml/metadata?application=admin/<application name>"),". Supposons que le point de terminaison de Casdoor soit ",(0,r.kt)("inlineCode",{parentName:"p"},"https://door.casdoor.com"),", et qu'il contienne une application appel\xe9e ",(0,r.kt)("inlineCode",{parentName:"p"},"app-built-in"),". L'endpoint des m\xe9tadonn\xe9es XML sera :"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"https://door.casdoor.com/api/saml/metadata?application=admin/app-built-in\n")),(0,r.kt)("p",null,"Vous pouvez \xe9galement trouver les m\xe9tadonn\xe9es dans la page d'\xe9dition de l'application. Cliquez sur le bouton pour copier l'URL et collez-la dans le navigateur pour t\xe9l\xe9charger les m\xe9tadonn\xe9es XML."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"m\xe9tadonn\xe9es",src:n(43587).Z,width:"1807",height:"505"})),(0,r.kt)("h3",{id:"configuration-dans-casdoor-idp"},"Configuration dans Casdoor IdP"),(0,r.kt)("p",null,"Casdoor prend en charge les requ\xeates GET et POST ",(0,r.kt)("inlineCode",{parentName:"p"},"SAMLResponse"),". Casdoor doit savoir quels types de requ\xeates le SP prend en charge lorsque Casdoor envoie la ",(0,r.kt)("inlineCode",{parentName:"p"},"SAMLResponse")," au SP. Vous devez configurer l'application dans Casdoor en fonction du type de ",(0,r.kt)("inlineCode",{parentName:"p"},"SAMLResponse")," pris en charge par votre SP."),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("p",{parentName:"admonition"},"Si vous remplissez l'URL de r\xe9ponse, Casdoor enverra la ",(0,r.kt)("inlineCode",{parentName:"p"},"SAMLResponse")," par requ\xeate ",(0,r.kt)("strong",{parentName:"p"},"POST"),". Si l'URL de r\xe9ponse est vide, Casdoor utilisera la requ\xeate ",(0,r.kt)("strong",{parentName:"p"},"GET"),". Vous vous demandez peut-\xeatre comment Casdoor conna\xeet l'URL de r\xe9ponse du SP si l'URL de r\xe9ponse est vide. En fait, Casdoor peut obtenir l'URL appel\xe9e ",(0,r.kt)("inlineCode",{parentName:"p"},"AssertionConsumerServiceURL")," en analysant la ",(0,r.kt)("inlineCode",{parentName:"p"},"SAMLRequest")," et envoyer la requ\xeate avec ",(0,r.kt)("inlineCode",{parentName:"p"},"SAMLResponse")," \xe0 ",(0,r.kt)("inlineCode",{parentName:"p"},"AssertionConsumerServiceURL"),". L'URL de r\xe9ponse \xe9crasera l'",(0,r.kt)("inlineCode",{parentName:"p"},"AssertionConsumerServiceURL")," dans la ",(0,r.kt)("inlineCode",{parentName:"p"},"SAMLRequest"),".")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"URL de r\xe9ponse")," : Tapez l'URL de l'ACS v\xe9rifiant la r\xe9ponse SAML."),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{alt:"URL de r\xe9ponse",src:n(73524).Z,width:"727",height:"251"}))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"URL de redirection")," : Tapez un nom unique. Cela peut \xeatre appel\xe9 ",(0,r.kt)("inlineCode",{parentName:"p"},"Audience")," ou ",(0,r.kt)("inlineCode",{parentName:"p"},"Entity ID")," dans votre SP. Assurez-vous de remplir la m\xeame ",(0,r.kt)("inlineCode",{parentName:"p"},"URL de redirection")," ici que dans votre SP."),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{alt:"Entity ID",src:n(21605).Z,width:"743",height:"229"})))),(0,r.kt)("h3",{id:"saml-attributes"},"SAML attributes"),(0,r.kt)("p",null,"Some SP will require you to provide external attributes in SAML Response, you can add those in SAML attributes table. And you can insert user's field to it."),(0,r.kt)("p",null,"For examle"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:"center"},"Nom"),(0,r.kt)("th",{parentName:"tr",align:"center"},"Name format"),(0,r.kt)("th",{parentName:"tr",align:"center"},"Value"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"center"},(0,r.kt)("inlineCode",{parentName:"td"},"https://www.aliyun.com/SAML-Role/Attributes/RoleSessionName")),(0,r.kt)("td",{parentName:"tr",align:"center"},"Unspecified"),(0,r.kt)("td",{parentName:"tr",align:"center"},(0,r.kt)("inlineCode",{parentName:"td"},"$user.name"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"center"},(0,r.kt)("inlineCode",{parentName:"td"},"https://www.aliyun.com/SAML-Role/Attributes/Role")),(0,r.kt)("td",{parentName:"tr",align:"center"},"Unspecified"),(0,r.kt)("td",{parentName:"tr",align:"center"},(0,r.kt)("inlineCode",{parentName:"td"},"acs:ram::1879818006829152:role/$user.roles,acs:ram::1879818006829152:saml-provider/testa"))))),(0,r.kt)("p",null,"will generate response with external ",(0,r.kt)("inlineCode",{parentName:"p"},"saml:Attribute")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-xml"},'<saml:Attribute Name="https://www.aliyun.com/SAML-Role/Attributes/RoleSessionName" NameFormat="urn:oasis:names:tc:SAML:2.0:attrname-format:unspecified">\n    <saml:AttributeValue xsi:type="xs:string">admi122n@outlook.com</saml:AttributeValue>\n</saml:Attribute>\n<saml:Attribute Name="https://www.aliyun.com/SAML-Role/Attributes/Role" NameFormat="urn:oasis:names:tc:SAML:2.0:attrname-format:unspecified">\n    <saml:AttributeValue xsi:type="xs:string"> acs:ram::1879818006829152:role/role1,acs:ram::1879818006829152:saml-provider/testa</saml:AttributeValue>\n    <saml:AttributeValue xsi:type="xs:string"> acs:ram::1879818006829152:role/role2,acs:ram::1879818006829152:saml-provider/testa</saml:AttributeValue>\n</saml:Attribute>\n')),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("p",{parentName:"admonition"},"We only support insert ",(0,r.kt)("inlineCode",{parentName:"p"},"$user.owner"),",",(0,r.kt)("inlineCode",{parentName:"p"},"$user.name"),",",(0,r.kt)("inlineCode",{parentName:"p"},"$user.email"),",",(0,r.kt)("inlineCode",{parentName:"p"},"$user.id"),",",(0,r.kt)("inlineCode",{parentName:"p"},"$user.phone"),",",(0,r.kt)("inlineCode",{parentName:"p"},"$user.roles"),",",(0,r.kt)("inlineCode",{parentName:"p"},"$user.permissions"),",",(0,r.kt)("inlineCode",{parentName:"p"},"$user.groups"))),(0,r.kt)("h3",{id:"profil-utilisateur"},"Profil utilisateur"),(0,r.kt)("p",null,"Apr\xe8s une connexion r\xe9ussie, le profil utilisateur dans la ",(0,r.kt)("inlineCode",{parentName:"p"},"SAMLResponse")," retourn\xe9e de Casdoor a trois champs. Les attributs dans le XML et les attributs de l'utilisateur dans Casdoor sont mapp\xe9s comme suit :"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:"center"},"Nom d'attribut XML"),(0,r.kt)("th",{parentName:"tr",align:"center"},"Champ utilisateur"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"center"},"Email"),(0,r.kt)("td",{parentName:"tr",align:"center"},"email")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"center"},"DisplayName"),(0,r.kt)("td",{parentName:"tr",align:"center"},"displayName")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"center"},"Name"),(0,r.kt)("td",{parentName:"tr",align:"center"},"name")))),(0,r.kt)("p",null,"Voir ",(0,r.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/SAML_2.0"},"https://en.wikipedia.org/wiki/SAML_2.0")," pour plus d'informations sur SAML et ses diff\xe9rentes versions."),(0,r.kt)("h3",{id:"un-exemple"},"Un exemple"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/russellhaering/gosaml2"},"gosaml2")," est une impl\xe9mentation de SAML 2.0 pour les fournisseurs de services bas\xe9e sur etree et goxmldsig, une impl\xe9mentation pure Go des signatures num\xe9riques XML. Nous utilisons cette biblioth\xe8que pour tester SAML 2.0 dans Casdoor comme indiqu\xe9 ci-dessous."),(0,r.kt)("p",null,"Supposons que vous pouvez acc\xe9der \xe0 Casdoor via ",(0,r.kt)("inlineCode",{parentName:"p"},"http://localhost:7001/"),", et que votre Casdoor contient une application appel\xe9e ",(0,r.kt)("inlineCode",{parentName:"p"},"app-built-in"),", qui appartient \xe0 une organisation appel\xe9e ",(0,r.kt)("inlineCode",{parentName:"p"},"built-in"),". Les URL, ",(0,r.kt)("inlineCode",{parentName:"p"},"http://localhost:6900/acs/example")," et ",(0,r.kt)("inlineCode",{parentName:"p"},"http://localhost:6900/saml/acs/example"),", doivent \xeatre ajout\xe9es aux URL de redirection dans ",(0,r.kt)("inlineCode",{parentName:"p"},"app-built-in"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'import (\n    "crypto/x509"\n    "fmt"\n    "net/http"\n\n    "io/ioutil"\n\n    "encoding/base64"\n    "encoding/xml"\n\n    saml2 "github.com/russellhaering/gosaml2"\n    "github.com/russellhaering/gosaml2/types"\n    dsig "github.com/russellhaering/goxmldsig"\n)\n\nfunc main() {\n    res, err := http.Get("http://localhost:7001/api/saml/metadata?application=admin/app-built-in")\n    if err != nil {\n        panic(err)\n    }\n\n    rawMetadata, err := ioutil.ReadAll(res.Body)\n    if err != nil {\n        panic(err)\n    }\n\n    metadata := &types.EntityDescriptor{}\n    err = xml.Unmarshal(rawMetadata, metadata)\n    if err != nil {\n        panic(err)\n    }\n\n    certStore := dsig.MemoryX509CertificateStore{\n        Roots: []*x509.Certificate{},\n    }\n\n    for _, kd := range metadata.IDPSSODescriptor.KeyDescriptors {\n        for idx, xcert := range kd.KeyInfo.X509Data.X509Certificates {\n            if xcert.Data == "" {\n                panic(fmt.Errorf("metadata certificate(%d) must not be empty", idx))\n            }\n            certData, err := base64.StdEncoding.DecodeString(xcert.Data)\n            if err != nil {\n                panic(err)\n            }\n\n            idpCert, err := x509.ParseCertificate(certData)\n            if err != nil {\n                panic(err)\n            }\n\n            certStore.Roots = append(certStore.Roots, idpCert)\n        }\n    }\n\n    randomKeyStore := dsig.RandomKeyStoreForTest()\n\n    sp := &saml2.SAMLServiceProvider{\n        IdentityProviderSSOURL:      metadata.IDPSSODescriptor.SingleSignOnServices[0].Location,\n        IdentityProviderIssuer:      metadata.EntityID,\n        ServiceProviderIssuer:       "http://localhost:6900/acs/example",\n        AssertionConsumerServiceURL: "http://localhost:6900/v1/_saml_callback",\n        SignAuthnRequests:           true,\n        AudienceURI:                 "http://localhost:6900/saml/acs/example",\n        IDPCertificateStore:         &certStore,\n        SPKeyStore:                  randomKeyStore,\n    }\n\n    http.HandleFunc("/v1/_saml_callback", func(rw http.ResponseWriter, req *http.Request) {\n        err := req.ParseForm()\n        if err != nil {\n            rw.WriteHeader(http.StatusBadRequest)\n            return\n        }\n        samlReponse := req.URL.Query().Get("SAMLResponse")\n        assertionInfo, err := sp.RetrieveAssertionInfo(samlReponse)\n        if err != nil {\n            fmt.Println(err)\n            rw.WriteHeader(http.StatusForbidden)\n            return\n        }\n        fmt.Println(assertionInfo)\n        if assertionInfo.WarningInfo.InvalidTime {\n            fmt.Println("here12:", assertionInfo.WarningInfo.InvalidTime)\n            rw.WriteHeader(http.StatusForbidden)\n            return\n        }\n\n        if assertionInfo.WarningInfo.NotInAudience {\n            fmt.Println(assertionInfo)\n            fmt.Println("here13:", assertionInfo.WarningInfo.NotInAudience)\n            rw.WriteHeader(http.StatusForbidden)\n            return\n        }\n\n        fmt.Fprintf(rw, "NameID: %s\\n", assertionInfo.NameID)\n\n        fmt.Fprintf(rw, "Assertions:\\n")\n\n        for key, val := range assertionInfo.Values {\n            fmt.Fprintf(rw, "  %s: %+v\\n", key, val)\n        }\n        fmt.Println(assertionInfo.Values.Get("FirstName"))\n        fmt.Fprintf(rw, "\\n")\n\n        fmt.Fprintf(rw, "Warnings:\\n")\n        fmt.Fprintf(rw, "%+v\\n", assertionInfo.WarningInfo)\n    })\n\n    println("Visit this URL To Authenticate:")\n    authURL, err := sp.BuildAuthURL("")\n    if err != nil {\n        panic(err)\n    }\n\n    println(authURL)\n\n    println("Supply:")\n    fmt.Printf("  SP ACS URL      : %s\\n", sp.AssertionConsumerServiceURL)\n\n    err = http.ListenAndServe(":6900", nil)\n    if err != nil {\n        panic(err)\n    }\n}\n')),(0,r.kt)("p",null,"Ex\xe9cutez le code ci-dessus, et la console affichera le message suivant."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"Visit this URL To Authenticate:\nhttp://localhost:7001/login/saml/authorize/admin/app-built-in?SAMLRequest=lFVbk6K8Fv0rFvNo2QR...\nSupply:\n  SP ACS URL      : http://localhost:6900/v1/_saml_callback\n")),(0,r.kt)("p",null,"Cliquez sur l'URL pour vous authentifier, et la page de connexion de Casdoor s'affichera."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"connexion",src:n(80683).Z,width:"2560",height:"1462"})),(0,r.kt)("p",null,"Apr\xe8s authentification, vous recevrez les messages de r\xe9ponse comme indiqu\xe9 ci-dessous."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"r\xe9ponse",src:n(94139).Z,width:"2560",height:"375"})))}m.isMDXComponent=!0},21605:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/saml_entityId-02cf13e2debc60f1c7babe47bb443cbf.png"},80683:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/saml_login-bf1964a645b97ac59818a2d352a733aa.png"},43587:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/saml_metadata-0511209f4c6ccd88259d4438388eadae.png"},73524:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/saml_replyURL-54e1796b344daaab144af1999228412e.png"},94139:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/saml_response-b3ad831adea4c2d5b78f6ffa5e410ab6.png"}}]);