"use strict";(self.webpackChunkcasdoor_website=self.webpackChunkcasdoor_website||[]).push([[9927],{3905:(e,a,t)=>{t.d(a,{Zo:()=>d,kt:()=>m});var o=t(67294);function n(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}function r(e,a){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);a&&(o=o.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),t.push.apply(t,o)}return t}function i(e){for(var a=1;a<arguments.length;a++){var t=null!=arguments[a]?arguments[a]:{};a%2?r(Object(t),!0).forEach((function(a){n(e,a,t[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))}))}return e}function l(e,a){if(null==e)return{};var t,o,n=function(e,a){if(null==e)return{};var t,o,n={},r=Object.keys(e);for(o=0;o<r.length;o++)t=r[o],a.indexOf(t)>=0||(n[t]=e[t]);return n}(e,a);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)t=r[o],a.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(n[t]=e[t])}return n}var s=o.createContext({}),p=function(e){var a=o.useContext(s),t=a;return e&&(t="function"==typeof e?e(a):i(i({},a),e)),t},d=function(e){var a=p(e.components);return o.createElement(s.Provider,{value:a},e.children)},c={inlineCode:"code",wrapper:function(e){var a=e.children;return o.createElement(o.Fragment,{},a)}},u=o.forwardRef((function(e,a){var t=e.components,n=e.mdxType,r=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),u=p(t),m=n,g=u["".concat(s,".").concat(m)]||u[m]||c[m]||r;return t?o.createElement(g,i(i({ref:a},d),{},{components:t})):o.createElement(g,i({ref:a},d))}));function m(e,a){var t=arguments,n=a&&a.mdxType;if("string"==typeof e||n){var r=t.length,i=new Array(r);i[0]=u;var l={};for(var s in a)hasOwnProperty.call(a,s)&&(l[s]=a[s]);l.originalType=e,l.mdxType="string"==typeof e?e:n,i[1]=l;for(var p=2;p<r;p++)i[p]=t[p];return o.createElement.apply(null,i)}return o.createElement.apply(null,t)}u.displayName="MDXCreateElement"},9213:(e,a,t)=>{t.r(a),t.d(a,{assets:()=>s,contentTitle:()=>i,default:()=>c,frontMatter:()=>r,metadata:()=>l,toc:()=>p});var o=t(87462),n=(t(67294),t(3905));const r={title:"APISIX",description:"Usando o Casdoor no APISIX",keywords:["APISIX"],authors:["Steve0x2a"]},i=void 0,l={unversionedId:"integration/lua/apisix",id:"integration/lua/apisix",title:"APISIX",description:"Usando o Casdoor no APISIX",source:"@site/i18n/pt/docusaurus-plugin-content-docs/current/integration/lua/apisix.md",sourceDirName:"integration/lua",slug:"/integration/lua/apisix",permalink:"/pt/docs/integration/lua/apisix",draft:!1,editUrl:"https://github.com/casdoor/casdoor-website/edit/master/docs/integration/lua/apisix.md",tags:[],version:"current",frontMatter:{title:"APISIX",description:"Usando o Casdoor no APISIX",keywords:["APISIX"],authors:["Steve0x2a"]},sidebar:"tutorialSidebar",previous:{title:"Lua",permalink:"/pt/docs/category/lua"},next:{title:"PHP",permalink:"/pt/docs/category/php"}},s={},p=[{value:"Conecte o Casdoor via plugin Casdoor do APISIX",id:"conecte-o-casdoor-via-plugin-casdoor-do-apisix",level:2},{value:"Como habilit\xe1-lo",id:"como-habilit\xe1-lo",level:3},{value:"Atributos",id:"atributos",level:3},{value:"Como funciona?",id:"como-funciona",level:3},{value:"Conecte o Casdoor via plugin OIDC do APISIX",id:"conecte-o-casdoor-via-plugin-oidc-do-apisix",level:2},{value:"Etapa 1: Implante o Casdoor e o APISIX",id:"etapa-1-implante-o-casdoor-e-o-apisix",level:3},{value:"Etapa 2: Configurar aplicativo Casdoor",id:"etapa-2-configurar-aplicativo-casdoor",level:3},{value:"Etapa 3: Configurar APISIX",id:"etapa-3-configurar-apisix",level:3}],d={toc:p};function c(e){let{components:a,...r}=e;return(0,n.kt)("wrapper",(0,o.Z)({},d,r,{components:a,mdxType:"MDXLayout"}),(0,n.kt)("p",null,"Atualmente, existem 2 m\xe9todos para usar o Casdoor para se conectar ao APISIX via plugins do APISIX e proteger as APIs por tr\xe1s do APISIX: usando o plugin Casdoor do APISIX ou usando o plugin OIDC do APISIX."),(0,n.kt)("h2",{id:"conecte-o-casdoor-via-plugin-casdoor-do-apisix"},"Conecte o Casdoor via plugin Casdoor do APISIX"),(0,n.kt)("p",null,"Este plugin, ",(0,n.kt)("inlineCode",{parentName:"p"},"authz-casdoor"),", pode proteger APIs por tr\xe1s do APISIX, for\xe7ando cada solicita\xe7\xe3o a ser autenticada sem modificar o c\xf3digo da API."),(0,n.kt)("h3",{id:"como-habilit\xe1-lo"},"Como habilit\xe1-lo"),(0,n.kt)("p",null,"Voc\xea precisa especificar este plugin ao criar a rota e fornecer todos os campos necess\xe1rios. Aqui est\xe1 um exemplo."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-shell"},'curl "http://127.0.0.1:9180/apisix/admin/routes/1" -H "X-API-KEY: edd1c9f034335f136f87ad84b625c8f1" -X PUT -d \'\n{\n  "methods": ["GET"],\n  "uri": "/anything/*",\n  "plugins": {\n    "authz-casdoor": {\n        "endpoint_addr":"http://localhost:8000",\n        "callback_url":"http://localhost:9080/anything/callback",\n        "client_id":"7ceb9b7fda4a9061ec1c",\n        "client_secret":"3416238e1edf915eac08b8fe345b2b95cdba7e04"\n    }\n  },\n  "upstream": {\n    "type": "roundrobin",\n    "nodes": {\n      "httpbin.org:80": 1\n    }\n  }\n}\'\n')),(0,n.kt)("p",null,'Neste exemplo, criamos uma rota "/anything/*" apontada para "httpbin.org:80" usando a API de administra\xe7\xe3o do APISIX, com o plugin "authz-casdoor" habilitado. Esta rota agora est\xe1 sob a prote\xe7\xe3o de autentica\xe7\xe3o do Casdoor.'),(0,n.kt)("h3",{id:"atributos"},"Atributos"),(0,n.kt)("table",null,(0,n.kt)("thead",{parentName:"table"},(0,n.kt)("tr",{parentName:"thead"},(0,n.kt)("th",{parentName:"tr",align:null},"Nome"),(0,n.kt)("th",{parentName:"tr",align:null},"Tipo"),(0,n.kt)("th",{parentName:"tr",align:null},"Requisito"),(0,n.kt)("th",{parentName:"tr",align:null},"Padr\xe3o"),(0,n.kt)("th",{parentName:"tr",align:null},"V\xe1lido"),(0,n.kt)("th",{parentName:"tr",align:null},"Descri\xe7\xe3o"))),(0,n.kt)("tbody",{parentName:"table"},(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:null},"endpoint_addr"),(0,n.kt)("td",{parentName:"tr",align:null},"string"),(0,n.kt)("td",{parentName:"tr",align:null},"obrigat\xf3rio"),(0,n.kt)("td",{parentName:"tr",align:null}),(0,n.kt)("td",{parentName:"tr",align:null}),(0,n.kt)("td",{parentName:"tr",align:null},"A URL do Casdoor.")),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:null},"client_id"),(0,n.kt)("td",{parentName:"tr",align:null},"string"),(0,n.kt)("td",{parentName:"tr",align:null},"obrigat\xf3rio"),(0,n.kt)("td",{parentName:"tr",align:null}),(0,n.kt)("td",{parentName:"tr",align:null}),(0,n.kt)("td",{parentName:"tr",align:null},"O ID do cliente no Casdoor.")),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:null},"client_secret"),(0,n.kt)("td",{parentName:"tr",align:null},"string"),(0,n.kt)("td",{parentName:"tr",align:null},"obrigat\xf3rio"),(0,n.kt)("td",{parentName:"tr",align:null}),(0,n.kt)("td",{parentName:"tr",align:null}),(0,n.kt)("td",{parentName:"tr",align:null},"O segredo do cliente no Casdoor.")),(0,n.kt)("tr",{parentName:"tbody"},(0,n.kt)("td",{parentName:"tr",align:null},"callback_url"),(0,n.kt)("td",{parentName:"tr",align:null},"string"),(0,n.kt)("td",{parentName:"tr",align:null},"obrigat\xf3rio"),(0,n.kt)("td",{parentName:"tr",align:null}),(0,n.kt)("td",{parentName:"tr",align:null}),(0,n.kt)("td",{parentName:"tr",align:null},"A URL de retorno que \xe9 usada para receber o estado e o c\xf3digo.")))),(0,n.kt)("p",null,(0,n.kt)("em",{parentName:"p"},"endpoint_addr e callback_url n\xe3o devem terminar com '/'")),(0,n.kt)("p",null,'Na configura\xe7\xe3o do plugin "authz-casdoor", podemos ver quatro par\xe2metros.'),(0,n.kt)("p",null,'O primeiro \xe9 "callback_url". Esta \xe9 a URL de retorno no OAuth2. Deve ser enfatizado que esta URL de retorno ',(0,n.kt)("strong",{parentName:"p"},'deve pertencer \xe0 "uri" que voc\xea especificou para a rota'),". Por exemplo, neste exemplo, ",(0,n.kt)("a",{parentName:"p",href:"http://localhost:9080/anything/callback"},"http://localhost:9080/anything/callback"),' obviamente pertence a "/anything/*". Somente desta forma, a visita \xe0 callback_url pode ser interceptada e utilizada pelo plugin (para que o plugin possa obter o c\xf3digo e o estado no OAuth2). A l\xf3gica da callback_url \xe9 implementada completamente pelo plugin, ent\xe3o n\xe3o h\xe1 necessidade de modificar o servidor para implementar este retorno.'),(0,n.kt)("p",null,'O segundo par\xe2metro "endpoint_addr" \xe9 obviamente a URL do Casdoor. O terceiro e quarto par\xe2metros s\xe3o "client_id" e "client_secret", que voc\xea pode obter do Casdoor ao registrar um aplicativo.'),(0,n.kt)("h3",{id:"como-funciona"},"Como funciona?"),(0,n.kt)("p",null,"Suponha que um novo usu\xe1rio que nunca visitou esta rota antes vai visit\xe1-la (",(0,n.kt)("a",{parentName:"p",href:"http://localhost:9080/anything/d?param1=foo&param2=bar"},"http://localhost:9080/anything/d?param1=foo","\xb6","m2=bar"),'). Considerando que "authz-casdoor" est\xe1 habilitado, esta visita seria processada primeiro pelo plugin "authz-casdoor". Ap\xf3s verificar a sess\xe3o e confirmar que este usu\xe1rio n\xe3o foi autenticado, a visita ser\xe1 interceptada. Com a URL original que o usu\xe1rio deseja visitar mantida, ele ser\xe1 redirecionado para a p\xe1gina de login do Casdoor.'),(0,n.kt)("p",null,'Ap\xf3s fazer login com sucesso com um nome de usu\xe1rio e senha (ou qualquer m\xe9todo que use), o Casdoor redirecionar\xe1 este usu\xe1rio para a "callback_url" com os par\xe2metros GET "code" e "state" especificados. Como a "callback_url" \xe9 conhecida pelo plugin, quando a visita \xe0 "callback_url" for interceptada desta vez, a l\xf3gica do "Authorization code Grant Flow" no OAuth2 ser\xe1 acionada. Isso significa que o plugin solicitar\xe1 o token de acesso para confirmar se este usu\xe1rio realmente fez login. Ap\xf3s essa confirma\xe7\xe3o, o plugin redirecionar\xe1 este usu\xe1rio para a URL original que ele deseja visitar, que foi mantida por n\xf3s anteriormente. O status de login tamb\xe9m ser\xe1 mantido na sess\xe3o.'),(0,n.kt)("p",null,"Na pr\xf3xima vez que este usu\xe1rio quiser visitar a URL por tr\xe1s desta rota (por exemplo, ",(0,n.kt)("a",{parentName:"p",href:"http://localhost:9080/anything/d"},"http://localhost:9080/anything/d"),"), ap\xf3s descobrir que este usu\xe1rio foi autenticado anteriormente, este plugin n\xe3o redirecionar\xe1 mais este usu\xe1rio. Desta forma, o usu\xe1rio pode visitar o que quiser sob esta rota sem ser interferido."),(0,n.kt)("h2",{id:"conecte-o-casdoor-via-plugin-oidc-do-apisix"},"Conecte o Casdoor via plugin OIDC do APISIX"),(0,n.kt)("p",null,"O Casdoor pode usar o protocolo OIDC para se conectar ao APISIX, e este documento mostrar\xe1 como fazer isso."),(0,n.kt)("p",null,"A seguir est\xe3o alguns dos nomes usados na configura\xe7\xe3o:"),(0,n.kt)("p",null,(0,n.kt)("inlineCode",{parentName:"p"},"CASDOOR_HOSTNAME"),": Nome de dom\xednio ou IP onde o servidor Casdoor est\xe1 implantado."),(0,n.kt)("p",null,(0,n.kt)("inlineCode",{parentName:"p"},"APISIX_HOSTNAME"),": Nome de dom\xednio ou IP onde o APISIX est\xe1 implantado."),(0,n.kt)("h3",{id:"etapa-1-implante-o-casdoor-e-o-apisix"},"Etapa 1: Implante o Casdoor e o APISIX"),(0,n.kt)("p",null,"Primeiramente, implante o ",(0,n.kt)("a",{parentName:"p",href:"/docs/basic/server-installation"},"Casdoor")," e o ",(0,n.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/apisix/installation-guide/"},"APISIX"),"."),(0,n.kt)("p",null,"Ap\xf3s uma implanta\xe7\xe3o bem-sucedida, voc\xea precisa garantir:"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"O Casdoor pode ser acessado e usado normalmente."),(0,n.kt)("li",{parentName:"ol"},"Defina o valor de ",(0,n.kt)("inlineCode",{parentName:"li"},"origin")," do Casdoor (conf/app.conf) para ",(0,n.kt)("inlineCode",{parentName:"li"},"CASDOOR_HOSTNAME"),". ",(0,n.kt)("img",{alt:"Configura\xe7\xe3o do Casdoor",src:t(66496).Z,width:"1013",height:"448"}))),(0,n.kt)("h3",{id:"etapa-2-configurar-aplicativo-casdoor"},"Etapa 2: Configurar aplicativo Casdoor"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"Crie um novo aplicativo Casdoor ou use um existente."),(0,n.kt)("li",{parentName:"ol"},"Adicione uma URL de redirecionamento: ",(0,n.kt)("inlineCode",{parentName:"li"},"http://APISIX_HOSTNAME/REDIRECTWHATYOUWANT"),", e substitua ",(0,n.kt)("inlineCode",{parentName:"li"},"REDIRECTWHATYOUWANT")," pela URL de redirecionamento desejada."),(0,n.kt)("li",{parentName:"ol"},'Selecione "JWT-Empty" para a op\xe7\xe3o de formato de Token.'),(0,n.kt)("li",{parentName:"ol"},"Adicione o provedor desejado e configure outras configura\xe7\xf5es.")),(0,n.kt)("p",null,(0,n.kt)("img",{alt:"Configura\xe7\xe3o do Aplicativo",src:t(19654).Z,width:"2103",height:"538"})," Na p\xe1gina de configura\xe7\xf5es do aplicativo, voc\xea encontrar\xe1 os valores de ",(0,n.kt)("inlineCode",{parentName:"p"},"Client ID")," e ",(0,n.kt)("inlineCode",{parentName:"p"},"Client Secret")," como mostrado na imagem acima. Usaremos eles na pr\xf3xima etapa."),(0,n.kt)("p",null,"Abra seu navegador favorito e visite: ",(0,n.kt)("strong",{parentName:"p"},"http://",(0,n.kt)("inlineCode",{parentName:"strong"},"CASDOOR_HOSTNAME"),"/.well-known/openid-configuration"),", onde voc\xea encontrar\xe1 a configura\xe7\xe3o OIDC do Casdoor."),(0,n.kt)("h3",{id:"etapa-3-configurar-apisix"},"Etapa 3: Configurar APISIX"),(0,n.kt)("p",null,"O APISIX tem suporte oficial para ",(0,n.kt)("a",{parentName:"p",href:"https://apisix.apache.org/docs/apisix/plugins/openid-connect/"},"OIDC"),", que \xe9 implementado usando ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/zmartzone/lua-resty-openidc"},"lua-resty-openidc"),"."),(0,n.kt)("p",null,"Voc\xea pode personalizar as configura\xe7\xf5es de acordo com a documenta\xe7\xe3o OIDC do APISIX. As seguintes configura\xe7\xf5es de roteamento ser\xe3o usadas:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-bash"},'# Use your own X-Api-Key\n$ curl -X POST APISIX_HOSTNAME/apisix/admin/routes -H "X-Api-Key: edd1c9f034335f136f87ad84b625c8f1" -d \'{\n  "uri": "/get",\n  "name": "apisix_casdoor_test",\n  "plugins": {\n    "openid-connect": {\n      "client_id": "Client ID",\n      "client_secret": "Client Secret",\n      "discovery": "http://CASDOOR_HOSTNAME/.well-known/openid-configuration",\n      "introspection_endpoint_auth_method": "client_secret_basic",\n      "logout_path": "/logout",\n      "realm": "master",\n      "redirect_uri": "http://APISIX_HOSTNAME/REDIRECTWHATYOUWANT",\n      "bearer_only": false,\n      "set_id_token_header": false,\n      "access_token_in_authorization_header": true,\n      "set_access_token_header": true,\n      "set_userinfo_header": false,\n      "realm": "master"\n    }\n  },\n  "upstream": {\n    "type": "roundrobin",\n    "nodes": {\n      "httpbin.org:80": 1\n    }\n  }\n}\'\n')),(0,n.kt)("p",null,"Agora, visite ",(0,n.kt)("inlineCode",{parentName:"p"},"http://APISIX_HOSTNAME/get"),", e o navegador ir\xe1 redirecion\xe1-lo para a p\xe1gina de login do Casdoor. Ap\xf3s fazer login com sucesso, voc\xea ver\xe1 que uma solicita\xe7\xe3o foi enviada para httpbin.org como mostrado na captura de tela abaixo. ",(0,n.kt)("img",{alt:"Resultado_APISIX",src:t(37695).Z,width:"2209",height:"1648"})))}c.isMDXComponent=!0},66496:(e,a,t)=>{t.d(a,{Z:()=>o});const o=t.p+"assets/images/casdoor_origin-8f5d9e44f6b58828ce69e6e6d896e122.png"},37695:(e,a,t)=>{t.d(a,{Z:()=>o});const o=t.p+"assets/images/apisix_result-3475043d31a06fd90894e80e8b4ca9f3.png"},19654:(e,a,t)=>{t.d(a,{Z:()=>o});const o=t.p+"assets/images/casdoor_jwtempty-68f57615f6dc135f498b45e6b2d7bf57.png"}}]);