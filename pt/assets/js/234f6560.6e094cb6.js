"use strict";(self.webpackChunkcasdoor_website=self.webpackChunkcasdoor_website||[]).push([[7277],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>m});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var p=a.createContext({}),l=function(e){var t=a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},c=function(e){var t=l(e.components);return a.createElement(p.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,p=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),u=l(n),m=r,g=u["".concat(p,".").concat(m)]||u[m]||d[m]||o;return n?a.createElement(g,i(i({ref:t},c),{},{components:n})):a.createElement(g,i({ref:t},c))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=u;var s={};for(var p in t)hasOwnProperty.call(t,p)&&(s[p]=t[p]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var l=2;l<o;l++)i[l]=n[l];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},65643:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>s,toc:()=>l});var a=n(87462),r=(n(67294),n(3905));const o={title:"Filtro de Seguran\xe7a Spring com integra\xe7\xe3o OIDC para Casdoor",description:"Este artigo explica como usar o Filtro de Seguran\xe7a Spring para conectar sua aplica\xe7\xe3o com Casdoor usando OIDC.",keywords:["OIDC","Spirng Security","Spring Security Filter","Filter","Casdoor"],authors:["wenxuan70"]},i=void 0,s={unversionedId:"integration/java/spring-security/spring-security-filter",id:"integration/java/spring-security/spring-security-filter",title:"Filtro de Seguran\xe7a Spring com integra\xe7\xe3o OIDC para Casdoor",description:"Este artigo explica como usar o Filtro de Seguran\xe7a Spring para conectar sua aplica\xe7\xe3o com Casdoor usando OIDC.",source:"@site/i18n/pt/docusaurus-plugin-content-docs/current/integration/java/spring-security/spring-security-filter.md",sourceDirName:"integration/java/spring-security",slug:"/integration/java/spring-security/spring-security-filter",permalink:"/pt/docs/integration/java/spring-security/spring-security-filter",draft:!1,editUrl:"https://github.com/casdoor/casdoor-website/edit/master/docs/integration/java/spring-security/spring-security-filter.md",tags:[],version:"current",frontMatter:{title:"Filtro de Seguran\xe7a Spring com integra\xe7\xe3o OIDC para Casdoor",description:"Este artigo explica como usar o Filtro de Seguran\xe7a Spring para conectar sua aplica\xe7\xe3o com Casdoor usando OIDC.",keywords:["OIDC","Spirng Security","Spring Security Filter","Filter","Casdoor"],authors:["wenxuan70"]},sidebar:"tutorialSidebar",previous:{title:"Spring Security OAuth",permalink:"/pt/docs/integration/java/spring-security/spring-security-oauth"},next:{title:"Plugin Jenkins",permalink:"/pt/docs/integration/java/jenkins-plugin"}},p={},l=[{value:"Passo 1: Implemente o Casdoor",id:"passo-1-implemente-o-casdoor",level:2},{value:"Passo 2: Configure a Aplica\xe7\xe3o Casdoor",id:"passo-2-configure-a-aplica\xe7\xe3o-casdoor",level:2},{value:"Passo 3: Configure o Spring Security",id:"passo-3-configure-o-spring-security",level:2},{value:"Passo 4: Configure o Frontend",id:"passo-4-configure-o-frontend",level:2},{value:"Passo 5: Configure uma Demonstra\xe7\xe3o",id:"passo-5-configure-uma-demonstra\xe7\xe3o",level:2},{value:"Passo 6: Experimente a Demonstra\xe7\xe3o",id:"passo-6-experimente-a-demonstra\xe7\xe3o",level:2}],c={toc:l};function d(e){let{components:t,...o}=e;return(0,r.kt)("wrapper",(0,a.Z)({},c,o,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"Casdoor \xe9 um IDP de c\xf3digo aberto que suporta OIDC e v\xe1rios outros protocolos. Neste artigo, veremos como integrar o Casdoor com sua aplica\xe7\xe3o usando o Filtro de Seguran\xe7a Spring e OIDC."),(0,r.kt)("h2",{id:"passo-1-implemente-o-casdoor"},"Passo 1: Implemente o Casdoor"),(0,r.kt)("p",null,"Primeiro, voc\xea precisa implementar o servidor Casdoor. Consulte a ",(0,r.kt)("a",{parentName:"p",href:"/docs/basic/server-installation"},"documenta\xe7\xe3o oficial")," para instru\xe7\xf5es de instala\xe7\xe3o do servidor. Ap\xf3s a implementa\xe7\xe3o bem-sucedida, certifique-se de que:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"O servidor Casdoor est\xe1 em execu\xe7\xe3o em ",(0,r.kt)("strong",{parentName:"li"},(0,r.kt)("a",{parentName:"strong",href:"http://localhost:8000"},"http://localhost:8000")),"."),(0,r.kt)("li",{parentName:"ul"},"Voc\xea pode ver a p\xe1gina de login do Casdoor em ",(0,r.kt)("strong",{parentName:"li"},(0,r.kt)("a",{parentName:"strong",href:"http://localhost:7001"},"http://localhost:7001")),"."),(0,r.kt)("li",{parentName:"ul"},"Voc\xea pode testar a funcionalidade de login fazendo login com as credenciais ",(0,r.kt)("inlineCode",{parentName:"li"},"admin")," e ",(0,r.kt)("inlineCode",{parentName:"li"},"123"),".")),(0,r.kt)("p",null,"Ap\xf3s verificar esses passos, siga os passos abaixo para integrar o Casdoor com sua aplica\xe7\xe3o."),(0,r.kt)("h2",{id:"passo-2-configure-a-aplica\xe7\xe3o-casdoor"},"Passo 2: Configure a Aplica\xe7\xe3o Casdoor"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Crie uma nova aplica\xe7\xe3o Casdoor ou use uma existente."),(0,r.kt)("li",{parentName:"ul"},"Adicione sua URL de redirecionamento. Voc\xea pode encontrar mais informa\xe7\xf5es sobre como obter a URL de redirecionamento na pr\xf3xima se\xe7\xe3o. ",(0,r.kt)("img",{alt:"Configura\xe7\xe3o da Aplica\xe7\xe3o Casdoor",src:n(14794).Z,width:"974",height:"935"})),(0,r.kt)("li",{parentName:"ul"},"Obtenha seu ",(0,r.kt)("inlineCode",{parentName:"li"},"Certificado")," na p\xe1gina de edi\xe7\xe3o de certificado. ",(0,r.kt)("img",{alt:"Configura\xe7\xe3o de Certifica\xe7\xe3o Casdoor",src:n(23185).Z,width:"1726",height:"800"})),(0,r.kt)("li",{parentName:"ul"},"Adicione o provedor e outras configura\xe7\xf5es conforme necess\xe1rio.")),(0,r.kt)("p",null,"Voc\xea pode obter os valores para ",(0,r.kt)("inlineCode",{parentName:"p"},"Nome da Aplica\xe7\xe3o"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"Nome da Organiza\xe7\xe3o"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"URL de Redirecionamento"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"ID do Cliente"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"Segredo do Cliente")," e ",(0,r.kt)("inlineCode",{parentName:"p"},"Certificado")," na p\xe1gina de configura\xe7\xf5es da aplica\xe7\xe3o. Usaremos esses valores na pr\xf3xima etapa."),(0,r.kt)("h2",{id:"passo-3-configure-o-spring-security"},"Passo 3: Configure o Spring Security"),(0,r.kt)("p",null,"Voc\xea pode personalizar as configura\xe7\xf5es dos filtros do Spring Security para processar tokens:"),(0,r.kt)("admonition",{type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"Certifique-se de substituir os valores de configura\xe7\xe3o pelos da sua pr\xf3pria inst\xe2ncia Casdoor, especialmente ",(0,r.kt)("inlineCode",{parentName:"p"},"<Client ID>")," e os outros.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yml"},"server:\n  port: 8080\ncasdoor:\n  endpoint: http://CASDOOR_HOSTNAME:8000\n  client-id: <Client ID>\n  client-secret: <Client Secret>\n  certificate: <Certificate>\n  organization-name: <Organization Name>\n  application-name: <Application Name>\n  redirect-url: http://FRONTEND_HOSTNAME/callback\n")),(0,r.kt)("admonition",{type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"Para aplica\xe7\xf5es frontend, o valor padr\xe3o de ",(0,r.kt)("inlineCode",{parentName:"p"},"<FRONTEND_HOSTNAME>")," \xe9 ",(0,r.kt)("inlineCode",{parentName:"p"},"localhost:3000"),". Nesta demonstra\xe7\xe3o, a URL de redirecionamento \xe9 ",(0,r.kt)("inlineCode",{parentName:"p"},"http://localhost:3000/callback"),". Certifique-se de configurar isso na sua aplica\xe7\xe3o ",(0,r.kt)("inlineCode",{parentName:"p"},"casdoor"),".")),(0,r.kt)("h2",{id:"passo-4-configure-o-frontend"},"Passo 4: Configure o Frontend"),(0,r.kt)("p",null,"Voc\xea precisa instalar ",(0,r.kt)("inlineCode",{parentName:"p"},"casdoor-js-sdk")," e configurar o SDK da seguinte forma:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Instale ",(0,r.kt)("inlineCode",{parentName:"p"},"casdoor-js-sdk"),"."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"npm i casdoor-js-sdk \n# or\nyarn add casdoor-js-sdk\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Configure o ",(0,r.kt)("inlineCode",{parentName:"p"},"SDK"),"."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'import Sdk from "casdoor-js-sdk";\n\n// Serverurl is the URL where spring security is deployed\nexport const ServerUrl = "http://BACKEND_HOSTNAME:8080";\n\nconst sdkConfig = {\n  serverUrl: "http://CASDOOR_HOSTNAME:8000",\n  clientId: "<your client id>",\n  appName: "<your application name>",\n  organizationName: "<your organization name>",\n  redirectPath: "/callback",\n};\n\nexport const CasdoorSDK = new Sdk(sdkConfig);\n')))),(0,r.kt)("h2",{id:"passo-5-configure-uma-demonstra\xe7\xe3o"},"Passo 5: Configure uma Demonstra\xe7\xe3o"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Crie uma aplica\xe7\xe3o Spring Boot.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Adicione algumas configura\xe7\xf5es para lidar com JWT."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-java"},'@EnableWebSecurity\npublic class SecurityConfig {\n\n    private final JwtTokenFilter jwtTokenFilter;\n\n    public SecurityConfig(JwtTokenFilter jwtTokenFilter) {\n        this.jwtTokenFilter = jwtTokenFilter;\n    }\n\n    @Bean\n    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {\n        // enable CORS and disable CSRF\n        http = http.cors(corsConfig -> corsConfig\n                .configurationSource(configurationSource())\n        ).csrf().disable();\n\n        // set session management to stateless\n        http = http\n                .sessionManagement()\n                .sessionCreationPolicy(SessionCreationPolicy.STATELESS)\n                .and();\n\n        // set permissions on endpoints\n        http.authorizeHttpRequests(authorize -> authorize\n                .mvcMatchers("/api/redirect-url", "/api/signin").permitAll()\n                .mvcMatchers("/api/**").authenticated()\n        );\n\n        // set unauthorized requests exception handler\n        http = http\n                .exceptionHandling()\n                .authenticationEntryPoint(\n                        (request, response, ex) -> ResponseUtils.fail(response, "unauthorized")\n                )\n                .and();\n\n        // add JWT token filter\n        http.addFilterBefore(\n                jwtTokenFilter,\n                UsernamePasswordAuthenticationFilter.class\n        );\n        return http.build();\n    }\n\n    // ...\n')))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"}\n```\n")),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Adicione um filtro JWT simples para interceptar requisi\xe7\xf5es que requerem verifica\xe7\xe3o de token."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-java"},'@Component\npublic class JwtTokenFilter extends OncePerRequestFilter {\n\n    private final CasdoorAuthService casdoorAuthService;\n\n    public JwtTokenFilter(CasdoorAuthService casdoorAuthService) {\n        this.casdoorAuthService = casdoorAuthService;\n    }\n\n    @Override\n    protected void doFilterInternal(HttpServletRequest request,\n                                    HttpServletResponse response,\n                                    FilterChain chain)\n            throws ServletException, IOException {\n        // get authorization header and validate\n        final String header = request.getHeader(HttpHeaders.AUTHORIZATION);\n        if (!StringUtils.hasText(header) || !header.startsWith("Bearer ")) {\n            chain.doFilter(request, response);\n            return;\n        }\n\n        // get jwt token and validate\n        final String token = header.split(" ")[1].trim();\n\n        // get user identity and set it on the spring security context\n        UserDetails userDetails = null;\n        try {\n            CasdoorUser casdoorUser = casdoorAuthService.parseJwtToken(token);\n            userDetails = new CustomUserDetails(casdoorUser);\n        } catch (CasdoorAuthException exception) {\n            logger.error("casdoor auth exception", exception);\n            chain.doFilter(request, response);\n            return;\n        }\n\n        UsernamePasswordAuthenticationToken authentication = new UsernamePasswordAuthenticationToken(\n                userDetails,\n                null,\n                AuthorityUtils.createAuthorityList("ROLE_casdoor")\n        );\n\n        authentication.setDetails(\n                new WebAuthenticationDetailsSource().buildDetails(request)\n        );\n\n        SecurityContextHolder.getContext().setAuthentication(authentication);\n        chain.doFilter(request, response);\n    }\n\n}\n')),(0,r.kt)("p",{parentName:"li"},"Quando o usu\xe1rio acessa a interface que requer autentica\xe7\xe3o, ",(0,r.kt)("inlineCode",{parentName:"p"},"JwtTokenFilter")," ir\xe1 obter o token do cabe\xe7alho da requisi\xe7\xe3o ",(0,r.kt)("inlineCode",{parentName:"p"},"Authorization")," e verificar.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Defina um ",(0,r.kt)("inlineCode",{parentName:"p"},"Controller")," para lidar quando o usu\xe1rio faz login no Casdoor. Ap\xf3s o usu\xe1rio fazer login, ele ser\xe1 redirecionado para o servidor e carregar\xe1 o ",(0,r.kt)("inlineCode",{parentName:"p"},"code")," e o ",(0,r.kt)("inlineCode",{parentName:"p"},"state"),". O servidor ent\xe3o precisa verificar a identidade do usu\xe1rio no Casdoor e obter o ",(0,r.kt)("inlineCode",{parentName:"p"},"token")," atrav\xe9s desses dois par\xe2metros."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-java"},"@RestController\npublic class UserController {\n\n    private static final Logger logger = LoggerFactory.getLogger(UserController.class);\n\n    private final CasdoorAuthService casdoorAuthService;\n\n    // ...\n")))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'    @PostMapping("/api/signin")\n    public Result signin(@RequestParam("code") String code, @RequestParam("state") String state) {\n        try {\n            String token = casdoorAuthService.getOAuthToken(code, state);\n            return Result.success(token);\n        } catch (CasdoorAuthException exception) {\n            logger.error("casdoor auth exception", exception);\n            return Result.failure(exception.getMessage());\n        }\n    }\n\n    // ...\n}\n```\n')),(0,r.kt)("h2",{id:"passo-6-experimente-a-demonstra\xe7\xe3o"},"Passo 6: Experimente a Demonstra\xe7\xe3o"),(0,r.kt)("p",null,"Voc\xea pode acessar a aplica\xe7\xe3o frontend atrav\xe9s do seu navegador. Se voc\xea n\xe3o estiver logado, ver\xe1 um bot\xe3o de login. Clique nele, e voc\xea ser\xe1 redirecionado para a p\xe1gina de login do Casdoor."),(0,r.kt)("p",null,"Se voc\xea visitar sua p\xe1gina raiz,",(0,r.kt)("img",{alt:"bem-vindo",src:n(2189).Z,width:"1920",height:"942"})),(0,r.kt)("p",null,"Clique no bot\xe3o ",(0,r.kt)("inlineCode",{parentName:"p"},"Login Casdoor"),", e a p\xe1gina redirecionar\xe1 para a p\xe1gina de login do Casdoor. ",(0,r.kt)("img",{alt:"casdoor",src:n(7763).Z,width:"1920",height:"942"})),(0,r.kt)("p",null,"Ap\xf3s fazer login, voc\xea ser\xe1 redirecionado para ",(0,r.kt)("inlineCode",{parentName:"p"},"/"),". ",(0,r.kt)("img",{alt:"recurso",src:n(83922).Z,width:"1920",height:"942"})))}d.isMDXComponent=!0},23185:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/casdoor_certification-fab3970e250b9e55213bb833f35f09d0.png"},14794:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/casdoor_setting-fca4ce21a48b644d6bbe251ca27271b7.png"},7763:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/spring_security_filter_casdoor-cd320a7fc7fb2a735740d4a57d56e7d8.png"},83922:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/spring_security_filter_resource-1095701ba0a994c50e87885b53e22a77.png"},2189:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/spring_security_filter_welcome-3258334efe51769aea33778f46287a78.png"}}]);