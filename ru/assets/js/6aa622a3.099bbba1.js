"use strict";(self.webpackChunkcasdoor_website=self.webpackChunkcasdoor_website||[]).push([[2071],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return u}});var a=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=a.createContext({}),d=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=d(e.components);return a.createElement(l.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),m=d(n),u=o,h=m["".concat(l,".").concat(u)]||m[u]||c[u]||r;return n?a.createElement(h,i(i({ref:t},p),{},{components:n})):a.createElement(h,i({ref:t},p))}));function u(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,i=new Array(r);i[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:o,i[1]=s;for(var d=2;d<r;d++)i[d]=n[d];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},90702:function(e,t,n){n.r(t),n.d(t,{assets:function(){return p},contentTitle:function(){return l},default:function(){return u},frontMatter:function(){return s},metadata:function(){return d},toc:function(){return c}});var a=n(83117),o=n(80102),r=(n(67294),n(3905)),i=["components"],s={sidebar_position:1,title:"WeChat MiniProgram"},l=void 0,d={unversionedId:"integration/wechat_miniprogram",id:"integration/wechat_miniprogram",title:"WeChat MiniProgram",description:"Casdoor supports WeChat Mini Program after version 1.41.0",source:"@site/i18n/ru/docusaurus-plugin-content-docs/current/integration/wechat_miniprogram.md",sourceDirName:"integration",slug:"/integration/wechat_miniprogram",permalink:"/ru/docs/integration/wechat_miniprogram",draft:!1,editUrl:"https://github.com/casdoor/casdoor-website/tree/master/docs/integration/wechat_miniprogram.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1,title:"WeChat MiniProgram"},sidebar:"tutorialSidebar",previous:{title:"Spring Security",permalink:"/ru/docs/integration/spring-security"},next:{title:"ELK",permalink:"/ru/docs/integration/elk"}},p={},c=[{value:"Step1. Deploy Casdoor",id:"step1-deploy-casdoor",level:2},{value:"Step2. Configure Casdoor application",id:"step2-configure-casdoor-application",level:2},{value:"Step3. Write WeChat MiniProgram code",id:"step3-write-wechat-miniprogram-code",level:2}],m={toc:c};function u(e){var t=e.components,s=(0,o.Z)(e,i);return(0,r.kt)("wrapper",(0,a.Z)({},m,s,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"Casdoor supports WeChat Mini Program after version 1.41.0"))),(0,r.kt)("p",null,"Since WeChat Mini Program do not support standardized OAuth, it cannot jump to the self-host Casdoor webpage for login. Therefore, the process of using Casdoor for WeChat Mini Program is different from that of ordinary programs. This document will talk about how to access Casdoor to WeChat Mini Program, and more detailed information can be found in the WeChat Mini Program ",(0,r.kt)("a",{parentName:"p",href:"https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html"},"login document"),"."),(0,r.kt)("p",null,"The following are some of the names in the configuration:"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"CASDOOR_HOSTNAME"),": Domain name or IP where Casdoor server is deployed. e.g., ",(0,r.kt)("inlineCode",{parentName:"p"},"https://door.casbin.com"),"."),(0,r.kt)("h2",{id:"step1-deploy-casdoor"},"Step1. Deploy Casdoor"),(0,r.kt)("p",null,"Firstly, the ",(0,r.kt)("a",{parentName:"p",href:"/docs/basic/server-installation"},"Casdoor")," should be deployed."),(0,r.kt)("p",null,"After a successful deployment, you need to ensure:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Casdoor can be logged in and used normally."),(0,r.kt)("li",{parentName:"ol"},"Set Casdoor's ",(0,r.kt)("inlineCode",{parentName:"li"},"origin")," value (conf/app.conf) to ",(0,r.kt)("inlineCode",{parentName:"li"},"CASDOOR_HOSTNAME"),". ",(0,r.kt)("img",{alt:"Casdoor conf",src:n(39936).Z,width:"1013",height:"448"}))),(0,r.kt)("h2",{id:"step2-configure-casdoor-application"},"Step2. Configure Casdoor application"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Create a wechat idp in casdoor and fill your ",(0,r.kt)("inlineCode",{parentName:"li"},"APPID")," and ",(0,r.kt)("inlineCode",{parentName:"li"},"APPSECRET")," given to you by WeChat MiniP Program develop platform: ",(0,r.kt)("img",{alt:"Casdoor idp",src:n(29004).Z,width:"1516",height:"1016"})),(0,r.kt)("li",{parentName:"ol"},"Create or use an existing Casdoor application."),(0,r.kt)("li",{parentName:"ol"},"Add the idp added above to the application you want to use.")),(0,r.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"Tips")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"For convenience, casdoor will read the first WeChat type idp in the application as the WeChat Mini Program idp by default."),(0,r.kt)("p",{parentName:"div"},"So if you want to use the WeChat Mini Program in this app, don't add multiple WeChat type idp in one app."))),(0,r.kt)("h2",{id:"step3-write-wechat-miniprogram-code"},"Step3. Write WeChat MiniProgram code"),(0,r.kt)("p",null,"WeChat Mini Program provides an API to login internally and get the Code, all you need to do is to send this Code to Casdoor, Casdoor will use this Code to get some information from WeChat server (such as OpenID, SessionKey, etc.)."),(0,r.kt)("p",null,"The following code shows how to accomplish the above process:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'// login in mini program\n    wx.login({\n      success: res => {\n        // this is your login code you need to send to casdoor\n        console.log(res.code)\n\n        wx.request({\n          url: \'http://localhost:8000/api/login/oauth/access_token\',\n          method: "POST",\n          data: {\n            "tag":"wechat_miniprogram", //required\n            "client_id":"6825f4f0af45554c8952",\n            "client_secret": "2d0f463...",\n            "code": res.code,\n            "username": this.data.userInfo.nickName, //update user profile, when you login.\n            "avatar": this.data.userInfo.avatarUrl,\n          },\n          header:{\n            "content-type":"application/x-www-form-urlencoded",\n          },\n          success: res => {\n            console.log(res)\n            this.globalData.accessToken = res.data.access_token // get casdoor\'s accessToken\n          }\n        })\n      }\n    })\n')),(0,r.kt)("p",null,"It is worth mentioning that the ",(0,r.kt)("inlineCode",{parentName:"p"},"tag")," parameter is mandatory and you need to make casdoor understand that this is a request from the WeChat Mini Program."),(0,r.kt)("p",null,"The above code passes in the username and avatar uri of the WeChat Mini Program user while logging in. You can also pass these two parameters without passing them first, and then pass them to casdoor after the login is successful and accessToken is obtained:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'    wx.getUserProfile({\n      desc: \'share your info to casdoor\', \n      success: (res) => {\n        this.setData({\n          userInfo: res.userInfo,\n          hasUserInfo: true\n        })\n        console.log(app.globalData.accessToken)\n        wx.request({\n          url: \'http://`CASDOOR_HOSTNAME`:7001/api/update-user\', // casdoor uri\n          method: "POST",\n          data: {\n            "owner": "test",\n            "name": "wechat-oGk3T5tIiMFo3SazCO75f0HEiE7Q",\n            "displayName": this.data.userInfo.nickName,\n            "avatar": this.data.userInfo.avatarUrl\n          },\n          header:{\n            "Authorization":"Bearer "+app.globalData.accessToken, //Bearer token\n            "content-type": "application/json"\n          },\n          success: (res)=>{\n            console.log(res)\n          }\n        })\n      }\n    })\n')),(0,r.kt)("p",null,"Also, you can use accessToken as a bearer token for any Casdoor operation you want."),(0,r.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"Tips")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"Currently Casdoor is unable to bind existing accounts to the WeChat Mini Program users. After Casdoor gets the openID from WeChat if this id does not exist, a new user will be created, and if it exists, the old one will be used."))))}u.isMDXComponent=!0},29004:function(e,t,n){t.Z=n.p+"assets/images/casdoor_mp-2a1df8caa6e04c38186299c591edf1b7.png"},39936:function(e,t,n){t.Z=n.p+"assets/images/casdoor_origin-8f5d9e44f6b58828ce69e6e6d896e122.png"}}]);