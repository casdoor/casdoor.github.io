"use strict";(self.webpackChunkcasdoor_website=self.webpackChunkcasdoor_website||[]).push([[9153],{78116:(e,t,o)=>{o.r(t),o.d(t,{assets:()=>d,contentTitle:()=>r,default:()=>c,frontMatter:()=>i,metadata:()=>s,toc:()=>l});var a=o(87462),n=(o(67294),o(3905));o(61839);const i={title:"\u5fae\u4fe1\u5c0f\u7a0b\u5e8f",description:"\u5728 \u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u4e2d\u4f7f\u7528 Casdoor",keywords:["\u5fae\u4fe1","\u5c0f\u7a0b\u5e8f"]},r=void 0,s={unversionedId:"integration/wechat_miniprogram",id:"integration/wechat_miniprogram",title:"\u5fae\u4fe1\u5c0f\u7a0b\u5e8f",description:"\u5728 \u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u4e2d\u4f7f\u7528 Casdoor",source:"@site/i18n/zh/docusaurus-plugin-content-docs/current/integration/wechat_miniprogram.md",sourceDirName:"integration",slug:"/integration/wechat_miniprogram",permalink:"/zh/docs/integration/wechat_miniprogram",draft:!1,editUrl:"https://crowdin.com/project/casdoor-website/zh-CN",tags:[],version:"current",frontMatter:{title:"\u5fae\u4fe1\u5c0f\u7a0b\u5e8f",description:"\u5728 \u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u4e2d\u4f7f\u7528 Casdoor",keywords:["\u5fae\u4fe1","\u5c0f\u7a0b\u5e8f"]},sidebar:"tutorialSidebar",previous:{title:"Pulsar-manager",permalink:"/zh/docs/integration/Pulsar-manager"},next:{title:"ELK",permalink:"/zh/docs/integration/elk"}},d={},l=[{value:"Introduction",id:"introduction",level:2},{value:"Step1. Deploy Casdoor",id:"step1-deploy-casdoor",level:2},{value:"Step2. Configure Casdoor application",id:"step2-configure-casdoor-application",level:2},{value:"Step3. Write WeChat MiniProgram code",id:"step3-write-wechat-miniprogram-code",level:2}],p={toc:l};function c(e){let{components:t,...i}=e;return(0,n.kt)("wrapper",(0,a.Z)({},p,i,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("admonition",{type:"info"},(0,n.kt)("p",{parentName:"admonition"},"Casdoor\u652f\u63011.41.0\u7248\u540e\u7684\u5fae\u4fe1\u5c0f\u7a0b\u5e8f")),(0,n.kt)("h2",{id:"introduction"},"Introduction"),(0,n.kt)("p",null,"\u65e2\u7136\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u4e0d\u652f\u6301\u6807\u51c6\u7684 OAutth\uff0c\u5b83\u4e0d\u80fd\u8df3\u8f6c\u5230\u81ea\u4e3b\u673a\u7684 Casdoor \u7f51\u9875\u8fdb\u884c\u767b\u5f55\u3002 \u56e0\u6b64\uff0c\u4f7f\u7528 Casdoor \u7528\u4e8e\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u4e0d\u540c\u4e8e\u666e\u901a\u65b9\u6848\u3002"),(0,n.kt)("p",null,"This document will talk about how to access Casdoor to WeChat Mini Program, You can find the example on GitHub here: ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/casdoor/casdoor-wechat-miniprogram-example"},"casdoor-wechat-miniprogram-example"),". More detailed information can be found in the WeChat Mini Program ",(0,n.kt)("a",{parentName:"p",href:"https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html"},"login document"),"."),(0,n.kt)("blockquote",null,(0,n.kt)("p",{parentName:"blockquote"},"The following are some of the names in the configuration:"),(0,n.kt)("p",{parentName:"blockquote"},(0,n.kt)("inlineCode",{parentName:"p"},"CASDOOR_HOSTNAME"),": Domain name or IP where Casdoor server is deployed. e.g., ",(0,n.kt)("inlineCode",{parentName:"p"},"https://door.casbin.com"),".")),(0,n.kt)("h2",{id:"step1-deploy-casdoor"},"Step1. Deploy Casdoor"),(0,n.kt)("p",null,"Firstly, the ",(0,n.kt)("a",{parentName:"p",href:"/docs/basic/server-installation"},"Casdoor")," should be deployed."),(0,n.kt)("p",null,"After a successful deployment, you need to ensure:"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"Casdoor \u53ef\u4ee5\u6b63\u5e38\u767b\u5f55\u4f7f\u7528\u3002"),(0,n.kt)("li",{parentName:"ol"},"\u5c06 Casdoor \u7684 ",(0,n.kt)("inlineCode",{parentName:"li"},"origin")," \u503c (conf/app.conf) \u8bbe\u7f6e\u4e3a ",(0,n.kt)("inlineCode",{parentName:"li"},"CASDOOR_HOSTNAME"),"\u3002 ",(0,n.kt)("img",{alt:"Casdoor \u914d\u7f6e",src:o(39936).Z,width:"1013",height:"448"}))),(0,n.kt)("h2",{id:"step2-configure-casdoor-application"},"Step2. Configure Casdoor application"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"\u5728 casdoor \u521b\u5efa\u4e00\u4e2awechat idp, \u5e76\u586b\u5199\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u5f00\u53d1\u5e73\u53f0\u7ed9\u60a8\u7684 ",(0,n.kt)("inlineCode",{parentName:"li"},"APPID")," \u548c ",(0,n.kt)("inlineCode",{parentName:"li"},"APPSECRET")," \uff1a ",(0,n.kt)("img",{alt:"WeChat_MiniProgram.png",src:o(63020).Z,width:"937",height:"773"})),(0,n.kt)("li",{parentName:"ol"},"\u521b\u5efa\u6216\u4f7f\u7528\u73b0\u6709\u7684 Casdoor \u5e94\u7528\u7a0b\u5e8f\u3002"),(0,n.kt)("li",{parentName:"ol"},"\u5c06\u4e0a\u9762\u6dfb\u52a0\u7684 idp \u6dfb\u52a0\u5230\u60a8\u60f3\u8981\u4f7f\u7528\u7684\u5e94\u7528\u7a0b\u5e8f\u4e2d\u3002")),(0,n.kt)("admonition",{title:"Tips",type:"info"},(0,n.kt)("p",{parentName:"admonition"},"For convenience, casdoor will read the first WeChat type idp in the application as the WeChat Mini Program idp by default."),(0,n.kt)("p",{parentName:"admonition"},"So if you want to use the WeChat Mini Program in this app, don't add multiple WeChat type idp in one app.")),(0,n.kt)("h2",{id:"step3-write-wechat-miniprogram-code"},"Step3. Write WeChat MiniProgram code"),(0,n.kt)("p",null,"WeChat Mini Program provides an API to login internally and get the Code, all you need to do is to send this Code to Casdoor, Casdoor will use this Code to get some information from WeChat server (such as OpenID, SessionKey, etc.)."),(0,n.kt)("p",null,"The following code shows how to accomplish the above process:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-js"},'// login in mini program\nwx.login({\n  success: res => {\n    // this is your login code you need to send to casdoor\n    console.log(res.code)\n\n    wx.request({\n      url: `${CASDOOR_HOSTNAME}/api/login/oauth/access_token`,\n      method: "POST",\n      data: {\n        "tag": "wechat_miniprogram", // required\n        "client_id": "6825f4f0af45554c8952",\n        "code": res.code,\n        "username": this.data.userInfo.nickName, // update user profile, when you login.\n        "avatar": this.data.userInfo.avatarUrl,\n      },\n      header:{\n        "content-type": "application/x-www-form-urlencoded",\n      },\n      success: res => {\n        console.log(res)\n        this.globalData.accessToken = res.data.access_token // get casdoor\'s accessToken\n      }\n    })\n  }\n})\n')),(0,n.kt)("p",null,"It is worth mentioning that the ",(0,n.kt)("inlineCode",{parentName:"p"},"tag")," parameter is mandatory and you need to make casdoor understand that this is a request from the WeChat Mini Program."),(0,n.kt)("p",null,"The above code passes in the username and avatar uri of the WeChat Mini Program user while logging in. You can also pass these two parameters without passing them first, and then pass them to casdoor after the login is successful and accessToken is obtained:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-js"},'wx.getUserProfile({\n  desc: \'share your info to casdoor\', \n  success: (res) => {\n    this.setData({\n      userInfo: res.userInfo,\n      hasUserInfo: true\n    })\n    console.log(app.globalData.accessToken)\n    wx.request({\n      url: `${CASDOOR_HOSTNAME}/api/update-user`, // casdoor uri\n      method: "POST",\n      data: {\n        "owner": "test",\n        "name": "wechat-oGk3T5tIiMFo3SazCO75f0HEiE7Q",\n        "displayName": this.data.userInfo.nickName,\n        "avatar": this.data.userInfo.avatarUrl\n      },\n      header: {\n        "Authorization": "Bearer " + app.globalData.accessToken, // Bearer token\n        "content-type": "application/json"\n      },\n      success: (res) => {\n        console.log(res)\n      }\n    })\n  }\n})\n')),(0,n.kt)("p",null,"Also, you can use accessToken as a bearer token for any Casdoor operation you want."),(0,n.kt)("admonition",{title:"Tips",type:"info"},(0,n.kt)("p",{parentName:"admonition"},"Currently Casdoor is unable to bind existing accounts to the WeChat Mini Program users. After Casdoor gets the openID from WeChat if this id does not exist, a new user will be created, and if it exists, the old one will be used.")))}c.isMDXComponent=!0},39936:(e,t,o)=>{o.d(t,{Z:()=>a});const a=o.p+"assets/images/casdoor_origin-8f5d9e44f6b58828ce69e6e6d896e122.png"},63020:(e,t,o)=>{o.d(t,{Z:()=>a});const a=o.p+"assets/images/WeChat_MiniProgram-701cc38162bc50d472b5226e5f167e3c.png"}}]);