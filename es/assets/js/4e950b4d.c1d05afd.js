"use strict";(self.webpackChunkcasdoor_website=self.webpackChunkcasdoor_website||[]).push([[3583],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>g});var a=t(67294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var l=a.createContext({}),c=function(e){var n=a.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},p=function(e){var n=c(e.components);return a.createElement(l.Provider,{value:n},e.children)},d={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},u=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=c(t),g=r,m=u["".concat(l,".").concat(g)]||u[g]||d[g]||i;return t?a.createElement(m,o(o({ref:n},p),{},{components:t})):a.createElement(m,o({ref:n},p))}));function g(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var i=t.length,o=new Array(i);o[0]=u;var s={};for(var l in n)hasOwnProperty.call(n,l)&&(s[l]=n[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var c=2;c<i;c++)o[c]=t[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,t)}u.displayName="MDXCreateElement"},21554:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>d,frontMatter:()=>i,metadata:()=>s,toc:()=>c});var a=t(87462),r=(t(67294),t(3905));const i={title:"Filtro de Seguridad Spring con integraci\xf3n OIDC para Casdoor",description:"Este art\xedculo explica c\xf3mo usar el Filtro de Seguridad Spring para conectar tu aplicaci\xf3n con Casdoor usando OIDC.",keywords:["OIDC","Spirng Security","Spring Security Filter","Filter","Casdoor"],authors:["wenxuan70"]},o=void 0,s={unversionedId:"integration/java/spring-security/spring-security-filter",id:"integration/java/spring-security/spring-security-filter",title:"Filtro de Seguridad Spring con integraci\xf3n OIDC para Casdoor",description:"Este art\xedculo explica c\xf3mo usar el Filtro de Seguridad Spring para conectar tu aplicaci\xf3n con Casdoor usando OIDC.",source:"@site/i18n/es/docusaurus-plugin-content-docs/current/integration/java/spring-security/spring-security-filter.md",sourceDirName:"integration/java/spring-security",slug:"/integration/java/spring-security/spring-security-filter",permalink:"/es/docs/integration/java/spring-security/spring-security-filter",draft:!1,editUrl:"https://github.com/casdoor/casdoor-website/edit/master/docs/integration/java/spring-security/spring-security-filter.md",tags:[],version:"current",frontMatter:{title:"Filtro de Seguridad Spring con integraci\xf3n OIDC para Casdoor",description:"Este art\xedculo explica c\xf3mo usar el Filtro de Seguridad Spring para conectar tu aplicaci\xf3n con Casdoor usando OIDC.",keywords:["OIDC","Spirng Security","Spring Security Filter","Filter","Casdoor"],authors:["wenxuan70"]},sidebar:"tutorialSidebar",previous:{title:"Spring Security OAuth",permalink:"/es/docs/integration/java/spring-security/spring-security-oauth"},next:{title:"Complemento de Jenkins",permalink:"/es/docs/integration/java/jenkins-plugin"}},l={},c=[{value:"Paso 1: Desplegar Casdoor",id:"paso-1-desplegar-casdoor",level:2},{value:"Paso 2: Configurar la Aplicaci\xf3n Casdoor",id:"paso-2-configurar-la-aplicaci\xf3n-casdoor",level:2},{value:"Paso 3: Configurar Spring Security",id:"paso-3-configurar-spring-security",level:2},{value:"Paso 4: Configurar Frontend",id:"paso-4-configurar-frontend",level:2},{value:"Paso 5: Configurar una Demostraci\xf3n",id:"paso-5-configurar-una-demostraci\xf3n",level:2},{value:"Paso 6: Probar la Demostraci\xf3n",id:"paso-6-probar-la-demostraci\xf3n",level:2}],p={toc:c};function d(e){let{components:n,...i}=e;return(0,r.kt)("wrapper",(0,a.Z)({},p,i,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"Casdoor es un IDP de c\xf3digo abierto que soporta OIDC y varios otros protocolos. En este art\xedculo, veremos c\xf3mo integrar Casdoor con tu aplicaci\xf3n usando el Filtro de Seguridad Spring y OIDC."),(0,r.kt)("h2",{id:"paso-1-desplegar-casdoor"},"Paso 1: Desplegar Casdoor"),(0,r.kt)("p",null,"Primero, necesitas desplegar el servidor Casdoor. Consulta la ",(0,r.kt)("a",{parentName:"p",href:"/docs/basic/server-installation"},"documentaci\xf3n oficial")," para instrucciones de instalaci\xf3n del servidor. Despu\xe9s del despliegue exitoso, aseg\xfarate de que:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"El servidor Casdoor est\xe1 funcionando en ",(0,r.kt)("strong",{parentName:"li"},(0,r.kt)("a",{parentName:"strong",href:"http://localhost:8000"},"http://localhost:8000")),"."),(0,r.kt)("li",{parentName:"ul"},"Puedes ver la p\xe1gina de inicio de sesi\xf3n de Casdoor en ",(0,r.kt)("strong",{parentName:"li"},(0,r.kt)("a",{parentName:"strong",href:"http://localhost:7001"},"http://localhost:7001")),"."),(0,r.kt)("li",{parentName:"ul"},"Puedes probar la funcionalidad de inicio de sesi\xf3n iniciando sesi\xf3n con las credenciales ",(0,r.kt)("inlineCode",{parentName:"li"},"admin")," y ",(0,r.kt)("inlineCode",{parentName:"li"},"123"),".")),(0,r.kt)("p",null,"Despu\xe9s de verificar estos pasos, sigue los pasos a continuaci\xf3n para integrar Casdoor con tu aplicaci\xf3n."),(0,r.kt)("h2",{id:"paso-2-configurar-la-aplicaci\xf3n-casdoor"},"Paso 2: Configurar la Aplicaci\xf3n Casdoor"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Crea una nueva aplicaci\xf3n Casdoor o usa una existente."),(0,r.kt)("li",{parentName:"ul"},"Agrega tu URL de redirecci\xf3n. Puedes encontrar m\xe1s informaci\xf3n sobre c\xf3mo obtener la URL de redirecci\xf3n en la siguiente secci\xf3n. ",(0,r.kt)("img",{alt:"Configuraci\xf3n de la Aplicaci\xf3n Casdoor",src:t(14794).Z,width:"974",height:"935"})),(0,r.kt)("li",{parentName:"ul"},"Obt\xe9n tu ",(0,r.kt)("inlineCode",{parentName:"li"},"Certificado")," en la p\xe1gina de edici\xf3n de certificados. ",(0,r.kt)("img",{alt:"Configuraci\xf3n de Certificaci\xf3n Casdoor",src:t(23185).Z,width:"1726",height:"800"})),(0,r.kt)("li",{parentName:"ul"},"Agrega el proveedor y otros ajustes seg\xfan sea necesario.")),(0,r.kt)("p",null,"Puedes obtener los valores para ",(0,r.kt)("inlineCode",{parentName:"p"},"Nombre de la Aplicaci\xf3n"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"Nombre de la Organizaci\xf3n"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"URL de Redirecci\xf3n"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"ID del Cliente"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"Secreto del Cliente")," y ",(0,r.kt)("inlineCode",{parentName:"p"},"Certificado")," en la p\xe1gina de configuraci\xf3n de la aplicaci\xf3n. Los usaremos en el siguiente paso."),(0,r.kt)("h2",{id:"paso-3-configurar-spring-security"},"Paso 3: Configurar Spring Security"),(0,r.kt)("p",null,"Puedes personalizar la configuraci\xf3n de los filtros de Spring Security para procesar tokens:"),(0,r.kt)("admonition",{type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"Aseg\xfarate de reemplazar los valores de configuraci\xf3n con los de tu propia instancia de Casdoor, especialmente ",(0,r.kt)("inlineCode",{parentName:"p"},"<Client ID>")," y los dem\xe1s.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yml"},"server:\n  port: 8080\ncasdoor:\n  endpoint: http://CASDOOR_HOSTNAME:8000\n  client-id: <Client ID>\n  client-secret: <Client Secret>\n  certificate: <Certificate>\n  organization-name: <Organization Name>\n  application-name: <Application Name>\n  redirect-url: http://FRONTEND_HOSTNAME/callback\n")),(0,r.kt)("admonition",{type:"caution"},(0,r.kt)("p",{parentName:"admonition"},"Para aplicaciones frontend, el valor predeterminado de ",(0,r.kt)("inlineCode",{parentName:"p"},"<FRONTEND_HOSTNAME>")," es ",(0,r.kt)("inlineCode",{parentName:"p"},"localhost:3000"),". En esta demostraci\xf3n, la URL de redirecci\xf3n es ",(0,r.kt)("inlineCode",{parentName:"p"},"http://localhost:3000/callback"),". Aseg\xfarate de configurar esto en tu aplicaci\xf3n ",(0,r.kt)("inlineCode",{parentName:"p"},"casdoor"),".")),(0,r.kt)("h2",{id:"paso-4-configurar-frontend"},"Paso 4: Configurar Frontend"),(0,r.kt)("p",null,"Necesitas instalar ",(0,r.kt)("inlineCode",{parentName:"p"},"casdoor-js-sdk")," y configurar el SDK de la siguiente manera:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Instalar ",(0,r.kt)("inlineCode",{parentName:"p"},"casdoor-js-sdk"),"."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-shell"},"npm i casdoor-js-sdk \n# or\nyarn add casdoor-js-sdk\n"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Configurar ",(0,r.kt)("inlineCode",{parentName:"p"},"SDK"),"."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},'import Sdk from "casdoor-js-sdk";\n\n// Serverurl is the URL where spring security is deployed\nexport const ServerUrl = "http://BACKEND_HOSTNAME:8080";\n\nconst sdkConfig = {\n  serverUrl: "http://CASDOOR_HOSTNAME:8000",\n  clientId: "<your client id>",\n  appName: "<your application name>",\n  organizationName: "<your organization name>",\n  redirectPath: "/callback",\n};\n\nexport const CasdoorSDK = new Sdk(sdkConfig);\n')))),(0,r.kt)("h2",{id:"paso-5-configurar-una-demostraci\xf3n"},"Paso 5: Configurar una Demostraci\xf3n"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Crea una aplicaci\xf3n Spring Boot.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Agrega algunas configuraciones para manejar JWT."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-java"},'@EnableWebSecurity\npublic class SecurityConfig {\n\n    private final JwtTokenFilter jwtTokenFilter;\n\n    public SecurityConfig(JwtTokenFilter jwtTokenFilter) {\n        this.jwtTokenFilter = jwtTokenFilter;\n    }\n\n    @Bean\n    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {\n        // enable CORS and disable CSRF\n        http = http.cors(corsConfig -> corsConfig\n                .configurationSource(configurationSource())\n        ).csrf().disable();\n\n        // set session management to stateless\n        http = http\n                .sessionManagement()\n                .sessionCreationPolicy(SessionCreationPolicy.STATELESS)\n                .and();\n\n        // set permissions on endpoints\n        http.authorizeHttpRequests(authorize -> authorize\n                .mvcMatchers("/api/redirect-url", "/api/signin").permitAll()\n                .mvcMatchers("/api/**").authenticated()\n        );\n\n        // set unauthorized requests exception handler\n        http = http\n                .exceptionHandling()\n                .authenticationEntryPoint(\n                        (request, response, ex) -> ResponseUtils.fail(response, "unauthorized")\n                )\n                .and();\n\n        // add JWT token filter\n        http.addFilterBefore(\n                jwtTokenFilter,\n                UsernamePasswordAuthenticationFilter.class\n        );\n        return http.build();\n    }\n\n    // ...\n')))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"}\n```\n")),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Agrega un filtro JWT simple para interceptar solicitudes que requieren verificaci\xf3n de token."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-java"},'@Component\npublic class JwtTokenFilter extends OncePerRequestFilter {\n\n    private final CasdoorAuthService casdoorAuthService;\n\n    public JwtTokenFilter(CasdoorAuthService casdoorAuthService) {\n        this.casdoorAuthService = casdoorAuthService;\n    }\n\n    @Override\n    protected void doFilterInternal(HttpServletRequest request,\n                                    HttpServletResponse response,\n                                    FilterChain chain)\n            throws ServletException, IOException {\n        // get authorization header and validate\n        final String header = request.getHeader(HttpHeaders.AUTHORIZATION);\n        if (!StringUtils.hasText(header) || !header.startsWith("Bearer ")) {\n            chain.doFilter(request, response);\n            return;\n        }\n\n        // get jwt token and validate\n        final String token = header.split(" ")[1].trim();\n\n        // get user identity and set it on the spring security context\n        UserDetails userDetails = null;\n        try {\n            CasdoorUser casdoorUser = casdoorAuthService.parseJwtToken(token);\n            userDetails = new CustomUserDetails(casdoorUser);\n        } catch (CasdoorAuthException exception) {\n            logger.error("casdoor auth exception", exception);\n            chain.doFilter(request, response);\n            return;\n        }\n\n        UsernamePasswordAuthenticationToken authentication = new UsernamePasswordAuthenticationToken(\n                userDetails,\n                null,\n                AuthorityUtils.createAuthorityList("ROLE_casdoor")\n        );\n\n        authentication.setDetails(\n                new WebAuthenticationDetailsSource().buildDetails(request)\n        );\n\n        SecurityContextHolder.getContext().setAuthentication(authentication);\n        chain.doFilter(request, response);\n    }\n\n}\n')),(0,r.kt)("p",{parentName:"li"},"Cuando el usuario accede a la interfaz que requiere autenticaci\xf3n, ",(0,r.kt)("inlineCode",{parentName:"p"},"JwtTokenFilter")," obtendr\xe1 el token del encabezado de la solicitud ",(0,r.kt)("inlineCode",{parentName:"p"},"Authorization")," y lo verificar\xe1.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Define un ",(0,r.kt)("inlineCode",{parentName:"p"},"Controller")," para manejar cuando el usuario inicia sesi\xf3n en Casdoor. Despu\xe9s de que el usuario inicie sesi\xf3n, ser\xe1 redirigido al servidor y llevar\xe1 el ",(0,r.kt)("inlineCode",{parentName:"p"},"code")," y el ",(0,r.kt)("inlineCode",{parentName:"p"},"state"),". El servidor entonces necesita verificar la identidad del usuario desde Casdoor y obtener el ",(0,r.kt)("inlineCode",{parentName:"p"},"token")," a trav\xe9s de estos dos par\xe1metros."),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-java"},"@RestController\npublic class UserController {\n\n    private static final Logger logger = LoggerFactory.getLogger(UserController.class);\n\n    private final CasdoorAuthService casdoorAuthService;\n\n    // ...\n")))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'    @PostMapping("/api/signin")\n    public Result signin(@RequestParam("code") String code, @RequestParam("state") String state) {\n        try {\n            String token = casdoorAuthService.getOAuthToken(code, state);\n            return Result.success(token);\n        } catch (CasdoorAuthException exception) {\n            logger.error("casdoor auth exception", exception);\n            return Result.failure(exception.getMessage());\n        }\n    }\n\n    // ...\n}\n```\n')),(0,r.kt)("h2",{id:"paso-6-probar-la-demostraci\xf3n"},"Paso 6: Probar la Demostraci\xf3n"),(0,r.kt)("p",null,"Puedes acceder a la aplicaci\xf3n frontend a trav\xe9s de tu navegador. Si no has iniciado sesi\xf3n, ver\xe1s un bot\xf3n de inicio de sesi\xf3n. Haz clic en \xe9l, y ser\xe1s redirigido a la p\xe1gina de inicio de sesi\xf3n de Casdoor."),(0,r.kt)("p",null,"Si visitas tu p\xe1gina ra\xedz,",(0,r.kt)("img",{alt:"bienvenido",src:t(2189).Z,width:"1920",height:"942"})),(0,r.kt)("p",null,"Haz clic en el bot\xf3n ",(0,r.kt)("inlineCode",{parentName:"p"},"Iniciar Sesi\xf3n Casdoor"),", y la p\xe1gina te redirigir\xe1 a la p\xe1gina de inicio de sesi\xf3n de Casdoor. ",(0,r.kt)("img",{alt:"casdoor",src:t(7763).Z,width:"1920",height:"942"})),(0,r.kt)("p",null,"Despu\xe9s de iniciar sesi\xf3n, ser\xe1s redirigido a ",(0,r.kt)("inlineCode",{parentName:"p"},"/"),". ",(0,r.kt)("img",{alt:"recurso",src:t(83922).Z,width:"1920",height:"942"})))}d.isMDXComponent=!0},23185:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/casdoor_certification-fab3970e250b9e55213bb833f35f09d0.png"},14794:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/casdoor_setting-fca4ce21a48b644d6bbe251ca27271b7.png"},7763:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/spring_security_filter_casdoor-cd320a7fc7fb2a735740d4a57d56e7d8.png"},83922:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/spring_security_filter_resource-1095701ba0a994c50e87885b53e22a77.png"},2189:(e,n,t)=>{t.d(n,{Z:()=>a});const a=t.p+"assets/images/spring_security_filter_welcome-3258334efe51769aea33778f46287a78.png"}}]);