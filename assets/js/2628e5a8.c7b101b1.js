(self.webpackChunkcasdoor_website=self.webpackChunkcasdoor_website||[]).push([[175],{27532:function(e,t,n){"use strict";n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return c},metadata:function(){return l},toc:function(){return p},default:function(){return u}});var o=n(74034),a=n(79973),r=(n(67294),n(3905)),i=["components"],s={title:"OAuth 2.0"},c=void 0,l={unversionedId:"how-to-connect/oauth",id:"how-to-connect/oauth",isDocsHomePage:!1,title:"OAuth 2.0",description:"Introduction",source:"@site/docs/how-to-connect/oauth.md",sourceDirName:"how-to-connect",slug:"/how-to-connect/oauth",permalink:"/docs/how-to-connect/oauth",editUrl:"https://github.com/casdoor/casdoor-website/tree/master/docs/how-to-connect/oauth.md",tags:[],version:"current",frontMatter:{title:"OAuth 2.0"},sidebar:"tutorialSidebar",previous:{title:"Casdoor Plugin",permalink:"/docs/how-to-connect/plugin"},next:{title:"CAS",permalink:"/docs/how-to-connect/cas"}},p=[{value:"Introduction",id:"introduction",children:[],level:2},{value:"How to get AccessToken",id:"how-to-get-accesstoken",children:[{value:'Authorization Code Grant <span id="1"></span>',id:"authorization-code-grant-",children:[],level:3},{value:"Implicit Grant",id:"implicit-grant",children:[],level:3},{value:"Resource Owner Password Credentials Grant",id:"resource-owner-password-credentials-grant",children:[],level:3},{value:"Client Credentials Grant",id:"client-credentials-grant",children:[],level:3},{value:"RefreshToken",id:"refreshtoken",children:[],level:3}],level:2},{value:"How to verify AccessToken",id:"how-to-verify-accesstoken",children:[],level:2},{value:"How to use <code>AccessToken</code>",id:"how-to-use-accesstoken",children:[],level:2},{value:"Differences between <code>userinfo</code> and <code>get-account</code> APIs",id:"differences-between-userinfo-and-get-account-apis",children:[],level:2}],d={toc:p};function u(e){var t=e.components,s=(0,a.Z)(e,i);return(0,r.kt)("wrapper",(0,o.Z)({},d,s,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"introduction"},"Introduction"),(0,r.kt)("p",null,"Casdoor supports AccessToken to authenticate clients. In this section, we will show you how to get AccessToken, how to verify AccessToken and how to use AccessToken."),(0,r.kt)("h2",{id:"how-to-get-accesstoken"},"How to get AccessToken"),(0,r.kt)("p",null,"You have two ways to get the AccessToken: you can use the ",(0,r.kt)("a",{parentName:"p",href:"/docs/how-to-connect/sdk"},"Casdoor SDK"),", for details please refer to the SDK documentation, here we will mainly show you how to use the API to get the AccessToken."),(0,r.kt)("p",null,"Casdoor supports four OAuth grant types: ",(0,r.kt)("a",{parentName:"p",href:"https://datatracker.ietf.org/doc/html/rfc6749#section-4.1"},"Authorization Code Grant"),", ",(0,r.kt)("a",{parentName:"p",href:"https://datatracker.ietf.org/doc/html/rfc6749#section-4.2"},"Implicit Grant"),", ",(0,r.kt)("a",{parentName:"p",href:"https://datatracker.ietf.org/doc/html/rfc6749#section-4.3"},"Resource Owner Password Credentials Grant"),", and ",(0,r.kt)("a",{parentName:"p",href:"https://datatracker.ietf.org/doc/html/rfc6749#section-4.4"},"Client Credentials Grant"),". "),(0,r.kt)("p",null,"For security reasons, the Casdoor app has the authorization code mode turned on by default, if you need to use other modes, please go to the appropriate app to set it."),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"Grant Types",src:n(7337).Z})),(0,r.kt)("h3",{id:"authorization-code-grant-"},"Authorization Code Grant ",(0,r.kt)("span",{id:"1"})),(0,r.kt)("p",null,"First redirect your users to ",(0,r.kt)("inlineCode",{parentName:"p"},"https://<CASDOOR_HOST>/login/oauth/authorize?client_id=CLIENT_ID&redirect_uri=REDIRECT_URI&response_type=code&scope=openid&state=STATE"),". After your user has authenticated with casdoor, casdoor will redirect him to ",(0,r.kt)("inlineCode",{parentName:"p"},"https://REDIRECT_URI?code=CODE&state=STATE"),". Now that you have obtained the authorization code, make a POST request to ",(0,r.kt)("inlineCode",{parentName:"p"},"https://<CASDOOR_HOST>/api/login/oauth/access_token")," in your backend application :"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "grant_type": "authorization_code",\n    "client_id": ClientId,\n    "client_secret": ClientSecret,\n    "code": Code,\n}\n')),(0,r.kt)("p",null,"You will get the following response:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "access_token": "eyJhb...",\n    "id_token": "eyJhb...",\n    "refresh_token": "eyJhb...",\n    "token_type": "Bearer",\n    "expires_in": 10080,\n    "scope": "openid"\n}\n')),(0,r.kt)("p",null,"Casdoor also supports ",(0,r.kt)("a",{parentName:"p",href:"https://datatracker.ietf.org/doc/html/rfc7636"},"PKCE")," feature, when getting the authorization code, you can add two parameters:",(0,r.kt)("inlineCode",{parentName:"p"},"&code_challenge_method=S256&code_challenge=YOUR_CHANLLENGE"),", to enable PKCE. Also when getting the token you need to pass ",(0,r.kt)("inlineCode",{parentName:"p"},"code_verifier")," parameter to verify PKCE. It is worth mentioning that with PKCE enabled, Client_Secret is not required, but if you pass it, it must be the correct value."),(0,r.kt)("h3",{id:"implicit-grant"},"Implicit Grant"),(0,r.kt)("p",null,"Maybe your application doesn't have a backend, and you need to use Implicit Grant. First you need to make sure you have Implicit Grant enabled, then redirect your users to:",(0,r.kt)("inlineCode",{parentName:"p"},"https://<CASDOOR_HOST>/login/oauth/authorize?client_id=CLIENT_ID&redirect_uri=REDIRECT_URI&response_type=token&scope=openid&state=STATE"),". After your user has authenticated with casdoor, casdoor will redirect him to ",(0,r.kt)("inlineCode",{parentName:"p"},"https://REDIRECT_URI/#token=ACCESS_TOKEN")),(0,r.kt)("p",null,"Casdoor also supports ",(0,r.kt)("a",{parentName:"p",href:"https://openid.net/specs/oauth-v2-multiple-response-types-1_0.html#id_token"},"id_token")," as ",(0,r.kt)("inlineCode",{parentName:"p"},"response_type"),", which is a feature of OpenID."),(0,r.kt)("h3",{id:"resource-owner-password-credentials-grant"},"Resource Owner Password Credentials Grant"),(0,r.kt)("p",null,"If your application doesn't have a frontend that redirects users to Casdoor, then you may need this."),(0,r.kt)("p",null,"First you need to make sure you have Password Credentials Grant enabled, and send a POST request to ",(0,r.kt)("inlineCode",{parentName:"p"},"https://<CASDOOR_HOST>/api/login/oauth/access_token"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "grant_type": "password",\n    "client_id": ClientId,\n    "client_secret": ClientSecret,\n    "username": Username,\n    "password": Password,\n}\n')),(0,r.kt)("p",null,"You will get the following response:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "access_token": "eyJhb...",\n    "id_token": "eyJhb...",\n    "refresh_token": "eyJhb...",\n    "token_type": "Bearer",\n    "expires_in": 10080,\n    "scope": "openid"\n}\n')),(0,r.kt)("h3",{id:"client-credentials-grant"},"Client Credentials Grant"),(0,r.kt)("p",null,"You can also use Client Credentials Grant when your application does not have a frontend."),(0,r.kt)("p",null,"First you need to make sure you have Client Credentials Grant enabled, and send a POST request to ",(0,r.kt)("inlineCode",{parentName:"p"},"https://<CASDOOR_HOST>/api/login/oauth/access_token"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "grant_type": "client_credentials",\n    "client_id": ClientId,\n    "client_secret": ClientSecret,\n}\n')),(0,r.kt)("p",null,"You will get the following response:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "access_token": "eyJhb...",\n    "id_token": "eyJhb...",\n    "refresh_token": "eyJhb...",\n    "token_type": "Bearer",\n    "expires_in": 10080,\n    "scope": "openid"\n}\n')),(0,r.kt)("p",null,"It is important to note that the AccessToken obtained in this way differs from the first three in that it corresponds to the application rather than to the user."),(0,r.kt)("h3",{id:"refreshtoken"},"RefreshToken"),(0,r.kt)("p",null,"Maybe you want to update your accessToken, then you can use the ",(0,r.kt)("inlineCode",{parentName:"p"},"refreshToken")," you got above."),(0,r.kt)("p",null,"First you need to set the expiration time of refreshToken in the application (default is 0 hours), and send a POST request to ",(0,r.kt)("inlineCode",{parentName:"p"},"https://<CASDOOR_HOST>/api/login/oauth/refresh_token")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "grant_type": "refresh_token",\n    "refresh_token": REFRESH_TOKEN,\n    "scope": SCOPE,\n    "client_id": ClientId,\n    "client_secret": ClientSecret,\n}\n')),(0,r.kt)("p",null,"You will get the response like:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "access_token": "eyJhb...",\n    "id_token": "eyJhb...",\n    "refresh_token": "eyJhb...",\n    "token_type": "Bearer",\n    "expires_in": 10080,\n    "scope": "openid"\n}\n')),(0,r.kt)("h2",{id:"how-to-verify-accesstoken"},"How to verify AccessToken"),(0,r.kt)("p",null,"Casdoor currently has support for ",(0,r.kt)("a",{parentName:"p",href:"https://datatracker.ietf.org/doc/html/rfc7662"},"token introspection")," endpoint. Currently the endpoind is protected by Basic Authoritarian(ClientId:ClientSecret):"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"POST /api/login/oauth/introspect HTTP/1.1\nHost: CASDOOR_HOST\nAccept: application/json\nContent-Type: application/x-www-form-urlencoded\nAuthorization: Basic Y2xpZW50X2lkOmNsaWVudF9zZWNyZXQ=\n\ntoken=ACCESS_TOKEN&token_type_hint=access_token\n")),(0,r.kt)("p",null,"You will get the following response like:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "active": true,\n    "client_id": "c58c...",\n    "username": "admin",\n    "token_type": "Bearer",\n    "exp": 1647138242,\n    "iat": 1646533442,\n    "nbf": 1646533442,\n    "sub": "7a6b4a8a-b731-48da-bc44-36ae27338817",\n    "aud": [\n        "c58c..."\n    ],\n    "iss": "http://localhost:8000"\n}\n')),(0,r.kt)("h2",{id:"how-to-use-accesstoken"},"How to use ",(0,r.kt)("inlineCode",{parentName:"h2"},"AccessToken")),(0,r.kt)("p",null,"You can use AccessToken to access Casdoor APIs that require authentication, here is ",(0,r.kt)("inlineCode",{parentName:"p"},"/api/userinfo"),' for example. This one is when we only use "openid" scope to get userinfo endpoint.'),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Query parameter")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"https://<CASDOOR_HOST>/api/userinfo?accessToken=<your_access_token>")),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"HTTP Bearer token")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"https://<CASDOOR_HOST>/api/userinfo"),' with the header: "Authorization: Bearer <your_access_token>"'),(0,r.kt)("p",null,"You will get the same response like:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "sub": "7a6b4a8a-b731-48da-bc44-36ae27338817",\n    "iss": "http://localhost:8000",\n    "aud": "c58c..."\n}\n')),(0,r.kt)("p",null,'When we use "openid profile address phone email" as the scope, we can get more detailed response:'),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "sub": "2f80c349-4beb-407f-b1f0-528aac0f1acd",\n    "iss": "https://door.casbin.com",\n    "aud": "7a11****0fa2172",\n    "name": "admin",\n    "preferred_username": "Admin",\n    "email": "admin@example.com",\n    "picture": "https://casbin.org/img/casbin.svg",\n    "address": "Guangdong",\n    "phone": "12345678910"\n}\n')),(0,r.kt)("h2",{id:"differences-between-userinfo-and-get-account-apis"},"Differences between ",(0,r.kt)("inlineCode",{parentName:"h2"},"userinfo")," and ",(0,r.kt)("inlineCode",{parentName:"h2"},"get-account")," APIs"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"/api/userinfo"),": returns user information as part of OIDC protocol. Less information is returned, including only the basic information in OIDC standards. You can return more information on request by adding ",(0,r.kt)("inlineCode",{parentName:"li"},"scope"),". This step should be done before you get the ",(0,r.kt)("inlineCode",{parentName:"li"},"code"),",\ni.e. before redirecting to Casdoor for ",(0,r.kt)("a",{parentName:"li",href:"#1"},"Authorization Code Grant "))),(0,r.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},(0,r.kt)("strong",{parentName:"p"},"scope")),(0,r.kt)("p",{parentName:"div"},"The following is a non-normative example of an unencoded scope request:"),(0,r.kt)("p",{parentName:"div"},(0,r.kt)("inlineCode",{parentName:"p"},"scope=openid profile email phone")),(0,r.kt)("p",{parentName:"div"},"In addition to these OpenID-specific scopes, your scope argument can also include other scope values. All scope values must be space-separated."),(0,r.kt)("p",{parentName:"div"},"For more details, please see ",(0,r.kt)("a",{parentName:"p",href:"https://openid.net/specs/openid-connect-core-1_0.html#UserInfoResponse"},"OIDC standard")))),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"/api/get-account"),": gets the user object for the currently logged-in account. It is a Casdoor-only API to obtain all information of the ",(0,r.kt)("a",{parentName:"li",href:"/docs/basic/core-concepts#user"},"user")," in Casdoor.")))}u.isMDXComponent=!0},3905:function(e,t,n){"use strict";n.d(t,{Zo:function(){return p},kt:function(){return h}});var o=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},r=Object.keys(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var c=o.createContext({}),l=function(e){var t=o.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=l(e.components);return o.createElement(c.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return o.createElement(o.Fragment,{},t)}},u=o.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,c=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=l(n),h=a,k=u["".concat(c,".").concat(h)]||u[h]||d[h]||r;return n?o.createElement(k,i(i({ref:t},p),{},{components:n})):o.createElement(k,i({ref:t},p))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,i=new Array(r);i[0]=u;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"==typeof e?e:a,i[1]=s;for(var l=2;l<r;l++)i[l]=n[l];return o.createElement.apply(null,i)}return o.createElement.apply(null,n)}u.displayName="MDXCreateElement"},7337:function(e,t,n){"use strict";t.Z=n.p+"assets/images/accesstoken_grant_types-a3a06e2f0f56b34ddf752837c834771e.png"}}]);